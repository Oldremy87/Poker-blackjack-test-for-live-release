{"version":3,"file":"walletBet.bundle.js","sources":["../../src/walletBet.ts"],"sourcesContent":["// src/walletBet.ts\r\nimport { Buffer } from 'buffer';\r\nimport process from 'process';\r\nimport * as nodeCrypto from 'crypto-browserify';\r\nimport { rostrumProvider } from 'nexa-wallet-sdk';\r\n\r\n// Polyfills\r\n(globalThis as any).Buffer  ||= Buffer;\r\n(globalThis as any).process ||= process;\r\n(globalThis as any).__nodeCrypto = nodeCrypto;\r\n\r\nconst KEY='kk_wallet_v1', IV='kk_wallet_iv_v1';\r\nconst KIBL_GROUP_ADDR = 'nexa:tpjkhlhuazsgskkt5hyqn3d0e7l6vfvfg97cf42pprntks4x7vqqqcavzypmt';\r\nconst KIBL_TOKEN_HEX  = '656bfefce8a0885acba5c809c5afcfbfa62589417d84d54108e6bb42a6f30000';\r\nconst HOUSE_ADDRESS   = 'nexa:nqtsq5g5pvucuzm2kh92kqtxy5s3zfutq3xgnhh5src65fc3';\r\nconst KIBL_TOKEN_ID   = 'nexa:tpjkhlhuazsgskkt5hyqn3d0e7l6vfvfg97cf42pprntks4x7vqqqcavzypmt';\r\n\r\n// --- NODES ---\r\nconst PRIVATE_NODE = { scheme: 'wss' as const, host: 'node.remy-dev.com', port: 443 };\r\nconst PUBLIC_NODE  = { scheme: 'wss' as const, host: 'electrum.nexa.org', port: 20004 };\r\n\r\n// --- CACHE STATE ---\r\nlet cachedSession: {\r\n  wallet: any;\r\n  account: any;\r\n  address: any;\r\n  network: any;\r\n  balances: any;\r\n  sdk: any;\r\n  seed: any; \r\n  net: any;\r\n} | null = null;\r\n\r\n// Lock to prevent parallel reconnects (The Singleton Guard)\r\nlet reconnectLock: Promise<void> | null = null;\r\n\r\nasync function getSdk() { return await import('nexa-wallet-sdk'); }\r\nfunction getWalletCtor(mod: any) { return mod?.Wallet ?? mod?.default?.Wallet; }\r\n\r\n/**\r\n * HEALTH CHECK\r\n * Replaces the \"made up\" .isConnected check.\r\n * We try to fetch the block tip. If it works, the pipe is open.\r\n */\r\nasync function isConnectionHealthy(rostrumProvider: any) {\r\n  if (!rostrumProvider) return false;\r\n  try {\r\n    // \"Ping\" the server\r\n    await rostrumProvider.getBlockTip();\r\n    return true;\r\n  } catch (e) {\r\n    return false;\r\n  }\r\n}\r\n\r\n/**\r\n * CONNECT / RECONNECT ROUTINE\r\n * Tries Private Node -> Fails over to Public Node\r\n */\r\nasync function establishConnection(rostrumProvider: any) {\r\n  console.log('[Client] Connecting to network...');\r\n\r\n  // 1. Try Private Node\r\n  try {\r\n    // Per your RostrumProvider.ts, this replaces the internal client\r\n    await rostrumProvider.connect(PRIVATE_NODE);\r\n    \r\n    // Verify it actually works (Handshake isn't enough, we need data flow)\r\n    if (await isConnectionHealthy(rostrumProvider)) {\r\n        console.log('✅ Connected: Private Node');\r\n        return true;\r\n    }\r\n  } catch (e) {\r\n    console.warn('⚠️ Private node unreachable, trying public...');\r\n  }\r\n\r\n  // 2. Try Public Node (Failover)\r\n  try {\r\n    await rostrumProvider.connect(PUBLIC_NODE);\r\n    if (await isConnectionHealthy(rostrumProvider)) {\r\n        console.log('⚠️ Connected: Public Node');\r\n        return true;\r\n    }\r\n  } catch (e) {\r\n    console.error('❌ Connection failed:', e);\r\n  }\r\n  return false;\r\n}\r\n\r\nexport async function loadWallet(pass: string) {\r\n  // 1. Existing Session? Check health using PING.\r\n  if (cachedSession) {\r\n    // If a reconnect is already happening, wait for it\r\n    if (reconnectLock) { await reconnectLock; return cachedSession; }\r\n\r\n    const { wallet } = cachedSession;\r\n\r\n    // Fast Check: \"Are we still there?\"\r\n    // We use getBlockTip() instead of .isConnected\r\n    const healthy = await isConnectionHealthy(rostrumProvider);\r\n\r\n    if (healthy) {\r\n        return cachedSession; // FAST PATH (Instant)\r\n    }\r\n\r\n    // SLOW PATH (Repairing dropped connection)\r\n    console.log('[Client] Connection stale. Reconnecting...');\r\n    \r\n    reconnectLock = (async () => {\r\n        try {\r\n            const success = await establishConnection(rostrumProvider);\r\n            if (!success) throw new Error(\"Unable to reach network.\");\r\n            \r\n            // If we reconnected, we MUST resync the wallet \r\n            // because the old internal subscriptions were lost.\r\n            console.log('[Client] Resyncing wallet...');\r\n            await wallet.initialize();\r\n        } finally {\r\n            reconnectLock = null;\r\n        }\r\n    })();\r\n\r\n    await reconnectLock;\r\n    return cachedSession;\r\n  }\r\n\r\n  // 2. Initial Load (Decrypt from Storage)\r\n  const rawB64 = localStorage.getItem(KEY);\r\n  const ivB64  = localStorage.getItem(IV);\r\n  if (!rawB64 || !ivB64) throw new Error('No local wallet. Visit Connect.');\r\n\r\n  const raw = atob(rawB64);\r\n  const ivb = atob(ivB64);\r\n  const iv  = new Uint8Array([...ivb].map(c=>c.charCodeAt(0)));\r\n  const ct  = new Uint8Array([...raw].map(c=>c.charCodeAt(0)));\r\n\r\n  const h   = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(pass));\r\n  const key = await crypto.subtle.importKey('raw', h, 'AES-GCM', false, ['decrypt']);\r\n  const pt  = await crypto.subtle.decrypt({ name:'AES-GCM', iv }, key, ct);\r\n  \r\n  const { seed, net } = JSON.parse(new TextDecoder().decode(pt)); \r\n\r\n  const sdk = await getSdk();\r\n  const WalletCtor = getWalletCtor(sdk);\r\n  \r\n  const wallet = new WalletCtor(seed, net);\r\n  const provider = wallet.rostrumProvider || wallet.provider;\r\n  \r\n  // Initial Connect\r\n  const connected = await establishConnection(rostrumProvider);\r\n  if (!connected) throw new Error('Could not connect to network.');\r\n\r\n  console.log('[Client] Initializing Wallet (Scanning UTXOs)...');\r\n  await wallet.initialize(); \r\n\r\n  const account = wallet.accountStore.getAccount('2.0');\r\n  if (!account) throw new Error('Account 2.0 missing');\r\n  const address = account.getPrimaryAddressKey().address; \r\n\r\n  const nexaMinor = Number(account.balance?.confirmed || 0);\r\n  const kiblMinor = Number(account.tokenBalances?.[KIBL_GROUP_ADDR]?.confirmed || 0);\r\n  const DEC = 2;\r\n\r\n  // Save to Cache\r\n  cachedSession = { \r\n    wallet, account, address, network: net, sdk, seed, net,\r\n    balances: {\r\n        kiblMinor, kibl: (kiblMinor / 10 ** DEC),\r\n        nexaMinor, nexa: (nexaMinor / 10 ** DEC),\r\n        tokenHex: KIBL_TOKEN_HEX, tokenGroup: KIBL_GROUP_ADDR,\r\n    }\r\n  };\r\n  return cachedSession;\r\n}\r\n\r\nexport async function placeBet({ passphrase, kiblAmount, tokenIdHex, feeNexa }: any) {\r\n  if (!cachedSession && (!passphrase || passphrase.length < 8)) throw new Error('Password required.');\r\n  \r\n  // Auto-reconnects if needed\r\n  const { wallet, account } = await loadWallet(passphrase);\r\n  \r\n  console.log('[Client] Building...');\r\n\r\n  const signedTx = await wallet.newTransaction(account)\r\n    .onNetwork('mainnet')\r\n    .sendTo(HOUSE_ADDRESS, feeNexa.toString())\r\n    .sendToToken(HOUSE_ADDRESS, kiblAmount.toString(), KIBL_TOKEN_ID)\r\n    .populate()\r\n    .sign()\r\n    .build();\r\n  \r\n  const txId = await wallet.sendTransaction(signedTx);\r\n  console.log('[Client] Sent:', txId);\r\n\r\n  return { txId, house: HOUSE_ADDRESS };\r\n}"],"names":["Buffer","process","rostrumProvider","wallet"],"mappings":"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"}