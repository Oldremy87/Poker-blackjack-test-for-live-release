{"version":3,"file":"walletBet.bundle.js","sources":["../../src/walletBet.ts"],"sourcesContent":["// src/walletBet.ts\r\nimport { Buffer } from 'buffer';\r\nimport process from 'process';\r\nimport * as nodeCrypto from 'crypto-browserify';\r\nimport { rostrumProvider } from 'nexa-wallet-sdk';\r\n\r\n// Polyfills\r\n(globalThis as any).Buffer  ||= Buffer;\r\n(globalThis as any).process ||= process;\r\n(globalThis as any).__nodeCrypto = nodeCrypto;\r\n\r\nconst KEY='kk_wallet_v1', IV='kk_wallet_iv_v1';\r\nconst KIBL_GROUP_ADDR = 'nexa:tpjkhlhuazsgskkt5hyqn3d0e7l6vfvfg97cf42pprntks4x7vqqqcavzypmt';\r\nconst KIBL_TOKEN_HEX  = '656bfefce8a0885acba5c809c5afcfbfa62589417d84d54108e6bb42a6f30000';\r\nconst HOUSE_ADDRESS   = 'nexa:nq4sq9ppgl78nmmzqn35fxlh8arwj7sexuvuplq5kf4g46zcr0956u8my6vfnleqkhtxfpk9kp2k4esf';\r\nconst KIBL_TOKEN_ID   = 'nexa:tpjkhlhuazsgskkt5hyqn3d0e7l6vfvfg97cf42pprntks4x7vqqqcavzypmt';\r\n\r\n// --- NODES ---\r\nconst PRIVATE_NODE = { scheme: 'wss' as const, host: 'node.remy-dev.com', port: 443 };\r\nconst PUBLIC_NODE  = { scheme: 'wss' as const, host: 'electrum.nexa.org', port: 20004 };\r\n\r\n// --- GLOBAL STATE ---\r\n// We attach these to globalThis to prevent double-init if the module is loaded twice\r\nconst GLOBALS = globalThis as any;\r\n\r\n// Initialize globals if they don't exist\r\nGLOBALS.__WALLET_SESSION = GLOBALS.__WALLET_SESSION || null;\r\nGLOBALS.__WALLET_LOADING = GLOBALS.__WALLET_LOADING || null;\r\nGLOBALS.__WALLET_RECONNECT = GLOBALS.__WALLET_RECONNECT || null;\r\n\r\nasync function getSdk() { return await import('nexa-wallet-sdk'); }\r\nfunction getWalletCtor(mod: any) { return mod?.Wallet ?? mod?.default?.Wallet; }\r\n\r\nasync function isConnectionHealthy(rostrumProvider: any) {\r\n  if (!rostrumProvider) return false;\r\n  try {\r\n    await rostrumProvider.getBlockTip();\r\n    return true;\r\n  } catch (e) {\r\n    return false;\r\n  }\r\n}\r\n\r\nasync function establishConnection(rostrumProvider: any) {\r\n  console.log('[Client] Connecting to network...');\r\n\r\n  // 1. Try Private Node\r\n  /*\r\n  try {\r\n    await rostrumProvider.connect(PRIVATE_NODE);\r\n    if (await isConnectionHealthy(rostrumProvider)) {\r\n        console.log('âœ… Connected: Private Node');\r\n        return true;\r\n    }\r\n  } catch (e) {\r\n    console.warn('âš ï¸ Private node unreachable, trying public...');\r\n  }\r\n  */\r\n\r\n  // 2. Try Public Node (Failover)\r\n  try {\r\n    await rostrumProvider.connect(PUBLIC_NODE);\r\n    if (await isConnectionHealthy(rostrumProvider)) {\r\n        console.log('âš ï¸ Connected: Public Node');\r\n        return true;\r\n    }\r\n  } catch (e) {\r\n    console.error('âŒ Connection failed:', e);\r\n  }\r\n  return false;\r\n}\r\n\r\nexport async function loadWallet(pass: string) {\r\n  // --- FIX START: Global Singleton Guard ---\r\n  // Check the global lock instead of a local variable\r\n  if (GLOBALS.__WALLET_LOADING) {\r\n    // console.log('[Client] Waiting for existing wallet load...'); // Optional debug\r\n    return await GLOBALS.__WALLET_LOADING;\r\n  }\r\n  // --- FIX END ---\r\n\r\n  if (GLOBALS.__WALLET_SESSION) {\r\n    if (GLOBALS.__WALLET_RECONNECT) { \r\n        await GLOBALS.__WALLET_RECONNECT; \r\n        return GLOBALS.__WALLET_SESSION; \r\n    }\r\n\r\n    const { wallet } = GLOBALS.__WALLET_SESSION;\r\n    const healthy = await isConnectionHealthy(rostrumProvider);\r\n\r\n    if (healthy) {\r\n        return GLOBALS.__WALLET_SESSION; \r\n    }\r\n    console.log('[Client] Connection stale. Reconnecting...');\r\n    \r\n    GLOBALS.__WALLET_RECONNECT = (async () => {\r\n        try {\r\n            const success = await establishConnection(rostrumProvider);\r\n            if (!success) throw new Error(\"Unable to reach network.\");\r\n            console.log('[Client] Resyncing wallet...');\r\n            await wallet.initialize();\r\n        } finally {\r\n            GLOBALS.__WALLET_RECONNECT = null;\r\n        }\r\n    })();\r\n\r\n    await GLOBALS.__WALLET_RECONNECT;\r\n    return GLOBALS.__WALLET_SESSION;\r\n  }\r\n\r\n  // 2. Initial Load (Decrypt from Storage)\r\n  GLOBALS.__WALLET_LOADING = (async () => {\r\n    try {\r\n        const rawB64 = localStorage.getItem(KEY);\r\n        const ivB64  = localStorage.getItem(IV);\r\n        if (!rawB64 || !ivB64) throw new Error('No local wallet. Visit Connect.');\r\n\r\n        const raw = atob(rawB64);\r\n        const ivb = atob(ivB64);\r\n        const iv  = new Uint8Array([...ivb].map(c=>c.charCodeAt(0)));\r\n        const ct  = new Uint8Array([...raw].map(c=>c.charCodeAt(0)));\r\n\r\n        const h   = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(pass));\r\n        const key = await crypto.subtle.importKey('raw', h, 'AES-GCM', false, ['decrypt']);\r\n        const pt  = await crypto.subtle.decrypt({ name:'AES-GCM', iv }, key, ct);\r\n        \r\n        const { seed, net } = JSON.parse(new TextDecoder().decode(pt)); \r\n\r\n        const sdk = await getSdk();\r\n        const WalletCtor = getWalletCtor(sdk);\r\n        \r\n        const wallet = new WalletCtor(seed, net);\r\n        \r\n        // Initial Connect\r\n        const connected = await establishConnection(rostrumProvider);\r\n        if (!connected) throw new Error('Could not connect to network.');\r\n\r\n        console.log('[Client] Initializing Wallet (Scanning UTXOs)...');\r\n        await wallet.initialize(); \r\n\r\n        const account = wallet.accountStore.getAccount('2.0');\r\n        if (!account) throw new Error('Account 2.0 missing');\r\n        const address = account.getPrimaryAddressKey().address; \r\n\r\n        const nexaMinor = Number(account.balance?.confirmed || 0);\r\n        const kiblMinor = Number(account.tokenBalances?.[KIBL_GROUP_ADDR]?.confirmed || 0);\r\n\r\n        // Save to GLOBAL Cache\r\n        GLOBALS.__WALLET_SESSION = { \r\n            wallet, account, address, network: net, sdk, seed, net,\r\n            balances: {\r\n                kiblMinor, kibl: (kiblMinor / 100),\r\n                nexaMinor, nexa: (nexaMinor / 100),\r\n                tokenHex: KIBL_TOKEN_HEX, tokenGroup: KIBL_GROUP_ADDR,\r\n            }\r\n        };\r\n        return GLOBALS.__WALLET_SESSION;\r\n    } finally {\r\n        // Clear global lock\r\n        GLOBALS.__WALLET_LOADING = null;\r\n    }\r\n  })();\r\n\r\n  return await GLOBALS.__WALLET_LOADING;\r\n}\r\n\r\nasync function _buildAndSend({ passphrase, kiblAmount, tokenIdHex, feeNexa }: any) {\r\n  // Use global session check\r\n  if (!GLOBALS.__WALLET_SESSION && (!passphrase || passphrase.length < 8)) throw new Error('Password required.');\r\n  \r\n  const { wallet, account } = await loadWallet(passphrase);\r\n  \r\n  console.log('[Client] Building...');\r\n\r\n  const signedTx = await wallet.newTransaction(account)\r\n    .onNetwork('mainnet')\r\n    .sendToToken(HOUSE_ADDRESS, kiblAmount.toString(), KIBL_TOKEN_ID)\r\n    .populate()\r\n    .sign()\r\n    .build();\r\n\r\n  console.log('---------------------------------------------------');\r\n  console.log('[Client] ðŸ” DEBUG: Signed Transaction Hex:');\r\n  console.log(signedTx);\r\n  console.log('---------------------------------------------------');\r\n  \r\n  const txId = await wallet.sendTransaction(signedTx);\r\n  console.log('[Client] Sent:', txId);\r\n\r\n  return { txId, house: HOUSE_ADDRESS };\r\n}\r\n\r\nexport async function placeBet(params: any) {\r\n  try {\r\n    return await _buildAndSend(params);\r\n  } catch (e: any) {\r\n    const msg = e.message || String(e);\r\n    \r\n    if (msg.includes('Missing inputs') || msg.includes('-32602') || msg.includes('-32000')) {\r\n        console.warn('âš ï¸ [Client] State Drift detected (Missing inputs). Force-resyncing...');\r\n        // Clear global session to force reload\r\n        GLOBALS.__WALLET_SESSION = null; \r\n        await loadWallet(params.passphrase);\r\n        \r\n        console.log('ðŸ”„ [Client] Resync complete. Retrying bet...');\r\n        return await _buildAndSend(params);\r\n    }\r\n    \r\n    throw e;\r\n  }\r\n}\r\n\r\nexport async function recoverSeed(pass: string) {\r\n  const rawB64 = localStorage.getItem(KEY);\r\n  const ivB64  = localStorage.getItem(IV);\r\n  \r\n  if (!rawB64 || !ivB64) throw new Error('No wallet found to back up.');\r\n\r\n  const raw = atob(rawB64);\r\n  const ivb = atob(ivB64);\r\n  const iv  = new Uint8Array([...ivb].map(c=>c.charCodeAt(0)));\r\n  const ct  = new Uint8Array([...raw].map(c=>c.charCodeAt(0)));\r\n\r\n  const h   = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(pass));\r\n  const key = await crypto.subtle.importKey('raw', h, 'AES-GCM', false, ['decrypt']);\r\n  \r\n  try {\r\n    const pt  = await crypto.subtle.decrypt({ name:'AES-GCM', iv }, key, ct);\r\n    const { seed } = JSON.parse(new TextDecoder().decode(pt));\r\n    return seed; \r\n  } catch (e) {\r\n    throw new Error('Incorrect password.');\r\n  }\r\n}\r\n\r\nexport async function sendFunds({ passphrase, toAddress, amountNexa, amountKibl }: any) {\r\n  const { wallet, account } = await loadWallet(passphrase);\r\n  \r\n  let tx = wallet.newTransaction(account)\r\n  .onNetwork('mainnet')\r\n  .sendTo(toAddress, amountNexa.toString())\r\n  .sendToToken(toAddress, amountKibl.toString(), KIBL_TOKEN_ID);\r\n  const signed = await tx.populate().sign().build();\r\n  \r\n  const txId = await wallet.sendTransaction(signed);\r\n  return txId;\r\n}"],"names":["Buffer","process","rostrumProvider"],"mappings":"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"}