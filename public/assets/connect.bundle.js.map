{"version":3,"file":"connect.bundle.js","sources":["../../src/connect.ts"],"sourcesContent":["import { Buffer } from 'buffer';\r\nimport process from 'process';\r\nimport * as nodeCrypto from 'crypto-browserify';\r\n\r\n(globalThis as any).Buffer = Buffer;\r\n(globalThis as any).process = process;\r\n(globalThis as any).__nodeCrypto = nodeCrypto;\r\n\r\nconst KEY = 'kk_wallet_v1';\r\nconst IV = 'kk_wallet_iv_v1';\r\n\r\nasync function sdk() {\r\n  return await import('nexa-wallet-sdk');\r\n}\r\nconst MAINNET = {\r\n  scheme: 'wss' as const,\r\n  host: 'electrum.nexa.org',\r\n  port: 20004,\r\n};\r\nasync function connectMainnet(rostrumProvider: any) {\r\n  // reuse a global flag to avoid duplicate connects across hot reloads\r\n  if ((globalThis as any).__kk_rostrum_mainnet_ok) return;\r\n  await rostrumProvider.connect(MAINNET); // explicit mainnet endpoint\r\n  (globalThis as any).__kk_rostrum_mainnet_ok = true;\r\n}\r\nasync function ensureCsrf() {\r\n  if ((window as any).csrfToken) return (window as any).csrfToken;\r\n  const r = await fetch('/api/csrf', { credentials: 'include' });\r\n  if (!r.ok) throw new Error(`CSRF fetch failed: ${r.status}`);\r\n  const { csrfToken } = await r.json();\r\n  (window as any).csrfToken = csrfToken;\r\n  return csrfToken;\r\n}\r\n\r\nasync function postJSON(url: string, body: any) {\r\n  const csrf = await ensureCsrf();\r\n  const r = await fetch(url, {\r\n    method: 'POST',\r\n    credentials: 'include',\r\n    headers: { 'Content-Type': 'application/json', 'CSRF-Token': csrf },\r\n    body: JSON.stringify(body),\r\n  });\r\n  let j: any = null;\r\n  try { j = await r.json(); } catch { }\r\n  if (!r.ok || (j && j.ok === false)) {\r\n    throw new Error(j?.error || `HTTP ${r.status}`);\r\n  }\r\n  return j;\r\n}\r\n\r\nfunction normalizeSeed(raw: string) {\r\n  return (raw || '').toLowerCase().replace(/[^a-z\\s]/g, ' ').split(/\\s+/).filter(Boolean).join(' ');\r\n}\r\n\r\nfunction require12Words(seed: string) {\r\n  const words = seed.split(' ');\r\n  if (words.length !== 12) throw new Error(`Seed must be 12 words (got ${words.length}).`);\r\n  return seed;\r\n}\r\n\r\nasync function aesKey(pass: string) {\r\n  const raw = new TextEncoder().encode(pass);\r\n  const h = await crypto.subtle.digest('SHA-256', raw);\r\n  return crypto.subtle.importKey('raw', h, 'AES-GCM', false, ['encrypt', 'decrypt']);\r\n}\r\n\r\nasync function enc(pass: string, data: string) {\r\n  if (!pass || pass.length < 8) throw new Error('Password must be 8+ chars.');\r\n  const key = await aesKey(pass);\r\n  const iv = crypto.getRandomValues(new Uint8Array(12));\r\n  const ct = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, new TextEncoder().encode(data));\r\n  localStorage.setItem(IV, btoa(String.fromCharCode(...iv)));\r\n  localStorage.setItem(KEY, btoa(String.fromCharCode(...new Uint8Array(ct))));\r\n  // This flag tells the UI that a wallet exists\r\n  localStorage.setItem('kk_has_pass', '1');\r\n}\r\n\r\nasync function dec(pass: string) {\r\n  const key = await aesKey(pass);\r\n  const ivb = atob(localStorage.getItem(IV) || '');\r\n  const iv = new Uint8Array([...ivb].map(c => c.charCodeAt(0)));\r\n  const ctb = atob(localStorage.getItem(KEY) || '');\r\n  const ct = new Uint8Array([...ctb].map(c => c.charCodeAt(0)));\r\n  const pt = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, ct);\r\n  return new TextDecoder().decode(pt);\r\n}\r\n\r\nasync function init() {\r\n  const netSel = document.getElementById('net') as HTMLSelectElement;\r\n  const passEl = document.getElementById('pass') as HTMLInputElement;\r\n  const pass2El = document.getElementById('pass2') as HTMLInputElement;\r\n  const btnCreate = document.getElementById('btnCreate') as HTMLButtonElement;\r\n  const btnImport = document.getElementById('btnImport') as HTMLButtonElement;\r\n  const importArea = document.getElementById('importArea') as HTMLElement;\r\n  const seedIn = document.getElementById('seedIn') as HTMLTextAreaElement;\r\n  const btnDoImport = document.getElementById('btnDoImport') as HTMLButtonElement;\r\n  const linked = document.getElementById('linked') as HTMLElement;\r\n  const addrText = document.getElementById('addr') as HTMLElement;\r\n  const btnLink = document.getElementById('btnLink') as HTMLButtonElement;\r\n  const passHint = document.getElementById('passHint') as HTMLElement;\r\n  const kiblBalanceEl = document.getElementById('kiblBalance') as HTMLElement;\r\n\r\n  let address: string | null = null;\r\n\r\n  function passOk() {\r\n    const p1 = passEl.value;\r\n    const p2 = pass2El.value;\r\n    const ok = p1.length >= 8 && p1 === p2;\r\n    btnCreate.disabled = !ok;\r\n    btnImport.disabled = !ok;\r\n    passHint.hidden = ok;\r\n  }\r\n\r\n  passEl.addEventListener('input', passOk);\r\n  pass2El.addEventListener('input', passOk);\r\n\r\n  async function bootFromSeed(seed: string, net: 'mainnet') {\r\n    const { Wallet, rostrumProvider } = await sdk();\r\n\r\n  await connectMainnet(rostrumProvider);\r\n    const wallet = new Wallet(seed, net);\r\n    await wallet.initialize();\r\n    \r\n    const account = wallet.accountStore.getAccount('2.0');\r\n    const k = account.getPrimaryAddressKey();\r\n    \r\n    // Get Balance\r\n    const tokenId = process.env.KIBL_TOKEN_ID_HEX || '656bfefce8a0885acba5c809c5afcfbfa62589417d84d54108e6bb42a6f30000';\r\n    const kiblBal = account.tokenBalances[tokenId]?.confirmed || 0;\r\n    \r\n    if (kiblBalanceEl) kiblBalanceEl.textContent = `Balance: ${(Number(kiblBal)/100).toFixed(2)} KIBL`;\r\n\r\n    return { address: k.address };\r\n  }\r\n\r\nbtnCreate.addEventListener('click', async () => {\r\n    try {\r\n      const pass = passEl.value;\r\n      const net = 'mainnet';\r\n      const { Wallet } = await sdk();\r\n      const w = Wallet.create();\r\n      const seed = w.export().phrase;\r\n      \r\n      // Save to LocalStorage\r\n      await enc(pass, JSON.stringify({ seed, net }));\r\n      \r\n      const r = await bootFromSeed(seed, net);\r\n      address = r.address;\r\n      addrText.textContent = `Address: ${address}`;\r\n      linked.hidden = false;\r\n      \r\n      // --- FIX: Show the Seed Phrase ---\r\n      importArea.hidden = false; // Reveal the text area\r\n      seedIn.value = seed;       // Fill it with the new seed\r\n      // Visual cue to user\r\n      alert('Wallet Created! \\n\\nIMPORTANT: Your seed phrase is shown in the box below. Write it down now. It will disappear when you leave this page.');\r\n      \r\n    } catch (e: any) {\r\n      alert(e.message || 'Create failed');\r\n    }\r\n  });\r\n\r\n  btnImport.addEventListener('click', () => {\r\n    importArea.hidden = !importArea.hidden;\r\n  });\r\n\r\n  btnDoImport.addEventListener('click', async () => {\r\n    try {\r\n      const pass = passEl.value;\r\n      const net = 'mainnet';\r\n      const seed = require12Words(normalizeSeed(seedIn.value));\r\n      \r\n      await enc(pass, JSON.stringify({ seed, net }));\r\n      \r\n      const r = await bootFromSeed(seed, net);\r\n      address = r.address;\r\n      addrText.textContent = `Address: ${address}`;\r\n      linked.hidden = false;\r\n      alert('Wallet Imported & Encrypted!');\r\n    } catch (e: any) {\r\n      alert(e.message || 'Import failed');\r\n    }\r\n  });\r\n\r\n  btnLink.addEventListener('click', async () => {\r\n    try {\r\n      if (!address) return alert('No address loaded.');\r\n      await postJSON('/api/wallet/link', { address, network: 'mainnet' });\r\n      alert('Wallet Linked Successfully!');\r\n      window.location.href = '/play.html';\r\n    } catch (e: any) {\r\n      alert('Link failed: ' + e.message);\r\n    }\r\n  });\r\n\r\n  // Auto-unlock check\r\n  if (localStorage.getItem(KEY)) {\r\n      passEl.placeholder = \"Enter password to unlock existing wallet\";\r\n      // We can't auto-unlock without the user typing the password first\r\n  }\r\n  \r\n  ensureCsrf();\r\n}\r\n\r\naddEventListener('DOMContentLoaded', init);"],"names":["Buffer","process"],"mappings":"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"}