{"version":3,"file":"connect.bundle.js","sources":["../../src/connect.ts"],"sourcesContent":["// src/connect.ts\r\nimport { Buffer } from 'buffer';\r\nimport process from 'process';\r\n(globalThis as any).Buffer  ||= Buffer;\r\n(globalThis as any).process ||= process;\r\n\r\nimport { Wallet, rostrumProvider } from 'nexa-wallet-sdk';\r\n\r\nconst KEY = 'kk_wallet_v1';\r\nconst IV  = 'kk_wallet_iv_v1';\r\n\r\nfunction normalizeSeed(raw: string): string {\r\n  // lowercase, strip non-letters, collapse whitespace\r\n  return (raw || '')\r\n    .toLowerCase()\r\n    .replace(/[^a-z\\s]/g, ' ')\r\n    .split(/\\s+/)\r\n    .filter(Boolean)\r\n    .join(' ');\r\n}\r\n\r\nfunction require12Words(seed: string): string {\r\n  const words = seed.split(' ');\r\n  if (words.length !== 12) {\r\n    throw new Error(`Seed must be exactly 12 words (got ${words.length}).`);\r\n  }\r\n  return seed;\r\n}\r\n\r\nasync function aesKey(pass: string) {\r\n  const raw = new TextEncoder().encode(pass);\r\n  const h   = await crypto.subtle.digest('SHA-256', raw);\r\n  return crypto.subtle.importKey('raw', h, 'AES-GCM', false, ['encrypt','decrypt']);\r\n}\r\nasync function enc(pass: string, data: string) {\r\n  const key = await aesKey(pass);\r\n  const iv  = crypto.getRandomValues(new Uint8Array(12));\r\n  const ct  = await crypto.subtle.encrypt({ name:'AES-GCM', iv }, key, new TextEncoder().encode(data));\r\n  localStorage.setItem(IV,  btoa(String.fromCharCode(...iv)));\r\n  localStorage.setItem(KEY, btoa(String.fromCharCode(...new Uint8Array(ct))));\r\n}\r\nasync function dec(pass: string) {\r\n  const key = await aesKey(pass);\r\n  const ivb = atob(localStorage.getItem(IV) || '');\r\n  const iv  = new Uint8Array([...ivb].map(c=>c.charCodeAt(0)));\r\n  const ctb = atob(localStorage.getItem(KEY) || '');\r\n  const ct  = new Uint8Array([...ctb].map(c=>c.charCodeAt(0)));\r\n  const pt  = await crypto.subtle.decrypt({ name:'AES-GCM', iv }, key, ct);\r\n  return new TextDecoder().decode(pt);\r\n}\r\n\r\nasync function init() {\r\n  const netSel     = document.getElementById('net')        as HTMLSelectElement;\r\n  const passEl     = document.getElementById('pass')       as HTMLInputElement;\r\n  const btnCreate  = document.getElementById('btnCreate')  as HTMLButtonElement;\r\n  const btnImport  = document.getElementById('btnImport')  as HTMLButtonElement;\r\n  const importArea = document.getElementById('importArea') as HTMLElement;\r\n  const seedIn     = document.getElementById('seedIn')     as HTMLTextAreaElement;\r\n  const btnDoImport= document.getElementById('btnDoImport')as HTMLButtonElement;\r\n  const linked     = document.getElementById('linked')     as HTMLElement;\r\n  const addrText   = document.getElementById('addr')       as HTMLElement;\r\n  const btnLink    = document.getElementById('btnLink')    as HTMLButtonElement;\r\n\r\n  let wallet: any = null;\r\n  let account: any = null;\r\n  let address: string | null = null;\r\n\r\n  async function connectNetwork() {\r\n    const net = netSel.value === 'mainnet' ? 'mainnet' : 'testnet';\r\n    await rostrumProvider.connect(net);\r\n  }\r\n\r\n  async function bootFromSeed(seed: string, net: string) {\r\n    await connectNetwork();\r\n    wallet = new Wallet(seed, net);\r\n    await wallet.initialize();\r\n    account = wallet.accountStore.getAccount('2.0');\r\n    const k = account.getPrimaryAddressKey();\r\n    address = k.address;\r\n    addrText.textContent = `Linked address (${net}): ${address}`;\r\n    linked.hidden = false;\r\n  }\r\n\r\n  btnCreate?.addEventListener('click', async () => {\r\n    const pass = passEl.value || '';\r\n    const net  = netSel.value;\r\n    const w = Wallet.create();\r\n    const seed = w.export().phrase;\r\n    await enc(pass, JSON.stringify({ seed, net }));\r\n    await bootFromSeed(seed, net);\r\n    alert('New wallet created. Write down your seed!');\r\n  });\r\n\r\n btnDoImport?.addEventListener('click', async () => {\r\n  try {\r\n    const pass = passEl.value || '';\r\n    const net  = netSel.value;\r\n    const seed = require12Words(normalizeSeed(seedIn.value));\r\n\r\n    await enc(pass, JSON.stringify({ seed, net }));\r\n    await bootFromSeed(seed, net);\r\n    alert('Imported wallet. Seed stored encrypted locally.');\r\n  } catch (e: any) {\r\n    alert(e?.message || 'Failed to import seed. Please check the 12 words and try again.');\r\n  }\r\n});\r\n\r\n\r\n  btnLink?.addEventListener('click', async () => {\r\n    const res = await fetch('/api/wallet/link', {\r\n      method:'POST',\r\n      headers: { 'Content-Type':'application/json', 'CSRF-Token': (window as any).csrfToken || '' },\r\n      body: JSON.stringify({ address, network: netSel.value })\r\n    });\r\n    const j = await res.json();\r\n    if (!j.ok) return alert('Link failed: ' + (j.error || 'unknown'));\r\n    alert('Wallet linked!');\r\n    location.href = '/play.html';\r\n  });\r\n\r\n  passEl?.addEventListener('change', async () => {\r\n    try {\r\n      if (!localStorage.getItem(KEY)) return;\r\n      const { seed, net } = JSON.parse(await dec(passEl.value || ''));\r\n      netSel.value = net;\r\n      await bootFromSeed(seed, net);\r\n    } catch {}\r\n  });\r\n}\r\naddEventListener('DOMContentLoaded', init);"],"names":["Buffer","rostrumProvider","Wallet"],"mappings":"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"}