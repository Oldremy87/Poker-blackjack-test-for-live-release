<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>PixelPup Dice</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
  :root{
      --ui-scale: 1;
       --hand-gap: 10px;
        --card-ratio: 1.6;   /* height = width * ratio; tweak if your art needs */
      --cardW: 100px;    
      --bg: #0b0f19;
      --panel: #111827;
      --text: #00ffc6;
      --text-dim: #7fffe6;
      --accent: #ffcc00;
      --accent-2: #ff3df7;
      --accent-3: #6ae3ff;
      --card-bg: #222638;
      --card-border: #3af5d9;
      --danger: #ff5577;
      --ok: #45ff99;
       --win-cyan:  #3af5d9;
  --win-pink:  #ff3df7;
  --win-gold:  #ffcc00;
    --pp-bg: #050015;
      --pp-card: #120826;
      --pp-accent1: #00ffc6;
      --pp-accent2: #ff3df7;
      --pp-text: #fdfdfd;
      --pp-muted: #9ca3af;
      
    }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--pp-text);
      background:
        radial-gradient(circle at top left, rgba(0,255,198,0.2), transparent 60%),
        radial-gradient(circle at bottom right, rgba(255,61,247,0.2), transparent 60%),
        var(--pp-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    header.header-bar{
      display:flex; align-items:center; justify-content:space-between; gap:16px; 
      margin:0 auto 24px; max-width:1100px; padding-bottom: 12px;
      border-bottom: 1px solid rgba(58,245,217,0.1);
    }
    .brand{display:flex; align-items:center; gap:12px;}
    .brand h1 { margin: 0; font-size: 1.4rem; letter-spacing: 0.5px; text-shadow:0 0 12px rgba(0,255,198,0.4); }
    .brand-badge{
      width:40px;height:40px;border-radius:10px;border:2px solid var(--card-border);
      box-shadow:0 0 14px rgba(0,255,198,.2); display:grid; place-items:center;
      background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02)); 
      font-weight:800; color:var(--accent); font-size: 1.1rem;
    }
    .frame {
      max-width: 960px;
      width: 100%;
      background: radial-gradient(circle at top, rgba(255,255,255,0.06), transparent 60%), var(--pp-card);
      border-radius: 24px;
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow:
        0 18px 40px rgba(0,0,0,0.6),
        0 0 0 1px rgba(0,0,0,0.7);
      padding: 24px;
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.3fr);
      gap: 24px;
    }
    @media (max-width: 768px) {
      .frame { grid-template-columns: minmax(0, 1fr); }
    }
    .title {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 4px;
    }
    .title h1 {
      margin: 0;
      font-size: 1.4rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--pp-accent1);
    }
    .badge {
      font-size: .75rem;
      text-transform: uppercase;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.2);
      color: var(--pp-accent2);
      background: rgba(0,0,0,0.4);
    }
    .subtitle {
      margin: 0;
      font-size: 0.9rem;
      color: var(--pp-muted);
    }
    .dice-main {
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.08);
      padding: 18px;
      background: radial-gradient(circle at top left, rgba(0,255,198,0.09), transparent 55%);
    }
    .tier-list {
      display: grid;
      gap: 8px;
      margin: 16px 0;
    }
    .tier {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(0,0,0,0.4);
      border: 1px solid rgba(255,255,255,0.1);
      cursor: pointer;
      transition: transform 120ms ease, box-shadow 120ms ease, border-color 120ms ease, background 120ms ease;
    }
    .tier:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.6);
      border-color: var(--pp-accent1);
    }
    .tier.selected {
      border-color: var(--pp-accent2);
      box-shadow: 0 0 0 1px rgba(255,61,247,0.6);
      background: linear-gradient(135deg, rgba(0,255,198,0.16), rgba(255,61,247,0.12));
    }
    .tier-main {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .tier-emoji {
      font-size: 1.5rem;
    }
    .tier-name {
      font-size: 0.9rem;
      font-weight: 600;
    }
    .tier-desc {
      font-size: 0.8rem;
      color: var(--pp-muted);
    }
    .tier-meta {
      text-align: right;
      font-size: 0.8rem;
    }
    .tier-meta strong {
      color: var(--pp-accent1);
    }
    .result {
      margin-top: 10px;
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.9rem;
    }
    .result span.roll {
      font-size: 1.6rem;
      font-weight: 700;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.1);
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: .08em;
    }
    .pill.win {
      border-color: var(--pp-accent1);
      color: var(--pp-accent1);
    }
    .pill.lose {
      border-color: #f97373;
      color: #fecaca;
    }
    .controls {
      margin-top: 14px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    button {
      border-radius: 999px;
      border: none;
      padding: 8px 16px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: linear-gradient(135deg, var(--pp-accent1), var(--pp-accent2));
      color: #020617;
      box-shadow: 0 10px 25px rgba(0,0,0,0.6);
      transition: transform 80ms ease, box-shadow 80ms ease, opacity 80ms ease;
    }
    button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 12px 26px rgba(0,0,0,0.7);
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
    }
    .btn-secondary {
      background: transparent;
      color: var(--pp-muted);
      border: 1px solid rgba(148,163,184,0.6);
      box-shadow: none;
    }
    .side {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      gap: 18px;
    }
    .fx-confetti{ position:fixed; inset:0; pointer-events:none; z-index:9999; overflow:hidden; }
.fx-confetti i{
  position:absolute; top:-12px; left: var(--x,50%);
  width:8px; height:14px; border-radius:2px;
  background: linear-gradient(var(--rot,0deg),
              var(--win-pink), var(--win-gold), var(--win-cyan));
  opacity:.95;
  transform: rotate(var(--rot,0deg));
  animation: arcade-confetti var(--dur,1200ms) ease-out forwards;
}
@keyframes arcade-confetti{
  0%   { transform: translateY(-10px) rotate(var(--rot,0deg)); }
  100% { transform: translateY(calc(100vh + 12px)) rotate(calc(var(--rot,0deg) + 260deg)); opacity:0; }
}
#payoutTotal{ position: relative; display:inline-block; border-radius:12px; padding:2px 6px; }

/* One-shot bling class we add/remove from JS */
.payout-win{
  /* quick pop + glow + sheen */
  animation:
    arcade-pop .18s ease-out,
    arcade-glow 1.2s ease-out;
  filter: saturate(1.2);
}

/* Neon aura behind the text */
.payout-win::before{
  content:"";
  position:absolute; inset:-8px;
  border-radius:14px;
  background: conic-gradient(from 0deg,
    var(--win-pink), var(--win-gold), var(--win-cyan), var(--win-pink));
  filter: blur(14px) opacity(.55);
  z-index:-1;
  animation: arcade-spin 1.1s ease-out both;
}

/* Shiny sweep across the text */
.payout-win::after{
  content:"";
  position:absolute; inset:-2px;
  border-radius:12px;
  background:
    linear-gradient(120deg,
      rgba(255,255,255,0) 0%,
      rgba(255,255,255,.25) 15%,
      rgba(255,255,255,0) 32%);
  transform: translateX(-140%);
  animation: arcade-sheen .9s ease-out .06s forwards;
  pointer-events:none;
}

@keyframes arcade-pop{
  0% { transform: scale(1); }
  70%{ transform: scale(1.08); }
  100%{ transform: scale(1); }
}
@keyframes arcade-glow{
  0%   { box-shadow: 0 0 0 rgba(0,0,0,0); }
  45%  { box-shadow: 0 0 18px rgba(255,61,247,.25), 0 0 32px rgba(58,245,217,.18) inset; }
  100% { box-shadow: 0 0 0 rgba(0,0,0,0); }
}
@keyframes arcade-spin{
  from { transform: rotate(0deg) scale(1.02); }
  to   { transform: rotate(120deg) scale(1); }
}
@keyframes arcade-sheen{
  to { transform: translateX(140%); }
}
    .panel {
      padding: 14px;
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,0.4);
      background: rgba(15,23,42,0.8);
    }
    .panel h2 {
      margin: 0 0 8px;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: var(--pp-accent1);
    }
    .stat-row {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      margin-bottom: 4px;
      color: var(--pp-muted);
    }
    .stat-row strong {
      color: var(--pp-text);
    }
    .bank {
      font-family: "JetBrains Mono", ui-monospace, monospace;
      font-size: 0.9rem;
    }
    .hint {
      font-size: 0.8rem;
      color: var(--pp-muted);
      margin-top: 6px;
    }
    .claim-block { margin-top: 12px; }
#leaderboardList{ list-style:none; padding:0; margin:0; }
#leaderboardList li{ display:flex; align-items:center; gap:.75rem; padding:.25rem 0; }
#leaderboardList .who{ min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
#leaderboardList .pts{ margin-left:auto; }
#leaderboardList li.you{ font-weight:700; }
.hud {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 12px;
}
.panel-table { grid-column: 1 / 2; }
.panel-claim { grid-column: 2 / 3; }

@media (max-width: 1024px) {
  .hud { grid-template-columns: 1fr; }
  .panel-table, .panel-claim { grid-column: 1 / -1; }  /* <‚Äî ensures stacking */
}
.hidden { display: none !important; }
@property --spin { syntax: "<angle>"; inherits: false; initial-value: 0deg; }

/* Base look for the payout chip */
#payoutTotal{
  display: inline-block;
  padding: 6px 10px;
  border-radius: 12px;
  position: relative;
  background: #0f1425;
  border: 1px solid rgba(58,245,217,.35);
  transition: transform .15s ease, box-shadow .15s ease, filter .15s ease;
}

/* Win pulse: rainbow border + neon glow + bounce */
#payoutTotal.payout-pulse{
  border: 2px solid transparent;
  background:
    linear-gradient(#0f1425, #0f1425) padding-box,
    conic-gradient(from var(--spin),
      #00ffc6, #ffcc00, #ff3df7, #6ae3ff, #00ffc6) border-box;
  color: #ffffff;
  text-shadow:
    0 0 6px #00ffc6,
    0 0 10px #ff3df7,
    0 0 16px #ffcc00;
  box-shadow:
    0 0 18px rgba(0,255,198,.35),
    0 0 28px rgba(255,61,247,.25),
    0 0 40px rgba(255,204,0,.18);
  animation:
    payoutBounce .9s cubic-bezier(.2,1.4,.2,1) 1,
    payoutGlow .9s ease-out 1,
    payoutSpin 1.2s linear 1;
  will-change: transform, box-shadow, filter;
}

@keyframes payoutBounce{
  0%   { transform: scale(1); }
  35%  { transform: scale(1.18) rotate(-0.8deg); }
  65%  { transform: scale(1.10) rotate(0.6deg); }
  100% { transform: scale(1); }
}

@keyframes payoutGlow{
  0%   { filter: saturate(1) brightness(1); }
  40%  { filter: saturate(1.6) brightness(1.25); }
  100% { filter: saturate(1) brightness(1); }
}

@keyframes payoutSpin{
  to { --spin: 360deg; }
}

/* Respect reduced motion */
@media (prefers-reduced-motion: reduce){
  #payoutTotal.payout-pulse{
    animation: none;
    box-shadow: 0 0 18px rgba(0,255,198,.35);
  }
}[hidden] { display: none !important; }
.loading { display: none !important; }     /* stays hidden until .show is added */
.loading.show { display: block !important; }

/* Visually hidden utility */
.sr-only { 
  position: absolute !important;
  width: 1px; height: 1px; padding: 0; margin: -1px;
  overflow: hidden; clip: rect(0,0,1px,1px); white-space: nowrap; border: 0;
}

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 800px at 50% -20%, #13203b 0%, #0b0f19 60%, #05070d 100%),
        linear-gradient(180deg, #0b0f19 0%, #05070d 100%);
      color: var(--text);
      padding: 24px;
    }
  #toasts {
    position: fixed; top: 12px; right: 12px; z-index: 9999;
    display: flex; flex-direction: column; gap: 8px;
    pointer-events: none;
  }
  .toast {
    pointer-events: auto;
    background: rgba(20,20,20,.92);
    color: #fff; border-radius: 12px; padding: 10px 12px;
    box-shadow: 0 8px 24px rgba(0,0,0,.25);
    font: 600 14px system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    transform: translateY(-6px); opacity: 0;
    transition: transform .18s ease-out, opacity .18s ease-out;
    max-width: 320px; line-height: 1.25;
    border-left: 4px solid #888;
  }
  .toast.show { transform: translateY(0); opacity: 1; }
  .toast.hide { transform: translateX(8px); opacity: 0; }
  .toast.win   { border-left-color: #22c55e; }  /* green */
  .toast.bonus { border-left-color: #06b6d4; }  /* cyan  */
  .toast.error { border-left-color: #ef4444; }  /* red   */

  .toast .close {
    float: right; margin-left: 8px; font-weight: 700; cursor: pointer; opacity: .7;
  }
  .toast .close:hover { opacity: 1; }

  @media (prefers-reduced-motion: reduce) {
    .toast, .toast.show, .toast.hide { transition: none; }
  }
    /* Header / Nav */
    header { display: flex; align-items: center; justify-content: space-between; gap: 16px; margin: 0 auto 16px; max-width: 1100px; }
    .brand { display: flex; align-items: center; gap: 10px; letter-spacing: 0.5px; text-shadow: 0 0 10px rgba(0,255,198,0.6); }
    .brand-badge {
      width: 36px; height: 36px; border-radius: 10px; border: 2px solid var(--card-border);
      box-shadow: 0 0 14px rgba(0,255,198,0.2); display: grid; place-items: center;
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      font-weight: 700; color: var(--accent);
    }
    nav { display: flex; gap: 10px; flex-wrap: wrap; }

    .btn {
      appearance: none; border: 0; cursor: pointer; padding: 10px 14px; border-radius: 12px;
      color: #000; background: var(--accent); text-decoration: none;
      box-shadow: 0 3px 0 #b59000, 0 0 12px rgba(255,204,0,0.35);
      font-weight: 700; letter-spacing: .2px; display: inline-flex; align-items: center; gap: 8px;
      transition: transform .06s ease, filter .12s ease, box-shadow .12s ease;
      font-size: 12px;
    }
    .btn:hover { transform: translateY(-1px); filter: brightness(1.05); }
    .btn:active { transform: translateY(1px); }
    .btn:disabled { background: #555; color: #111; box-shadow: none; cursor: not-allowed; }
    .btn:focus-visible { outline: 2px solid var(--accent-3); outline-offset: 2px; }
    .btn-telegram{
      background: var(--accent-3);
      box-shadow: 0 3px 0 #2aa7bf, 0 0 14px rgba(106,227,255,0.35);
      color: #021018;
    }
    .btn-primary{
      border-radius: 999px;
      border: none;
      padding: 8px 16px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: linear-gradient(135deg, var(--pp-accent1), var(--pp-accent2));
      color: #020617;
      box-shadow: 0 10px 25px rgba(0,0,0,0.6);
      transition: transform 80ms ease, box-shadow 80ms ease, opacity 80ms ease;
    }
    .btn-ghost{
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      color: var(--text);
      border: 1px solid rgba(58,245,217,0.35);
      box-shadow: 0 0 12px rgba(0,255,198,0.18) inset, 0 0 12px rgba(0,255,198,0.12);
    }

    /* Layout panels */
    .wrap { max-width: 1100px; margin: 0 auto; }

/* Stack on tablets/phones */
@media (max-width: 1024px) {
  .hud { grid-template-columns: 1fr; }
  .panel-table, .panel-claim { grid-column: 1; }
}
  .panel {
  /* back to a normal card */
  display: block;
  background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.01));
  border: 1px solid rgba(58,245,217,0.3);
  border-radius: 16px;
  padding: 16px;
  backdrop-filter: blur(4px);
  box-shadow: 0 0 24px rgba(0,255,198,0.06) inset, 0 0 24px rgba(0,255,198,0.08);
}
    .controls { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-top: 8px; }

  </style>
  <script>
    window.KIBL_TOKEN_ID_HEX = window.KIBL_TOKEN_ID_HEX || "656bfefce8a0885acba5c809c5afcfbfa62589417d84d54108e6bb42a6f30000";
  </script>
   <header>
    <nav>
  <a class="btn btn-telegram" href="https://t.me/NexaKennelKlub" target="_blank" rel="noopener noreferrer">
    <!-- Telegram SVG -->
    <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" style="width:18px;height:18px;margin-right:6px;">
      <path fill="#1C93E3" d="M12 0a12 12 0 1 0 0 24A12 12 0 0 0 12 0z"/>
      <path fill="#fff" d="M17.9 7.4c.2-1-.8-1.3-1.6-1l-11 4.2c-.7.3-.7.8-.1 1l2.8.9 6.5-4.1c.3-.2.6-.1.4.1l-5.3 4.9-.2 3.1c.5 0 .7-.2 1-.5l1.7-1.6 2.6 1.9c.6.3 1 .1 1.1-.6l1.9-9.3z"/>
    </svg>
    Join Telegram
  </a>
 <a class="btn btn-primary" href="play.html" style="font-size: 1.1rem; padding: 14px 24px;">
        ‚ô†Ô∏è Play Poker
      </a>
<a class="btn btn-primary" href="blackjack.html" style="font-size: 1.1rem; padding: 14px 24px;">
        üÉè Play Blackjack
      </a>
      <a class="btn btn-ghost" href="/"              class="kk-home" aria-label="Go to Home">üè† Home</a>
     
    <a id="navConnect" class="btn btn-ghost" href="/connect.html" aria-current="page">Connect Wallet</a>


</head>
</nav>
    <div class="brand">
      <div class="brand-badge">KK</div>
      <h1>PixelPup Dice üé≤</h1>
    </div>
  </header>
<body>
  <main class="frame">
    <section>
        <span class="badge">üéÑChristmas SeasonüéÑ</span>
      </div>
      <p class="subtitle">Roll under the target. Higher risk, higher KIBL. All rolls are provably fair (commit‚Äìreveal).</p>

      <div class="dice-main">
        <div id="selectedTierLabel" style="font-size:0.8rem;color:var(--pp-muted);text-transform:uppercase;letter-spacing:.08em;">
          Select your risk tier:
        </div>
        <div id="tierList" class="tier-list"></div>

        <div class="result" id="resultArea">
          <div>Roll: <span class="roll" id="rollValue">‚Äì ‚Äì ‚Äì ‚Äì</span></div>
          <div id="resultStatus"></div>
        </div>

        <div class="controls">
  <button id="betBtn">
    <span>Place 100 KIBL Bet</span>
  </button>
  <button id="rollBtn" disabled>
    <span>Roll Dice</span>
  </button>
  <button id="changeTargetBtn" class="btn-secondary" disabled>
    Change Target
  </button>
  <button id="fairBtn" class="btn-secondary" disabled>
    Fairness
  </button>
</div>

        <div class="hint">
          100 KIBL is sent on-chain to the PixelPup house wallet. Winnings accrue to your in-app KIBL bank for payouts.
        </div>
      </div>
    </section>

    <aside class="side">
      <div class="panel panel-claim">
  <div class="panel" id="diceWindowPanel">
    <h2>Season Dice Points Window</h2>
    <p id="userTag" class="readout" style="margin:0 0 8px;"></p>
    <div id="lb-dice" class="leaderboard"></div>
    <div class="readout" style="margin-top:6px;">
      <a class="btn btn-ghost" href="/leaderboard.html?game=dice" style="width:100%; text-align:center;">
        See full leaderboard ‚Üí
      </a>
    </div>
  </div>

  <div style="margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.12); padding-top: 16px;">
    <h2>Claim</h2>
    <button id="dailyReward" class="btn btn-ghost" style="width:100%; margin-bottom:10px;">
      Claim Daily Reward
    </button>
   <a href="claim.html" class="btn btn-primary" style="width:100%; text-align:center; display:block; padding:12px;">
          FEED ME! üêæ (Withdraw)
        </a>

    <div id="payoutCaptcha" style="margin-bottom:10px;"></div>
  </div>
</div>
      </div>

      <div class="panel">
        <h2>How it Works</h2>
        <p class="hint">
          1. Click <strong>Place 100 KIBL Bet</strong> and sign the tx in your Nexa wallet.<br>
          2. Pick a Pup tier and hit <strong>Roll Dice</strong>.<br>
          3. If your roll is below the target, you win KIBL into your in-app bank.<br>
          4. Click Fairness to see the server seed & verify the roll.
        </p>
      </div>
      <audio id="feedSound" src="dogfood.mp3" preload="auto"></audio>
    </aside>
  </main>

  <script type="module">
    const state = {
      profile: null,
      dice: {
        handId: null,
        commit: null,
        tiers: [],
        selectedTier: null,
        fair: null,
        mode: 'idle' // 'idle' | 'preRoll' | 'postRoll'
      }
    };
    let csrfToken = null;


const dailyRewardBtn = document.getElementById(IDS.daily);

async function ensureCsrf() {
  if (csrfToken) return csrfToken;
  try {
    const res = await fetch('/api/csrf', { credentials: 'include' });
    if (!res.ok) throw new Error('csrf_fetch_failed');
    const data = await res.json();
    csrfToken = data.csrfToken;
    return csrfToken;
  } catch (e) {
    console.error('CSRF error', e);
    throw e;
  }
}
async function loadProfile() {
  try {
    const r = await fetch(API.profile, { credentials: 'include' });
    const d = await r.json();
    if (!d.ok) return;

    state.profile = d;

    // Bank / payout
    const bankUnits = Math.floor((d.bank || 0) / 100);
    totalPayout = bankUnits;
    if (payoutEl) payoutEl.textContent = `Total Payout: ${bankUnits} KIBL`;
    if (payoutBtn) payoutBtn.disabled = (totalPayout === 0);

    // Tag
    const tagEl = document.getElementById('userTag');
    if (tagEl && d.displayId) tagEl.textContent = `Your tag: ${d.displayId}`;

    // Dice stats
    const diceStats = d.stats?.dice || {};
    const dicePtsEl = document.getElementById('dicePoints');
    const diceWinsEl = document.getElementById('diceWins');
    if (dicePtsEl)  dicePtsEl.textContent  = `Dice Points: ${diceStats.points ?? 0}`;
    if (diceWinsEl) diceWinsEl.textContent = `Dice Wins: ${diceStats.wins ?? 0}`;

    // Wallet balances if linked
    if (d.linked?.address && window.loadWalletBalances) {
      window.loadWalletBalances(d.linked.address);
    }
  } catch (e) {
    console.error('loadProfile failed:', e);
  }
}
function confettiBurst(count = 48, ms = 1800){
  const wrap = document.createElement('div');
  wrap.className = 'fx-confetti';
  document.body.appendChild(wrap);
  for (let i=0;i<count;i++){
    const s = document.createElement('i');
    s.style.setProperty('--x', `${Math.random()*100}%`);
    s.style.setProperty('--rot', `${Math.random()*360}deg`);
    s.style.setProperty('--dur', `${1000 + Math.random()*700}ms`);
    wrap.appendChild(s);
  }
  setTimeout(()=> wrap.remove(), ms + 300);
}
 function show(el){ el && (el.style.display = 'block'); }
  function hide(el){ el && (el.style.display = 'none'); }
  const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));
  function toast(html, { type = 'info', timeout = 2500 } = {}) {
    let root = document.getElementById('toasts');
    if (!root) {
      root = document.createElement('div');
      root.id = 'toasts';
      document.body.appendChild(root);
    }
    const el = document.createElement('div');
    el.className = `toast ${type}`;
    el.setAttribute('role', 'status');
    el.setAttribute('aria-live', 'polite');
    el.innerHTML = `<span class="close" aria-label="Dismiss">√ó</span>${html}`;
    root.appendChild(el);

    // enter
    requestAnimationFrame(() => el.classList.add('show'));

    // auto-dismiss
    const remove = () => {
      el.classList.remove('show');
      el.classList.add('hide');
      el.addEventListener('transitionend', () => el.remove(), { once: true });
    };
    const t = setTimeout(remove, timeout);

    // click to dismiss immediately
    el.querySelector('.close').addEventListener('click', () => {
      clearTimeout(t);
      remove();
    });

    // light haptic on mobile (best-effort)
    if (navigator.vibrate) { navigator.vibrate(20); }
  }
function flashPayout(){
  if (!payoutEl) return;
  // retrigger the one-shot animation reliably
  payoutEl.classList.remove('payout-win');
  // force reflow
  void payoutEl.offsetWidth;
  payoutEl.classList.add('payout-win');
  // clean up after the glow ends
  setTimeout(() => payoutEl?.classList.remove('payout-win'), 1400);
}
async function onDailyReward() {
try {
    const res = await postWithCsrf(API.daily, { method: 'POST', credentials: 'include' });
    const data = await res.json();

    if (!data.ok){
      if (data.error === 'Daily reward already claimed.') {
          const mins = data.retryInMs ? Math.ceil(data.retryInMs/60000) : 'later';
          alert('Daily already claimed. Try again in ~' + mins + ' minutes.');
      } else {
          alert('Daily Reward Failed: ' + (data.error || 'Unknown error'));
      }
      return;
    }

    // SUCCESS: It was sent directly to the wallet
    const creditUnits = Math.floor((data.credit || 0) / 100);
    alert(`Daily Reward Sent! \n\n+${creditUnits} KIBL have been sent directly to your linked wallet.\nTxID: ${data.txId?.slice(0,10)}...`);

    // Refresh the WALLET balance, not the payout total
    const linked = await fetch('/api/wallet/status').then(r=>r.json()).catch(()=>({}));
    if (linked?.address && window.loadWalletBalances) {
        window.loadWalletBalances(linked.address);
    }

  } catch (e) {
    console.error(e);
    alert('Failed to claim daily reward, please try again.');
  }
}
async function loadWalletBalances(address) {
  if (!address) return;
  try {
    const r = await fetch(`/api/wallet/balance?address=${encodeURIComponent(address)}`, { credentials: 'include' });
    const j = await r.json();
    if (!j?.ok) return;

    const kiblEl = document.getElementById('kiblBalance');
    if (kiblEl) kiblEl.textContent = `KIBL: ${j.kibl}`;

    const nexaEl = document.getElementById('nexaBalance');
    if (nexaEl) nexaEl.textContent = `NEXA: ${j.nexa}`;
    updateUI();
  } catch (e) {
    console.error('loadWalletBalances failed:', e);  
  }
}
function updateUI() {
    const navConnect = document.getElementById('navConnect');
    
    console.log("Updating UI. Linked:", !!state.linked, "Local:", state.localWallet);

    // 1. Navigation Button Logic
    if (navConnect) {
      if (state.linked) {
        navConnect.style.display = 'none'; // Connected!
      } else if (state.localWallet) {
        // Zombie State
        navConnect.style.display = 'inline-flex';
        navConnect.textContent = 'üîì Unlock Wallet';
        navConnect.className = 'btn btn-primary';
        navConnect.onclick = (e) => { e.preventDefault(); doUnlock(); };
      } else {
        // Not Connected
        navConnect.style.display = 'inline-flex';
        navConnect.textContent = 'Connect Wallet';
        navConnect.href = '/connect.html';
      }
    }
}
    async function api(path, opts = {}) {
  const method = (opts.method || 'GET').toUpperCase();

  const headers = {
    'Content-Type': 'application/json',
    ...(opts.headers || {})
  };

  // Attach CSRF token for mutating methods
  if (method !== 'GET' && method !== 'HEAD' && method !== 'OPTIONS') {
    const token = await ensureCsrf();
    headers['x-csrf-token'] = token;
  }

  const res = await fetch(path, {
    credentials: 'include',
    ...opts,
    headers
  });

  // If server sent JSON error payload, surface it
  let data;
  try { data = await res.json(); } catch { data = null; }
  if (!res.ok) {
    const msg = data?.error || `HTTP ${res.status}`;
    throw new Error(msg);
  }
  return data;
}


    async function postJson(path, body) {
      return api(path, {
        method: 'POST',
        body: JSON.stringify(body || {})
      });
    }
let totalPayout = 0;
function onHCaptchaLoad() {
  const el = document.getElementById('payoutCaptcha');
  if (!el) {
    console.error('Missing #payoutCaptcha element in DOM.');
    return;
  }
  if (widgetId !== null) return; // already rendered (idempotent)

  widgetId = hcaptcha.render(el, {
    sitekey: HCAPTCHA_SITE_KEY,
    size: 'invisible',
    callback: (token) => {
      if (pendingResolve) {
        pendingResolve(token);
        pendingResolve = null;
      }
    },
    'error-callback': () => {
      if (pendingResolve) {
        pendingResolve(Promise.reject(new Error('hCaptcha error')));
        pendingResolve = null;
      }
    },
    'close-callback': () => {
      if (pendingResolve) {
        pendingResolve(Promise.reject(new Error('hCaptcha closed')));
        pendingResolve = null;
      }
    }
  });
}

function waitForWidget() {
  return new Promise((resolve) => {
    if (widgetId !== null) return resolve(widgetId);
    // If hcaptcha loaded but didn‚Äôt render yet, try again after DOMContentLoaded/onload
    const check = () => {
      if (widgetId !== null) resolve(widgetId);
      else setTimeout(check, 50);
    };
    check();
  });
}
    // ---------- UI helpers ----------
    async function loadDiceLeaderboard() {
  const box = document.getElementById('lb-dice');
  box.innerHTML = '<div class="lb-loading">Loading‚Ä¶</div>';

  try {
    const res = await fetch('/api/leaderboard/dice', { credentials: 'include' });
    const data = await res.json();
    if (!data.ok) throw new Error();

    box.innerHTML = data.players.map(p => `
      <div class="lb-row">
        <div class="lb-rank">#${p.rank}</div>
        <div class="lb-user">
          <img src="${p.avatar}" class="lb-avatar" />
          <span>${p.id}</span>
        </div>
        <div class="lb-points">${p.points} pts</div>
      </div>
    `).join('');

  } catch {
    box.innerHTML = '<div class="lb-error">Failed to load.</div>';
  }
}
    function renderTiers() {
      const list = document.getElementById('tierList');
      list.innerHTML = '';
      state.dice.tiers.forEach(tier => {
        const el = document.createElement('button');
        el.type = 'button';
        el.className = 'tier' + (state.dice.selectedTier === tier.id ? ' selected' : '');
        el.dataset.tierId = tier.id;
        el.innerHTML = `
          <div class="tier-main">
            <div class="tier-emoji">${tier.emoji}</div>
            <div>
              <div class="tier-name">${tier.label}</div>
              <div class="tier-desc">Roll &lt; ${tier.threshold.toString().padStart(4, '0')}</div>
            </div>
          </div>
          <div class="tier-meta">
            <div>Chance: <strong>${(tier.threshold / 100).toFixed(1)}%</strong></div>
            <div>Win: <strong>${tier.payoutCredits} credit${tier.payoutCredits !== 1 ? 's' : ''}</strong></div>
          </div>
        `;
        el.addEventListener('click', () => {
          state.dice.selectedTier = tier.id;
          renderTiers();
          const label = document.getElementById('selectedTierLabel');
          label.textContent = `Selected: ${tier.emoji} ${tier.label}`;
          document.getElementById('rollBtn').disabled = false;
        });
        list.appendChild(el);
      });
    }

    function renderProfile() {
  const p = state.profile;
  if (!p) return;

  document.getElementById('bankValue').textContent =
    (Number(p.bank || 0) / 100).toFixed(2) + ' KIBL';

  const dicePointsEl = document.getElementById('dicePoints');
  const diceWinsEl   = document.getElementById('diceWins');
  if (dicePointsEl) dicePointsEl.textContent = p.dicePoints ?? 0;
  if (diceWinsEl)   diceWinsEl.textContent   = p.diceWins ?? 0;
}
    function showError(message) {
  console.error('[PIXELPUP DICE ERROR]', message);

  // Use the same toast system as the rest of the app if available
  if (window.toast) {
    toast(message, { type: 'error' });
  } else {
    // Fallback so you still see something in dev
    alert(message);
  }
}


async function showRollResult(payload) {
  const {
    roll,
    win,
    tier,
    credit,
    points,
    fair
  } = payload || {};

  const resultRow = document.getElementById('resultRow');
  const status    = document.getElementById('statusText');
  const rollEl    = document.getElementById('rollValue');
  const tierEl    = document.getElementById('resultTier');
  const winEl     = document.getElementById('winAmount');
  const ptsEl     = document.getElementById('pointsEarned');
  const fairBtn   = document.getElementById('fairBtn');
  const changeTargetBtn = document.getElementById('changeTargetBtn');

  if (resultRow) resultRow.hidden = false;

  if (rollEl) rollEl.textContent = roll ?? '‚Äî';
  if (tierEl) tierEl.textContent = tier?.label || tier?.name || '‚Äî';

  const creditUnits = Math.floor((credit || 0) / 100);
  const pointsInt   = points ?? 0;

  if (winEl)   winEl.textContent  = creditUnits > 0 ? `+${creditUnits} KIBL` : 'No win this time';
  if (ptsEl)   ptsEl.textContent  = pointsInt ? `+${pointsInt} dice points` : 'No new points';
  if (status)  status.textContent = creditUnits > 0
    ? 'You fed the pup! üé≤'
    : 'No snacks this roll ‚Äì try again.';

  if (fair) {
    state.dice.fair = fair;
    if (fairBtn) fairBtn.disabled = false;
  } else if (fairBtn) {
    fairBtn.disabled = true;
  }

  state.dice.mode = 'postRoll';

  // WIN FX ‚Äî mirror poker/blackjack
  if (creditUnits > 0) {
    try {
      const sfx = document.getElementById('feedSound');
      if (sfx) {
        sfx.currentTime = 0;
        sfx.volume = 0.6;
        sfx.play().catch(() => {});
      }
    } catch {}

    flashPayout();
    confettiBurst();
    if (navigator.vibrate) navigator.vibrate([10, 40, 10]);
  }

  // Refresh profile + dice leaderboard (async, UX first)
  try {
    await loadProfile();
  } catch (e) {
    console.warn('loadProfile failed after dice roll', e);
  }
  try {
    await loadDiceLeaderboard();
  } catch (e) {
    console.warn('loadDiceLeaderboard failed', e);
  }

  if (changeTargetBtn) changeTargetBtn.disabled = false;
}
    window.loadProfile = loadProfile;
let currentTier = null;
let lastResult = null;

function selectTarget(tierId) {
  currentTier = DICE_TIERS.find(t => t.id === tierId);
}
    // ---------- Core game flow ----------
    async function startRound() {
  // Called by walletBet after bet is sent
  const res = await postJson('/api/dice/start', { clientSeed: crypto.randomUUID() });
  if (!res.ok) throw new Error(res.error || 'dice_start_error');

  state.dice.handId       = res.handId;
  state.dice.commit       = res.commit;
  state.dice.tiers        = res.tiers || [];
  state.dice.selectedTier = null;
  state.dice.fair         = null;
  state.dice.mode         = 'preRoll';

  renderTiers();
  document.getElementById('selectedTierLabel').textContent = 'Select your risk tier:';
  document.getElementById('rollValue').textContent = '‚Äì ‚Äì ‚Äì ‚Äì';
  document.getElementById('resultStatus').textContent = '';

  const rollBtn         = document.getElementById('rollBtn');
  const fairBtn         = document.getElementById('fairBtn');
  const changeTargetBtn = document.getElementById('changeTargetBtn');

  if (rollBtn) rollBtn.disabled = true;          // wait for tier click
  if (fairBtn) fairBtn.disabled = true;
  if (changeTargetBtn) changeTargetBtn.disabled = false; // can change tier before roll
}
window.startRound = startRound;


   async function rollDice() {
  const tierId = state.dice.selectedTier;
  if (!tierId) {
    showError('Select a target first.');
    return;
  }

  const body = {
    tierId,
    nonce: Date.now()
  };

  const data = await postJson('/api/dice/roll', body).catch(e => {
    showError(e.message || 'Roll failed.');
    return null;
  });
  if (!data || !data.ok) {
    if (data && data.error) showError(data.error);
    return;
  }

  // data.tier + data.credit + data.points should come from your backend
  showRollResult({
    roll:   data.roll,
    win:    data.win,
    tier:   data.tier,
    credit: data.credit,
    points: data.points,
    fair:   data.fair || null
  });

  document
    .getElementById('targetSelectRow')
    ?.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

    async function showFairness() {
      const fair = state.dice.fair;
      if (!fair) return;
      const msg = [
        `Hand ID: ${fair.handId}`,
        `Commit:  ${fair.commit}`,
        `Server:  ${fair.serverSeed}`,
        `Client:  ${fair.clientSeed || '(none)'}`,
        '',
        'Algo:',
        fair.algo
      ].join('\n');
      alert(msg);
    }
function changeTarget() {
  // Just reset selection; user picks a new tier for the NEXT roll
  state.dice.selectedTier = null;
  renderTiers();

  const label   = document.getElementById('selectedTierLabel');
  const rollBtn = document.getElementById('rollBtn');
  if (label) label.textContent = 'Select your risk tier:';
  if (rollBtn) rollBtn.disabled = true;
}

async function betAndRollNext() {
  const previousTier = state.dice.selectedTier;
  if (!previousTier) {
    showError('Select a target first.');
    return;
  }

  const betBtn = document.getElementById('betBtn');
  if (!betBtn) {
    showError('Bet button not found');
    return;
  }

  // 1) Place a fresh 100 KIBL bet ‚Äì same flow as clicking the bet button
  await onBetClick(betBtn);  // sends tx, calls startRound(), reloads profile

  // 2) Re-apply the chosen tier to the new round
  state.dice.selectedTier = previousTier;
  renderTiers();

  // 3) Auto-roll with that tier on the new round
  await rollDice();
}



    async function payout() {
      if (totalPayout === 0) {
    // Double-check with the server in case the local variable is stale
    try {
      const r = await fetch(API.profile, { credentials: 'include' });
      const d = await r.json();
      if (d?.ok) {
        const bankUnits = Math.floor((d.bank || 0) / 100);
        totalPayout = bankUnits;
        if (payoutEl) payoutEl.textContent = `Total Payout: ${bankUnits} KIBL`;
        if (payoutBtn) payoutBtn.disabled = (totalPayout === 0);
      }
    } catch {}
    if (totalPayout === 0) { alert('No payout to claim!'); return; }
 }

  // Visible hCaptcha: ensure the user solved the challenge first
  const token = window.hcaptcha?.getResponse?.();
  if (!token) {
    // nudge: focus the widget and ask the user to complete it
    document.querySelector('#payoutCaptcha iframe')?.focus();
    alert('Please complete the hCaptcha challenge first.');
    return;
  }

  try {
    show(payoutLoading);
    payoutBtn.disabled = true;

    const resp = await postWithCsrf(API.payout, {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        playerAddress,
        'h-captcha-response': token    // <- standard field name
      })
    });

    const data = await resp.json().catch(() => ({}));

    if (!resp.ok || data.error) {
      try { window.hcaptcha?.reset?.(); } catch {}
      alert('Payout failed: ' + (data.error || resp.statusText));
      return;
    }

    try { feedSound.currentTime = 0; feedSound.play(); } catch {}
    alert(`Payout successful! Tx ID: ${data.txId}`);

    totalPayout = data.remainingKIBL ?? 0;
    payoutEl.textContent = `Total Payout: ${totalPayout} KIBL`;
    // Reset so the user can claim again in the future
    try { window.hcaptcha?.reset?.(); } catch {}

  } catch (e) {
    console.error('Payout failed:', e);
    try { window.hcaptcha?.reset?.(); } catch {}
    alert(e?.message || 'Payout failed. Try again.');
  } finally {
    hide(payoutLoading);
    
  }
}

    // ---------- Wire walletBet's betBtn ----------
    async function onBetClick(btn) {
      try {
        btn.disabled = true;
        btn.classList.add('busy');
        btn.textContent = 'Loading Wallet...';

        const { placeBet }  = await import("/assets/walletBet.bundle.js?v=4");
        const { getSigner } = await import("/assets/wallet-modal.js?v=Christmasv22cachedupdate");

        btn.textContent = 'Authorizing...';
        const passphrase = await getSigner();
        if (!passphrase) throw new Error("Cancelled");

        btn.textContent = 'Signing...';
        const { txId } = await placeBet({
          passphrase,
          kiblAmount: 10000,
          tokenIdHex: window.KIBL_TOKEN_ID_HEX,
          feeNexa: 600
        });

        if (window.toast) toast(`Bet sent!`, { type: 'win' });

        btn.style.display = 'none';

        if (window.startRound) await window.startRound();
        if (window.loadProfile) window.loadProfile();
        if (state.profile?.linked) window.loadWalletBalances?.(state.profile.linked.address);

      } catch (e) {
        const msg = e.message || String(e);
        if (msg !== 'Cancelled' && !msg.includes('User rejected')) {
          alert("Bet Error: " + msg);
        }
        btn.style.display = 'inline-flex';
        btn.textContent = 'Place 100 KIBL Bet';
        btn.disabled = false;
      } finally {
        btn.classList.remove('busy');
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
  const betBtn         = document.getElementById('betBtn');
  const rollBtn        = document.getElementById('rollBtn');
  const fairBtn        = document.getElementById('fairBtn');
  const payoutBtn      = document.getElementById('payoutBtn');
  const changeTargetBtn = document.getElementById('changeTargetBtn');
  const dailyRewardBtn = document.getElementById('dailyReward');
if (dailyRewardBtn) dailyRewardBtn.addEventListener('click', onDailyReward);
  

  if (betBtn) betBtn.addEventListener('click', () => onBetClick(betBtn));
 if (rollBtn) rollBtn.addEventListener('click', onRollClick);
  if (fairBtn) fairBtn.addEventListener('click', showFairness);
  if (payoutBtn) payoutBtn.addEventListener('click', payout);
  if (changeTargetBtn) changeTargetBtn.addEventListener('click', changeTarget);
  if (dailyRewardBtn)dailyRewardBtn.addEventListener('click', onDailyReward);

  await ensureCsrf().catch(() => {});
  loadProfile();
});

  </script>
</body>
</html>
