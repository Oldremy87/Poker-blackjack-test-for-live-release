<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PixelPup Blackjack</title>
  <script src="https://hcaptcha.com/1/api.js" async defer></script>
  <script>
    (async () => {
      try {
        const r = await fetch('/api/csrf', { credentials: 'include' });
        const j = await r.json();
        window.csrfToken = j.csrfToken;
      } catch {}
    })();
  </script>

  <style>
    /* ... (Keep your existing CSS exactly as it was) ... */
    :root{ --ui-scale: 1; --hand-gap: 10px; --card-ratio: 1.6; --cardW: 100px; --bg: #0b0f19; --panel: #111827; --text: #00ffc6; --text-dim: #7fffe6; --accent: #ffcc00; --accent-2: #ff3df7; --accent-3: #6ae3ff; --card-bg: #222638; --card-border: #3af5d9; --danger: #ff5577; --ok: #45ff99; --win-cyan: #3af5d9; --win-pink: #ff3df7; --win-gold: #ffcc00; }
    [hidden] { display: none !important; }
    .loading { display: none !important; }
    .loading.show { display: block !important; }
    .hidden { display: none !important; }
    .sr-only { position: absolute !important; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,1px,1px); white-space: nowrap; border: 0; }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: radial-gradient(1200px 800px at 50% -20%, #13203b 0%, #0b0f19 60%, #05070d 100%), linear-gradient(180deg, #0b0f19 0%, #05070d 100%); color: var(--text); padding: 24px; }
    #toasts { position: fixed; top: 12px; right: 12px; z-index: 9999; display: flex; flex-direction: column; gap: 8px; pointer-events: none; }
    .toast { pointer-events: auto; background: rgba(20,20,20,.92); color: #fff; border-radius: 12px; padding: 10px 12px; box-shadow: 0 8px 24px rgba(0,0,0,.25); font: 600 14px system-ui, sans-serif; transform: translateY(-6px); opacity: 0; transition: transform .18s ease-out, opacity .18s ease-out; max-width: 320px; line-height: 1.25; border-left: 4px solid #888; }
    .toast.show { transform: translateY(0); opacity: 1; }
    .toast.hide { transform: translateX(8px); opacity: 0; }
    .toast.win { border-left-color: #22c55e; }
    .toast.bonus { border-left-color: #06b6d4; }
    .toast.error { border-left-color: #ef4444; }
    .toast .close { float: right; margin-left: 8px; font-weight: 700; cursor: pointer; opacity: .7; }
    header { display: flex; align-items: center; justify-content: space-between; gap: 16px; margin: 0 auto 16px; max-width: 1100px; }
    .brand { display: flex; align-items: center; gap: 10px; letter-spacing: 0.5px; text-shadow: 0 0 10px rgba(0,255,198,0.6); }
    .brand-badge { width: 36px; height: 36px; border-radius: 10px; border: 2px solid var(--card-border); box-shadow: 0 0 14px rgba(0,255,198,0.2); display: grid; place-items: center; background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02)); font-weight: 700; color: var(--accent); }
    nav { display: flex; gap: 10px; flex-wrap: wrap; }
    .btn { appearance: none; border: 0; cursor: pointer; padding: 10px 14px; border-radius: 12px; color: #000; background: var(--accent); text-decoration: none; box-shadow: 0 3px 0 #b59000, 0 0 12px rgba(255,204,0,0.35); font-weight: 700; letter-spacing: .2px; display: inline-flex; align-items: center; gap: 8px; transition: transform .06s ease, filter .12s ease, box-shadow .12s ease; font-size: 12px; }
    .btn:hover { transform: translateY(-1px); filter: brightness(1.05); }
    .btn:active { transform: translateY(1px); }
    .btn:disabled { background: #555; color: #111; box-shadow: none; cursor: not-allowed; }
    .btn-telegram { background: var(--accent-3); box-shadow: 0 3px 0 #2aa7bf, 0 0 14px rgba(106,227,255,0.35); color: #021018; }
    .btn-primary { background: var(--accent-2); color: #120016; box-shadow: 0 3px 0 #a2259c, 0 0 14px rgba(255,61,247,0.35); }
    .btn-ghost { background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02)); color: var(--text); border: 1px solid rgba(58,245,217,0.35); box-shadow: 0 0 12px rgba(0,255,198,0.18) inset, 0 0 12px rgba(0,255,198,0.12); }
    .wrap { max-width: 1100px; margin: 0 auto; }
    .panel { display: block; background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.01)); border: 1px solid rgba(58,245,217,0.3); border-radius: 16px; padding: 16px; backdrop-filter: blur(4px); box-shadow: 0 0 24px rgba(0,255,198,0.06) inset, 0 0 24px rgba(0,255,198,0.08); }
    .controls { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-top: 8px; }
    .readout { color: var(--text-dim); font-size: 12px; margin: 4px 0; }
    .card { cursor: pointer; user-select: none; --_w: calc(var(--cardBaseW, var(--cardW)) * var(--ui-scale)); width: var(--_w); height: calc(var(--_w) * var(--card-ratio)); border-radius: 10px; background: var(--card-bg); color: #fff; border: 2px solid var(--card-border); display: grid; grid-template-rows: minmax(0, 1fr) auto auto; align-items: center; justify-items: center; padding: 8px; overflow: hidden; position: relative; text-align: center; box-shadow: 0 0 20px rgba(0,255,198,0.1); }
    .card img { width: 100%; height: 100%; object-fit: contain; display: block; }
    .card-hand { gap: var(--hand-gap); display: flex; flex-wrap: nowrap; justify-content: center; align-items: flex-start; gap: 10px; min-height: 170px; margin: 12px auto 0; max-width: 1100px; }
    #bj-panels { position: static; width: 100%; display: grid; grid-template-columns: repeat(2, minmax(220px, 1fr)); gap: .75rem; margin-top: .75rem; align-items: start; z-index: 1; }
    .bj-dialog header { display: flex; align-items: center; justify-content: space-between; margin-bottom: .35rem; font-size: 0.95rem; }
    .bj-dialog .body { display: grid; gap: .4rem; }
    #playerTotals, #dealerTotals { font-size: 1.05rem; font-weight: 600; }
    #playerCards, #dealerCards { display: flex; flex-wrap: wrap; gap: .35rem .45rem; }
    .cardchip { border: 1px solid #3a3f7d; background: #171b35; padding: .25rem .5rem; border-radius: 10px; font-size: .85rem; }
    .chip { display: inline-block; padding: .18rem .5rem; border-radius: 999px; font-size: .75rem; border: 1px solid transparent; }
    .chip.win { background: #123e22; color: #c0ffd7; border-color: #1f6a3a; }
    .chip.loss { background: #3e1212; color: #ffd0d0; border-color: #6a1f1f; }
    .chip.play { background: #122a3e; color: #cfe8ff; border-color: #1f476a; }
    .chip.bj { background: #262051; color: #e3d7ff; border-color: #4b409a; }
    .handline { display: flex; align-items: baseline; gap: .5rem; }
    .activeHand { outline: 1px dashed #6ea8ff; outline-offset: 6px; border-radius: 12px; padding: .2rem .3rem; }
    .hud { display: grid; grid-template-columns: minmax(0, 2fr) minmax(320px, 1fr); gap: 16px; align-items: start; }
    .panel-table { grid-column: 1; }
    .panel-claim { grid-column: 2; }
    @media (max-width: 1024px) { .hud { grid-template-columns: 1fr; } .panel-table, .panel-claim { grid-column: 1 / -1; } }
    #payoutTotal { display: inline-block; padding: 6px 10px; border-radius: 12px; position: relative; background: #0f1425; border: 1px solid rgba(58,245,217,.35); transition: transform .15s ease, box-shadow .15s ease, filter .15s ease; }
    #bjPlayer { display: flex; flex-direction: column; align-items: center; gap: var(--hand-gap); }
    #bjPlayer .hand-row { display: flex; gap: var(--hand-gap); }
    .modal { position:fixed; inset:0; background:rgba(0,0,0,.6); display:flex; align-items:center; justify-content:center; z-index:9999; }
    .modal-content { background:#111; color:#fff; padding:1.25rem; max-width:600px; border-radius:14px; }
  </style>
</head>
<body>
  
  <header>
    <nav>
      <a class="btn btn-telegram" href="https://t.me/NexaKennelKlub" target="_blank">Telegram</a>
      <a class="btn btn-ghost" href="https://x.com/Oldremy" target="_blank">@Oldremy</a>
      <a class="btn btn-ghost" href="/">üè† Home</a>
      <a class="btn btn-primary" href="/play.html">Play Poker</a>
      <a class="btn btn-ghost" href="/connect.html">Connect Wallet</a>
    </nav>
    <div class="brand">
      <div class="brand-badge">KK</div>
      <h1>PixelPup BlackJack</h1>
    </div>
  </header>

  <div class="wrap">
    <div class="hud">
      <div class="panel panel-table" id="bjPanel">
        <h1>Blackjack</h1>
        
        <div id="bjHowto" class="modal" style="display:none">
          <div class="modal-content">
            <h2>How to Play</h2>
            <ul>
              <li>Goal: Beat dealer without going over 21.</li>
              <li>Natural Blackjack (Ace + 10/Face) pays 6 credits.</li>
              <li>Win pays 3 credits.</li>
              <li>Actions: Hit, Stand, Double, Split.</li>
            </ul>
            <button id="bjHowtoClose" class="btn">Let‚Äôs play</button>
          </div>
        </div>

        <div class="controls" style="margin-bottom:10px;">
           <p id="userTag" class="readout"></p>
           <a class="btn btn-ghost" href="bjachievements.html">Achievements</a>
           <p id="bjFair" class="readout" style="font-family:monospace; font-size:11px;"></p>
        </div>

        <div class="readout">Dealer</div>
        <div id="bjDealer" class="card-hand" aria-live="polite"></div>

        <div class="readout">You</div>
        <p id="payoutTotal">Total Payout: 0 KIBL</p>
        <p id="kiblBalance">KIBL: ‚Äî</p>
        <p id="nexaBalance">NEXA: ‚Äî</p>
        
        <div id="bjPlayer" class="card-hand" aria-live="polite"></div>

        <div class="controls" style="margin-top:20px;">
          <button id="betBtn" class="btn" data-default-text="Place 100 KIBL Bet">Place 100 KIBL bet</button>
          
          <button id="bjStart" class="btn btn-primary" style="display:none;">Feed the dealer</button>
          <button id="bjHit" class="btn" disabled>Hit</button>
          <button id="bjStand" class="btn" disabled>Stand</button>
          <button id="bjDoubleBtn" class="btn" disabled>Double</button>
          <button id="bjSplitBtn" class="btn hidden" disabled>Split</button>
        </div>

        <div id="bj-panels" aria-live="polite">
          <div id="playerPanel" class="bj-dialog">
            <header><strong>Your Hand</strong> <span id="playerStatus" class="chip"></span></header>
            <div class="body"><div id="playerTotals"></div><div id="playerCards"></div></div>
            <footer id="playerFooter" class="muted"></footer>
          </div>
          <div id="dealerPanel" class="bj-dialog">
            <header><strong>Dealer</strong> <span id="dealerStatus" class="chip"></span></header>
            <div class="body"><div id="dealerTotals"></div><div id="dealerCards"></div></div>
            <footer id="dealerFooter" class="muted"></footer>
          </div>
        </div>
        
        <div id="bjStatus" class="muted" style="text-align:center; margin-top:10px;"></div>
      </div>

      <div class="panel panel-claim">
        <div class="controls" style="display:flex; flex-direction:column; gap:10px;">
          <button id="dailyReward" class="btn btn-ghost" style="width:100%">Claim Daily Reward</button>
          <a href="claim.html" class="btn btn-primary" style="width:100%; text-align:center;">Withdraw Winnings</a>
          
          <div class="panel" id="leaderboardPanel" style="margin-top:10px; background:rgba(0,0,0,0.2);">
            <h2 style="font-size:1.1em; margin-top:0;">Season Points</h2>
            <ol id="leaderboardList" class="leaderboard"></ol>
            <div class="readout" style="margin-top:6px;">
               <a class="btn btn-ghost" href="/leaderboard.html?game=blackjack" style="font-size:0.8em; width:100%">Full Leaderboard</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <audio id="feedSound" src="dogfood.mp3" preload="auto"></audio>

  <div id="cookieBar" class="cookie-bar" role="region" aria-label="Cookie notice" hidden style="position:fixed; bottom:20px; left:20px; background:#111; padding:15px; border:1px solid #3af5d9; border-radius:10px; z-index:9999;">
    <span>PixelPup uses cookies. <a href="privacy.html">Privacy Policy</a>.</span>
    <button id="cookieAccept" class="btn">Accept</button>
  </div>

  <script>
    (function () {
      const KEY = 'kk_cookie_consent_v1';
      function initCookieBar() {
        const bar = document.getElementById('cookieBar');
        const btn = document.getElementById('cookieAccept');
        if (!bar || !btn) return;
        try {
          if (localStorage.getItem(KEY) === 'true') return;
          bar.hidden = false;
          btn.addEventListener('click', () => {
            localStorage.setItem(KEY, 'true');
            bar.hidden = true;
          });
        } catch {
          bar.hidden = false;
          btn.addEventListener('click', () => bar.hidden = true);
        }
      }
      if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initCookieBar);
      else initCookieBar();
    })();
  </script>

  <script>
    // --- 1. CONFIG & API ---
    window.KIBL_TOKEN_ID_HEX = "656bfefce8a0885acba5c809c5afcfbfa62589417d84d54108e6bb42a6f30000";
    const API = Object.freeze({
      profile:'/api/profile', daily:'/api/daily-reward', payout:'/api/payout',
      bj: { start:'/api/bj/start', hit:'/api/bj/hit', stand:'/api/bj/stand', double:'/api/bj/double', split:'/api/bj/split' }
    });

    const IDS = { payout: 'payoutTotal', deal: 'bjStart', hit: 'bjHit', stand: 'bjStand', double: 'bjDoubleBtn', split: 'bjSplitBtn' };
    const btnStart = document.getElementById(IDS.deal);
    const btnHit = document.getElementById(IDS.hit);
    const btnStand = document.getElementById(IDS.stand);
    const btnDouble = document.getElementById(IDS.double);
    const btnSplit = document.getElementById(IDS.split);
    const bjMsg = document.getElementById('bjStatus');
    const bjDealer = document.getElementById('bjDealer');
    const bjPlayer = document.getElementById('bjPlayer');
    const payoutEl = document.getElementById(IDS.payout);

    let __csrf = null;

    // --- 2. HELPERS ---
    async function fetchCsrf(){
      const r = await fetch('/api/csrf', { credentials:'include' });
      if (!r.ok) throw new Error('CSRF bootstrap failed');
      const { csrfToken } = await r.json();
      __csrf = csrfToken;
      window.csrfToken = csrfToken; // ensure global
    }

    async function postWithCsrf(input, init = {}) {
      if (!__csrf) await fetchCsrf();
      const baseHeaders = init.headers ? {...init.headers} : {};
      if (!baseHeaders['Content-Type']) baseHeaders['Content-Type'] = 'application/json';
      
      const makeReq = async () => fetch(input, {
        ...init, method: init.method || 'POST', credentials: 'include',
        headers: { 'x-csrf-token': __csrf, ...baseHeaders }
      });

      let resp = await makeReq();
      if (resp.status === 403) {
        await fetchCsrf();
        resp = await makeReq();
      }
      return resp.json(); // always return JSON
    }

    function fitBjToScreen(){
      const panel = document.getElementById('bjPanel');
      if (!panel) return;
      const gap = 10;
      const dealerCount = document.querySelectorAll('#bjDealer .card').length || 2;
      const rowCounts = Array.from(document.querySelectorAll('#bjPlayer .hand-row')).map(r => r.querySelectorAll('.card').length);
      const n = Math.max(dealerCount, ...(rowCounts.length ? rowCounts : [2]));
      const available = panel.clientWidth - 32;
      const perCard = (available - gap * (n - 1)) / n;
      const base = Math.max(64, Math.min(perCard, 136)); 
      document.documentElement.style.setProperty('--cardBaseW', base + 'px');
    }

    function renderCard(c, hidden=false) {
      const d = document.createElement('div'); d.className='card';
      const i = document.createElement('img');
      i.src = hidden ? 'cards/card-back.png' : `cards/${c.filename}`;
      d.appendChild(i);
      return d;
    }

    function renderHands({ dealer, player }) {
      bjDealer.innerHTML = '';
      if (dealer.full) dealer.full.forEach(c => bjDealer.appendChild(renderCard(c)));
      else {
        bjDealer.appendChild(renderCard(dealer.up));
        bjDealer.appendChild(renderCard(dealer.up, true));
      }
      
      bjPlayer.innerHTML = '';
      (player || []).forEach(h => {
        const row = document.createElement('div'); row.className='hand-row';
        (h.cards || []).forEach(c => row.appendChild(renderCard(c)));
        bjPlayer.appendChild(row);
      });
      fitBjToScreen();
    }

    function applyBJCan(can = {}) {
      btnHit.disabled = !(can.hit ?? true);
      btnStand.disabled = !(can.stand ?? true);
      btnDouble.disabled = !(can.double ?? false);
      const allowSplit = !!can.split;
      btnSplit.disabled = !allowSplit;
      if (allowSplit) btnSplit.classList.remove('hidden');
      else btnSplit.classList.add('hidden');
    }

    // --- 3. UI UPDATES ---
    function updateBjPanels(data) {
      // (Simplified panel logic for brevity - keeping your existing DOM IDs)
      // This part assumes your existing updatePlayerPanelFromSnapshot logic is embedded or similar
      // For this unified script, I'll rely on a simpler update if functions aren't fully copied, 
      // but assuming you kept the helper functions from before, we call them here.
      if (window.updatePlayerPanelFromSnapshot) window.updatePlayerPanelFromSnapshot(data);
      if (window.updateDealerPanelFromSnapshot) window.updateDealerPanelFromSnapshot(data);
    }

    // --- 4. GAME ACTIONS ---
    async function startRound() {
      try {
        const d = await postWithCsrf(API.bj.start);
        if (!d.ok) throw new Error(d.error || 'Start failed');
        
        if (d.fair?.commit) document.getElementById('bjFair').textContent = `Commit: ${d.fair.commit.slice(0,10)}...`;

        renderHands({ dealer: d.dealer, player: [{ cards: d.player }] });
        updateBjPanels(d); // Make sure to define or copy your panel update logic!
        
        if (d.settled) {
          afterActionSnapshot(d);
        } else {
          applyBJCan(d.can);
          bjMsg.textContent = 'Your move.';
        }
      } catch (e) {
        alert(e.message);
      }
    }

    async function hit() { action(API.bj.hit); }
    async function stand() { action(API.bj.stand); }
    async function doubleDown() { action(API.bj.double); }
    async function split() { action(API.bj.split); }

    async function action(url) {
      try {
        const d = await postWithCsrf(url);
        if (!d.ok) throw new Error(d.error);
        afterActionSnapshot(d);
      } catch (e) {
        // toast(e.message, { type:'error' });
        console.error(e);
      }
    }

    function afterActionSnapshot(d) {
      const dealer = d.dealer.full ? d.dealer : d.dealer;
      renderHands({ dealer, player: d.players });
      updateBjPanels(d);
      
      if (d.settled) {
        applyBJCan({ hit:false, stand:false, double:false, split:false });
        bjMsg.textContent = 'Round settled.';
        
        // --- BRIDGE TO BETTING UI ---
        // This is the critical fix for "No button on loss"
        if (window.onGameSettled) window.onGameSettled(); 
        
        // If win, show fanfare
        const credit = Math.floor((d.credit||0)/100);
        if (credit > 0) {
           document.getElementById('payoutTotal').textContent = `Total Payout: ${Math.floor((d.sessionBalance||0)/100)} KIBL`;
           // Trigger confetti/sound here if desired
        }
      } else {
        // Not settled, update controls
        // If the server didn't send 'can' (some endpoints might not), imply standard
        // usually 'hit'/'stand' returns a snapshot. 
        // We might need to guess or assume standard controls if 'can' is missing
        // But your server usually returns settled=false.
      }
    }

    // --- 5. INITIALIZATION ---
    btnHit.addEventListener('click', hit);
    btnStand.addEventListener('click', stand);
    btnDouble.addEventListener('click', doubleDown);
    btnSplit.addEventListener('click', split);
    document.getElementById('dailyReward').addEventListener('click', async () => {
       const d = await postWithCsrf(API.daily);
       if(d.ok) alert(`Reward: ${d.credit/100} KIBL`);
       else alert(d.error || 'Failed');
    });

    // Make global for the module script
    window.startRound = startRound;
    window.loadWalletBalances = async (addr) => {
        try {
            const r = await fetch(`/api/wallet/balance?address=${encodeURIComponent(addr)}`);
            const j = await r.json();
            if(j.ok) {
                document.getElementById('kiblBalance').textContent = `KIBL: ${j.kibl}`;
                document.getElementById('nexaBalance').textContent = `NEXA: ${j.nexa}`;
            }
        } catch {}
    };

    // Copy your Panel Update helpers here to ensure they exist!
    function bjScore(cards) {
        let total = 0, aces = 0;
        for (const c of (cards||[])) {
            const r = c.rank;
            if (r === 'Ace') { total += 11; aces++; }
            else if (['King','Queen','Jack'].includes(r)) total += 10;
            else total += Number(r) || 0;
        }
        while (total > 21 && aces > 0) { total -= 10; aces--; }
        return { total, soft: aces > 0, isBJ: (cards?.length === 2 && total === 21) };
    }
    window.updatePlayerPanelFromSnapshot = (data) => {
        const pTotalsEl = document.getElementById('playerTotals');
        const hands = data.players || (data.player ? [{cards:data.player}] : []);
        if(!hands.length) return;
        pTotalsEl.innerHTML = hands.map((h,i) => {
            const s = bjScore(h.cards);
            return `<div>Hand ${i+1}: <strong>${s.total}</strong></div>`;
        }).join('');
    };
    window.updateDealerPanelFromSnapshot = (data) => {
        const dTotalsEl = document.getElementById('dealerTotals');
        if(!data.dealer) return;
        const cards = data.dealer.full || (data.dealer.up ? [data.dealer.up] : []);
        const s = bjScore(cards);
        dTotalsEl.innerHTML = `<div>Total: <strong>${s.total}</strong> ${data.dealer.holeHidden ? '(?)' : ''}</div>`;
    };

  </script>

  <script type="module">
    import { placeBet } from '/assets/walletBet.bundle.js';
    import { getSigner } from "/assets/wallet-modal.js?v=Christmas";

    // Bridge: When game ends, this function is called by the Game Logic above
    window.onGameSettled = async () => {
        const btn = document.getElementById('betBtn');
        const linked = await fetch('/api/wallet/status').then(r=>r.json()).catch(()=>({}));
        
        btn.style.display = 'inline-flex';
        btn.disabled = false;
        btn.textContent = 'Place 100 KIBL Bet';
        
        if (linked?.address) window.loadWalletBalances(linked.address);
    };

    addEventListener('DOMContentLoaded', async () => {
      const btn = document.getElementById('betBtn');
      const linked = await fetch('/api/wallet/status').then(r=>r.json()).catch(()=>({}));
      
      if (!linked.ok || !linked.linked) {
          btn.textContent = 'Connect Wallet';
          btn.onclick = () => window.location.href = '/connect.html';
          return;
      }
      
      if (linked.address) window.loadWalletBalances(linked.address);

      btn.addEventListener('click', async () => {
        if (btn.classList.contains('busy')) return;
        try {
          btn.classList.add('busy');
          btn.textContent = 'Unlocking...';
          const pass = await getSigner();
          
          btn.textContent = 'Signing...';
          const { txId } = await placeBet({
             passphrase: pass,
             kiblAmount: 100000, 
             tokenIdHex: window.KIBL_TOKEN_ID_HEX,
             feeNexa: 600
          });
          
          // Toast success
          const t = document.createElement('div');
          t.className = 'toast show win';
          t.innerHTML = 'Bet Sent!';
          document.getElementById('toasts').appendChild(t);
          setTimeout(()=>t.remove(), 2000);

          // Hide button BEFORE start to prevent race condition on instant BJ
          btn.style.display = 'none'; 
          
          await window.startRound();

        } catch (e) {
          console.error(e);
          alert(e.message);
          // If fail, show button again
          btn.style.display = 'inline-flex';
          btn.textContent = 'Place 100 KIBL Bet';
        } finally {
          btn.classList.remove('busy');
        }
      });
    });
  </script>

  <footer class="readout" style="text-align:center; opacity:.9; padding:14px 0 6px;">
    ¬© 2025 KIBL / PixelPup ‚Ä¢ Stay shiny üê∂‚ú® ‚Ä¢
    <a href="tos.html">Terms</a> ‚Ä¢ <a href="privacy.html">Privacy</a> ‚Ä¢ <a href="disclaimer.html">Disclaimer</a>
  </footer>
</body>
</html>
