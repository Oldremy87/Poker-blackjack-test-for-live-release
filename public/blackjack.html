<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PixelPup Blackjack</title>
  <script src="https://hcaptcha.com/1/api.js" async defer></script>
    <script>
  // Make CSRF available to modules early
  (async () => {
    try {
      const r = await fetch('/api/csrf', { credentials: 'include' });
      const j = await r.json();
      window.csrfToken = j.csrfToken;
    } catch {}
  })();
</script>
 

  <style>
      /* ===== Retro PixelPup theme (CSP-safe, no external fonts) ===== */
    :root{
        --ui-scale: 1;        /* user slider 0.8‚Äì1.25 */
       --hand-gap: 10px;
        --card-ratio: 1.6;   /* height = width * ratio; tweak if your art needs */
      --cardW: 100px;    
      --bg: #0b0f19;
      --panel: #111827;
      --text: #00ffc6;
      --text-dim: #7fffe6;
      --accent: #ffcc00;
      --accent-2: #ff3df7;
      --accent-3: #6ae3ff;
      --card-bg: #222638;
      --card-border: #3af5d9;
      --danger: #ff5577;
      --ok: #45ff99;
       --win-cyan:  #3af5d9;
  --win-pink:  #ff3df7;
  --win-gold:  #ffcc00;
    }
    /* Always hide elements with [hidden], and loaders by default */
[hidden] { display: none !important; }
.loading { display: none !important; }     /* stays hidden until .show is added */
.loading.show { display: block !important; }
.hidden { display: none !important; }

/* Visually hidden utility */
.sr-only { 
  position: absolute !important;
  width: 1px; height: 1px; padding: 0; margin: -1px;
  overflow: hidden; clip: rect(0,0,1px,1px); white-space: nowrap; border: 0;
}

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 800px at 50% -20%, #13203b 0%, #0b0f19 60%, #05070d 100%),
        linear-gradient(180deg, #0b0f19 0%, #05070d 100%);
      color: var(--text);
      padding: 24px;
    }
  #toasts {
    position: fixed; top: 12px; right: 12px; z-index: 9999;
    display: flex; flex-direction: column; gap: 8px;
    pointer-events: none;
  }
  .toast {
    pointer-events: auto;
    background: rgba(20,20,20,.92);
    color: #fff; border-radius: 12px; padding: 10px 12px;
    box-shadow: 0 8px 24px rgba(0,0,0,.25);
    font: 600 14px system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    transform: translateY(-6px); opacity: 0;
    transition: transform .18s ease-out, opacity .18s ease-out;
    max-width: 320px; line-height: 1.25;
    border-left: 4px solid #888;
  }
  .toast.show { transform: translateY(0); opacity: 1; }
  .toast.hide { transform: translateX(8px); opacity: 0; }
  .toast.win   { border-left-color: #22c55e; }  /* green */
  .toast.bonus { border-left-color: #06b6d4; }  /* cyan  */
  .toast.error { border-left-color: #ef4444; }  /* red   */

  .toast .close {
    float: right; margin-left: 8px; font-weight: 700; cursor: pointer; opacity: .7;
  }
  .toast .close:hover { opacity: 1; }

  @media (prefers-reduced-motion: reduce) {
    .toast, .toast.show, .toast.hide { transition: none; }
  }
    /* Header / Nav */
    header { display: flex; align-items: center; justify-content: space-between; gap: 16px; margin: 0 auto 16px; max-width: 1100px; }
    .brand { display: flex; align-items: center; gap: 10px; letter-spacing: 0.5px; text-shadow: 0 0 10px rgba(0,255,198,0.6); }
    .brand-badge {
      width: 36px; height: 36px; border-radius: 10px; border: 2px solid var(--card-border);
      box-shadow: 0 0 14px rgba(0,255,198,0.2); display: grid; place-items: center;
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      font-weight: 700; color: var(--accent);
    }
    nav { display: flex; gap: 10px; flex-wrap: wrap; }

    .btn {
      appearance: none; border: 0; cursor: pointer; padding: 10px 14px; border-radius: 12px;
      color: #000; background: var(--accent); text-decoration: none;
      box-shadow: 0 3px 0 #b59000, 0 0 12px rgba(255,204,0,0.35);
      font-weight: 700; letter-spacing: .2px; display: inline-flex; align-items: center; gap: 8px;
      transition: transform .06s ease, filter .12s ease, box-shadow .12s ease;
      font-size: 12px;
    }
    .btn:hover { transform: translateY(-1px); filter: brightness(1.05); }
    .btn:active { transform: translateY(1px); }
    .btn:disabled { background: #555; color: #111; box-shadow: none; cursor: not-allowed; }
    .btn:focus-visible { outline: 2px solid var(--accent-3); outline-offset: 2px; }
    .btn-telegram{
      background: var(--accent-3);
      box-shadow: 0 3px 0 #2aa7bf, 0 0 14px rgba(106,227,255,0.35);
      color: #021018;
    }
    .btn-primary{
      background: var(--accent-2);
      color: #120016;
      box-shadow: 0 3px 0 #a2259c, 0 0 14px rgba(255,61,247,0.35);
    }
    .btn-ghost{
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      color: var(--text);
      border: 1px solid rgba(58,245,217,0.35);
      box-shadow: 0 0 12px rgba(0,255,198,0.18) inset, 0 0 12px rgba(0,255,198,0.12);
    }

    /* Layout panels */
    .wrap { max-width: 1100px; margin: 0 auto; }

/* Stack on tablets/phones */
@media (max-width: 1024px) {
  .hud { grid-template-columns: 1fr; }
  .panel-table, .panel-claim { grid-column: 1; }
}
  .panel {
  /* back to a normal card */
  display: block;
  background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.01));
  border: 1px solid rgba(58,245,217,0.3);
  border-radius: 16px;
  padding: 16px;
  backdrop-filter: blur(4px);
  box-shadow: 0 0 24px rgba(0,255,198,0.06) inset, 0 0 24px rgba(0,255,198,0.08);
}
    .controls { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-top: 8px; }

    .readout { color: var(--text-dim); font-size: 12px; margin: 4px 0; }
    .card {cursor: pointer; user-select: none; }
    /* Hand area (real cards + simulated placeholders share this) */
    .card-hand {
       
       gap: var(--hand-gap);
      display: flex;
      flex-wrap: nowrap;
      justify-content: center;
      align-items: flex-start;
      gap: 10px;
      min-height: 170px;
      margin: 12px auto 0;
      max-width: 1100px;
    }
    /* Card visual */
    /* Card + placeholder sizing and layout */
.card, .placeholder {
  --_w: calc(var(--cardBaseW, var(--cardW)) * var(--ui-scale));
  width: var(--_w);
  height: calc(var(--_w) * var(--card-ratio));         
  border-radius: 10px;
  background: var(--card-bg);
  color: #fff;
  border: 2px solid var(--card-border);
  display: grid;
  grid-template-rows: minmax(0, 1fr) auto auto; /* image shrinks first, label, then button */
  align-items: center;
  justify-items: center;
  padding: 8px;
  overflow: hidden;              /* keeps rounded corners clean */
  position: relative;
  text-align: center;
  box-shadow: 0 0 20px rgba(0,255,198,0.1);
}
body.compact {
  --hand-gap: 8px;
}
/* Dealing placeholders centered and unbroken */
.placeholder {
  display: flex;
  align-items: center;
  justify-content: center;
  border-style: dashed;
  font-size: 12px;
  letter-spacing: .5px;
  color: var(--text-dim);
  animation: pulse .9s ease-in-out infinite alternate;
  white-space: nowrap;           /* never break ‚ÄúDealing...‚Äù into ‚Äú...ling‚Äù */
  padding: 0 6px;
}
.controls { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
.controls .btn { flex: 1 1 180px; }
  @media (max-width: 420px) {
  .controls .btn { flex: 1 1 48%; }
}
.card img {
  width: 100%;
  height: 100%;
  object-fit: contain;
  display: block;
}
@media (max-width: 720px){
  header { flex-direction: column; align-items: stretch; gap: 8px; }
  nav { justify-content: center; }
  .brand h1 { font-size: 1.35rem; }
  body { padding: 12px; }
}
/* Lightweight confetti (optional flair) */
.fx-confetti{ position:fixed; inset:0; pointer-events:none; z-index:9999; overflow:hidden; }
.fx-confetti i{
  position:absolute; top:-12px; left: var(--x,50%);
  width:8px; height:14px; border-radius:2px;
  background: linear-gradient(var(--rot,0deg),
              var(--win-pink), var(--win-gold), var(--win-cyan));
  opacity:.95;
  transform: rotate(var(--rot,0deg));
  animation: arcade-confetti var(--dur,1200ms) ease-out forwards;
}
@keyframes arcade-confetti{
  0%   { transform: translateY(-10px) rotate(var(--rot,0deg)); }
  100% { transform: translateY(calc(100vh + 12px)) rotate(calc(var(--rot,0deg) + 260deg)); opacity:0; }
}
#payoutTotal{ position: relative; display:inline-block; border-radius:12px; padding:2px 6px; }

/* One-shot bling class we add/remove from JS */
.payout-win{
  /* quick pop + glow + sheen */
  animation:
    arcade-pop .18s ease-out,
    arcade-glow 1.2s ease-out;
  filter: saturate(1.2);
}

/* Neon aura behind the text */
.payout-win::before{
  content:"";
  position:absolute; inset:-8px;
  border-radius:14px;
  background: conic-gradient(from 0deg,
    var(--win-pink), var(--win-gold), var(--win-cyan), var(--win-pink));
  filter: blur(14px) opacity(.55);
  z-index:-1;
  animation: arcade-spin 1.1s ease-out both;
}

/* Shiny sweep across the text */
.payout-win::after{
  content:"";
  position:absolute; inset:-2px;
  border-radius:12px;
  background:
    linear-gradient(120deg,
      rgba(255,255,255,0) 0%,
      rgba(255,255,255,.25) 15%,
      rgba(255,255,255,0) 32%);
  transform: translateX(-140%);
  animation: arcade-sheen .9s ease-out .06s forwards;
  pointer-events:none;
}

@keyframes arcade-pop{
  0% { transform: scale(1); }
  70%{ transform: scale(1.08); }
  100%{ transform: scale(1); }
}
@keyframes arcade-glow{
  0%   { box-shadow: 0 0 0 rgba(0,0,0,0); }
  45%  { box-shadow: 0 0 18px rgba(255,61,247,.25), 0 0 32px rgba(58,245,217,.18) inset; }
  100% { box-shadow: 0 0 0 rgba(0,0,0,0); }
}
@keyframes arcade-spin{
  from { transform: rotate(0deg) scale(1.02); }
  to   { transform: rotate(120deg) scale(1); }
}
@keyframes arcade-sheen{
  to { transform: translateX(140%); }
}

/* 2-line clamp for long names like ‚ÄúQueen of Diamonds‚Äù */
.card p {
  margin: 4px 0 0 0;
  font-size: 11px;
  line-height: 1.05;
  padding: 0 4px;
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 2;         /* clamp to 2 lines */
  line-clamp: 2;                 /* standard property for compatibility */
  -webkit-box-orient: vertical;
}

.card button {
  display: none;
  width: 100%;
  min-height: 30px;              /* reliable tap target */
  font-size: 11px;
  padding: 6px 8px;
  border-radius: 8px;
  margin-top: 6px;
  background: var(--accent-2);
  color: #090014;
  box-shadow: 0 2px 0 #a2259c, 0 0 10px rgba(255,61,247,0.35);
}

/* Held badge */
.card.held::after {
  content: 'HELD';
  position: absolute;
  top: 6px; left: 6px;
  font-size: 10px;
  padding: 2px 6px;
  background: var(--accent);
  color: #000;
  border-radius: 6px;
  box-shadow: 0 0 10px rgba(255,204,0,0.4);
}
#bj-panels{
  position: static;                  /* no overlay */
  width: 100%;
  display: grid;
  grid-template-columns: repeat(2, minmax(220px, 1fr));
  gap: .75rem;
  margin-top: .75rem;
  align-items: start;
  grid-column: 1 / 2;                /* ‚Üê force left column of .hud */
  z-index: 1;
}

/* Optional: keep it visible while scrolling on wide screens */
@media (min-width:1025px){
  #bj-panels{ position: sticky; top: 12px; }
}

/* On narrow screens stack them */
@media (max-width:900px){
  #bj-panels{ grid-template-columns: 1fr; }
}



/* Let each dialog expand to its grid column */
.bj-dialog { width: auto; }

.bj-dialog header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: .35rem;
  font-size: 0.95rem;
  letter-spacing: .2px;
}

.bj-dialog .body {
  display: grid;
  gap: .4rem;
}
@media (max-width:900px){
  #bj-panels { grid-template-columns: 1fr; }
}

.bj-dialog footer {
  margin-top: .35rem;
  font-size: .8rem;
}

.muted { color: #aab0ffb0; }

#playerTotals, #dealerTotals {
  font-size: 1.05rem;
  font-weight: 600;
}

#playerCards, #dealerCards {
  display: flex;
  flex-wrap: wrap;
  gap: .35rem .45rem;
}

.cardchip {
  border: 1px solid #3a3f7d;
  background: #171b35;
  padding: .25rem .5rem;
  border-radius: 10px;
  font-size: .85rem;
}

.chip {
  display: inline-block;
  padding: .18rem .5rem;
  border-radius: 999px;
  font-size: .75rem;
  border: 1px solid transparent;
}
.chip.win   { background: #123e22; color: #c0ffd7; border-color: #1f6a3a; }
.chip.loss  { background: #3e1212; color: #ffd0d0; border-color: #6a1f1f; }
.chip.push  { background: #3b3b3b; color: #f1f1f1; border-color: #646464; }
.chip.play  { background: #122a3e; color: #cfe8ff; border-color: #1f476a; }
.chip.bj    { background: #262051; color: #e3d7ff; border-color: #4b409a; }

.handline {
  display: flex;
  align-items: baseline;
  gap: .5rem;
}
.handline .idx {
  width: 1.15rem;
  text-align: right;
  color: #aab0ffb0;
  font-size: .8rem;
}
.softflag {
  font-size: .8rem;
  opacity: .8;
  margin-left: .25rem;
}
.activeHand { outline: 1px dashed #6ea8ff; outline-offset: 6px; border-radius: 12px; padding: .2rem .3rem; }


@media (max-width: 600px) {
  .card, .placeholder { width: 80px; height: 138px; }
  .card p { font-size: 10px; }
  .card button { min-height: 28px; font-size: 10px; }
  .card-hand { min-height: 140px; }
}
/* Age gate: focus ring for accessibility */
#ageGate :focus-visible { outline: 2px solid var(--accent-3); outline-offset: 2px; }

/* Reduce panel text width for readability on narrow screens */
@media (max-width: 420px){
  #ageGate .brand h1{ font-size: 1.2rem; }
}



    h1 { margin: 0 0 10px; }
        .faucet-form { display: grid; gap: 10px; }
    .field { display: grid; gap: 6px; }
    label { color: var(--text-dim); font-size: 14px; }
    input[type="text"]{
      width: 100%; padding: 12px 14px; border-radius: 12px; border: 1px solid rgba(58,245,217,0.35);
      background: #0f1425; color: var(--text);
      box-shadow: inset 0 0 14px rgba(0,255,198,0.08);
    }

    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }

    .status {
      padding: 10px 12px; border-radius: 12px;
      background: #0f1425; border: 1px solid rgba(58,245,217,0.25);
      color: var(--text-dim);
    }
    .status.ok { border-color: rgba(69,255,153,0.6); color: var(--ok); }
    .status.err { border-color: rgba(255,85,119,0.65); color: var(--danger); }

    footer { opacity: .9; color: var(--text-dim); font-size: 12px; text-align: center; padding: 14px 0 6px; }

.card-hand {
  min-height: 220px;
  margin-top: 16px;
}
@media (min-width: 900px) {
  .card, .placeholder { width: 120px; height: 196px; }
  .card-hand { min-height: 240px; }
}
/* Keep claim pieces tidy */
.claim-block { margin-top: 12px; }
#leaderboardList{ list-style:none; padding:0; margin:0; }
#leaderboardList li{ display:flex; align-items:center; gap:.75rem; padding:.25rem 0; }
#leaderboardList .who{ min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
#leaderboardList .pts{ margin-left:auto; }
#leaderboardList li.you{ font-weight:700; }
/* HUD: desktop = 2 cols, mobile = stacked */
.hud {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 12px;
}
.panel-table { grid-column: 1 / 2; }
.panel-claim { grid-column: 2 / 3; }

@media (max-width: 1024px) {
  .hud { grid-template-columns: 1fr; }
  .panel-table, .panel-claim { grid-column: 1 / -1; }  /* <‚Äî ensures stacking */
}
.callout{
  margin: 8px 0 12px;
  padding: 10px 12px;
  border-radius: 12px;
  background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
  border: 1px solid rgba(58,245,217,0.45);
  box-shadow: 0 0 18px rgba(0,255,198,0.12) inset, 0 8px 22px rgba(0,0,0,0.25);
  font-size: 13px; line-height: 1.25;
}
.callout strong{ color: var(--accent); margin-right: 6px; }
.callout .close{
  float: right; border: 0; background: transparent; color: var(--text);
  font-weight: 800; cursor: pointer; opacity: .8;
}
.callout .close:hover{ opacity: 1; }
.age-gate{
  position: fixed; inset: 0; z-index: 10000;
  display: grid; place-items: center;
  background: rgba(5,7,13,.88);
  backdrop-filter: blur(3px);
}
.age-card{
  width: min(92vw, 420px);
  background: var(--panel);
  color: var(--text);
  border: 1px solid rgba(58,245,217,.35);
  border-radius: 16px;
  padding: 16px;
  box-shadow: 0 12px 32px rgba(0,0,0,.4), 0 0 24px rgba(0,255,198,.08) inset;
}
@media (prefers-reduced-motion: no-preference){
  .age-card{ transform: translateY(6px); opacity:.98; animation: agIn .18s ease-out forwards; }
  @keyframes agIn{ to{ transform: none; opacity:1; } }
}
.modal { position:fixed; inset:0; background:rgba(0,0,0,.6); display:flex; align-items:center; justify-content:center; z-index:9999; }
.modal-content { background:#111; color:#fff; padding:1.25rem; max-width:600px; border-radius:14px; }
.modal-content h2 { margin-top:0 }
@keyframes pulse {
  0% { transform:scale(1); }
  30% { transform:scale(1.08); }
  100% { transform:scale(1); }
}
.payout-pulse { animation: pulse 450ms ease-out; }
/* You already have this line in your file, keep it: */
/* #ageGate :focus-visible { outline: 2px solid var(--accent-3); outline-offset: 2px; } */
.hud{
  display: grid;
  grid-template-columns: minmax(0, 2fr) minmax(320px, 1fr);
  gap: 16px;
  align-items: start;
}
.panel-table { grid-column: 1; }
.panel-claim { grid-column: 2; }

/* Stack cleanly on tablets/phones */
@media (max-width: 1024px){
  .hud { grid-template-columns: 1fr; }
  .panel-table, .panel-claim { grid-column: 1 / -1; }
}
@media (min-width:1025px){
  #bj-panels{ grid-column: 2; position: sticky; top: 12px; }
}
/* Register a custom angle for spinning borders (safe in modern browsers) */
@property --spin { syntax: "<angle>"; inherits: false; initial-value: 0deg; }

/* Base look for the payout chip */
#payoutTotal{
  display: inline-block;
  padding: 6px 10px;
  border-radius: 12px;
  position: relative;
  background: #0f1425;
  border: 1px solid rgba(58,245,217,.35);
  transition: transform .15s ease, box-shadow .15s ease, filter .15s ease;
}

/* Win pulse: rainbow border + neon glow + bounce */
#payoutTotal.payout-pulse{
  border: 2px solid transparent;
  background:
    linear-gradient(#0f1425, #0f1425) padding-box,
    conic-gradient(from var(--spin),
      #00ffc6, #ffcc00, #ff3df7, #6ae3ff, #00ffc6) border-box;
  color: #ffffff;
  text-shadow:
    0 0 6px #00ffc6,
    0 0 10px #ff3df7,
    0 0 16px #ffcc00;
  box-shadow:
    0 0 18px rgba(0,255,198,.35),
    0 0 28px rgba(255,61,247,.25),
    0 0 40px rgba(255,204,0,.18);
  animation:
    payoutBounce .9s cubic-bezier(.2,1.4,.2,1) 1,
    payoutGlow .9s ease-out 1,
    payoutSpin 1.2s linear 1;
  will-change: transform, box-shadow, filter;
}

@keyframes payoutBounce{
  0%   { transform: scale(1); }
  35%  { transform: scale(1.18) rotate(-0.8deg); }
  65%  { transform: scale(1.10) rotate(0.6deg); }
  100% { transform: scale(1); }
}

@keyframes payoutGlow{
  0%   { filter: saturate(1) brightness(1); }
  40%  { filter: saturate(1.6) brightness(1.25); }
  100% { filter: saturate(1) brightness(1); }
}

@keyframes payoutSpin{
  to { --spin: 360deg; }
}

/* Respect reduced motion */
@media (prefers-reduced-motion: reduce){
  #payoutTotal.payout-pulse{
    animation: none;
    box-shadow: 0 0 18px rgba(0,255,198,.35);
  }
}
#bjPlayer {
  display: flex;              /* still flex, but vertical */
  flex-direction: column;     /* stack rows */
  align-items: center;        /* center the rows */
  gap: var(--hand-gap);
}

/* each row of cards */
#bjPlayer .hand-row {
  display: flex;
  gap: var(--hand-gap);
}
#bjStatus:empty,
#playerFooter:empty,
#dealerFooter:empty {
  display: none !important;
}

  </style>
</head>
<body> 
<!-- Age gate -->
<div id="ageGate" class="age-gate" role="dialog" aria-modal="true" aria-labelledby="ageTitle" hidden>
  <div class="age-card" role="document">
    <h2 id="ageTitle" style="margin:0 0 8px">Are you 18 or older?</h2>
    <p class="readout" style="margin:0 0 12px">
      PixelPup Blackjack is for adults. Please confirm your age to continue.
    </p>
    <div class="controls" style="margin-top:6px">
      <button id="ageYes" class="btn btn-primary">Yes, enter</button>
      <a id="ageNo" class="btn btn-ghost" href="/">No, take me back</a>
    </div>
  </div>
</div>
<script>
  function fitHandToWidth() {
    const hand = document.getElementById('hand');
    if (!hand) return;

    // How wide is the hand area?
    const styles = getComputedStyle(hand);
    const gap = parseFloat(styles.gap || styles.columnGap || 10) || 10;
    const cards = 2, gaps = cards - 1;

    const available = hand.clientWidth; // visible width
    // space for 5 cards + 4 gaps
    const perCard = (available - gap * gaps) / cards;

    // clamp so it looks good everywhere
    const cardW = Math.max(58, Math.min(perCard, 130));

    document.documentElement.style.setProperty('--cardW', cardW + 'px');
  }
  </script>
    
    <header>
    <nav>
  <a class="btn btn-telegram" href="https://t.me/NexaKennelKlub" target="_blank" rel="noopener noreferrer">
    <!-- Telegram SVG -->
    <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" style="width:18px;height:18px;margin-right:6px;">
      <path fill="#1C93E3" d="M12 0a12 12 0 1 0 0 24A12 12 0 0 0 12 0z"/>
      <path fill="#fff" d="M17.9 7.4c.2-1-.8-1.3-1.6-1l-11 4.2c-.7.3-.7.8-.1 1l2.8.9 6.5-4.1c.3-.2.6-.1.4.1l-5.3 4.9-.2 3.1c.5 0 .7-.2 1-.5l1.7-1.6 2.6 1.9c.6.3 1 .1 1.1-.6l1.9-9.3z"/>
    </svg>
    Join Telegram
  </a>

  <a class="btn btn-ghost" href="https://x.com/Oldremy" target="_blank" rel="noopener noreferrer">
    <!-- X SVG -->
    <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" style="width:18px;height:18px;margin-right:6px;">
      <path fill="currentColor" d="M18.9 2H22l-7.7 8.8L22.7 22h-7.1l-5.5-7.3L3.8 22H1l8.4-9.6L1 2h7.2l5 6.7L18.9 2zM17.6 20h1.9L7.4 4H5.6l12 16z"/>
    </svg>
    @Oldremy
  </a>

  <a class="btn btn-ghost" href="https://x.com/NexaKennelKlub" target="_blank" rel="noopener noreferrer">
    <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" style="width:18px;height:18px;margin-right:6px;">
      <path fill="currentColor" d="M18.9 2H22l-7.7 8.8L22.7 22h-7.1l-5.5-7.3L3.8 22H1l8.4-9.6L1 2h7.2l5 6.7L18.9 2zM17.6 20h1.9L7.4 4H5.6l12 16z"/>
    </svg>
    @NexaKennelKlub
  </a>
      <a class="btn btn-ghost kk-home" href="/" aria-label="Go to Home">üè† Home</a>
  <a class="btn btn-primary" href="/play.html" aria-current="page">Play Poker</a>
  <a class = "btn btn-ghost" href="/connect.html" aria-current="page">Connect Wallet</a>
</nav>
   <div class="brand">
      <div class="brand-badge">KK</div>
      <h1>PixelPup BlackJack</h1>
    </div>
</header>
  <div class="wrap">
    <div class="hud">
     <div class="panel panel-table" id="bjPanel">
        <h1>Blackjack</h1>
     <div id="bjHowto" class="modal" style="display:none">
  <div class="modal-content">
    <h2>How to Play Blackjack (PixelPup)</h2>
    <ul>
      <li>Goal: beat dealer without going over 21.</li>
      <li>Face cards = 10, Aces = 1 or 11.</li>
      <li>Natural Blackjack (Ace + 10-value on deal) auto-wins.</li>
      <li>Actions: Hit, Stand, Double (draw 1 then stand), Split (one split, pairs only).</li>
      <li>Points/KIBL: Win = +3 credits; Natural BJ = +6; Double win adds +2; Split wins slightly reduced. No wagering.</li>
      <li>Fairness: provably fair deck (commit-reveal). See ‚ÄúFairness‚Äù in menu.</li>
      <li>Limits: we pace play to keep it fair for everyone.</li>
    </ul>
    <button id="bjHowtoClose">Let‚Äôs play</button>
  </div>
   </div>
         <p id="userTag" class="readout"></p>
         <a class="btn btn-ghost" href="bjachievements.html">Achievements</a>
         <a class="btn btn-ghost" href="bjpoints.html">Points</a>
        <button id="dailyReward" class="btn btn-ghost">Claim Daily Reward</button>
        
  
        
        <p id="bjFair" class="readout"></p>
         
        <div class="readout">Dealer</div>
        <div id="bjDealer" class="card-hand" aria-live="polite"></div>

        <div class="readout">You</div>
        <p id="payoutTotal">Total Payout: 0 KIBL</p>
     <p id="kiblBalance">KIBL: ‚Äî</p>
     <p id="nexaBalance">NEXA: ‚Äî</p>
        <div id="bjPlayer" class="card-hand" aria-live="polite"></div>

        <div class="controls">
          <button id="betBtn" class="btn">Place 100 KIBL bet</button>
          
          <button id="bjStart"  class="btn btn-primary">Feed the dealer</button>
          <button id="bjHit"    class="btn" disabled>Hit</button>
          <button id="bjStand"  class="btn" disabled>Stand</button>
         <button id="bjDoubleBtn" class="btn" disabled>Double</button>
          <button id="bjSplitBtn"  class="btn" disabled>Split</button>
        
        </div>
        <!-- Blackjack Totals Panels -->
<div id="bj-panels" aria-live="polite">
  <div id="playerPanel" class="bj-dialog">
    <header>
      <strong>Your Hand</strong>
      <span id="playerStatus" class="chip"></span>
    </header>
    <div class="body">
      <div id="playerTotals"></div>
      <div id="playerCards"></div>
    </div>
    <footer id="playerFooter" class="muted"></footer>
  </div>

  <div id="dealerPanel" class="bj-dialog">
    <header>
      <strong>Dealer</strong>
      <span id="dealerStatus" class="chip"></span>
    </header>
    <div class="body">
      <div id="dealerTotals"></div>
      <div id="dealerCards"></div>
    </div>
    <footer id="dealerFooter" class="muted"></footer>
  
      <div id="bjStatus" class="muted"></div>
       
      </div>

 
</div>

<section class="panel claim-block" style="margin-top:10px;">
   </div>
  <section class="panel" style="margin-top:10px;">
    <h2>Season Points Window (Skill Points)</h2>
    <ol id="leaderboardList" class="leaderboard"></ol>
    <div class="readout" id="lbHint" style="margin-top:6px;"></div>
    <a class="btn btn-ghost" href="/leaderboard.html?game=blackjack">See full leaderboard ‚Üí</a>
    <h2>Claim</h2>
    <a href="claim.html" class="btn btn-primary" style="width:100%; text-align:center;">
      FEED ME! üêæ
    </a>
     
    </div>
  </section>
  
</div>

    
</div>
        

  <audio id="feedSound" src="dogfood.mp3" preload="auto"></audio>

  
<script>
  // 1. GLOBAL CONFIG & BUTTON DEFINITIONS (Run immediately)
  window.KIBL_TOKEN_ID_HEX = "656bfefce8a0885acba5c809c5afcfbfa62589417d84d54108e6bb42a6f30000";
  
  const API = Object.freeze({
    profile:'/api/profile', daily:'/api/daily-reward', payout:'/api/payout',
    bj: { start:'/api/bj/start', hit:'/api/bj/hit', stand:'/api/bj/stand', double:'/api/bj/double', split:'/api/bj/split' }
  });

  // Define Elements Safely
  const els = {
    deal: document.getElementById('bjStart'),
    hit: document.getElementById('bjHit'),
    stand: document.getElementById('bjStand'),
    double: document.getElementById('bjDoubleBtn'),
    split: document.getElementById('bjSplitBtn'),
    msg: document.getElementById('bjStatus'),
    dealer: document.getElementById('bjDealer'),
    player: document.getElementById('bjPlayer'),
    fair: document.getElementById('bjFair'),
    payout: document.getElementById('payoutTotal'),
    payoutBtn: document.getElementById('ClaimPayout'),
    address: document.getElementById('addressInput'),
    daily: document.getElementById('dailyReward'),
    loading: document.getElementById('loading')
  };

  let __csrf = null;
  let totalPayout = 0;

  // --- 2. HELPERS ---
  async function fetchCsrf(){
    try {
        const r = await fetch('/api/csrf', { credentials:'include' });
        if (!r.ok) throw new Error('CSRF bootstrap failed');
        const { csrfToken } = await r.json();
        __csrf = csrfToken;
        window.csrfToken = csrfToken;
    } catch (e) { console.error("CSRF Error", e); }
  }

  async function postWithCsrf(input, init = {}) {
    if (!__csrf) await fetchCsrf();
    const baseHeaders = init.headers ? {...init.headers} : {};
    if (!baseHeaders['Content-Type']) baseHeaders['Content-Type'] = 'application/json';
    
    const makeReq = async () => fetch(input, {
      ...init, method: init.method || 'POST', credentials: 'include',
      headers: { 'x-csrf-token': __csrf, ...baseHeaders }
    });

    let resp = await makeReq();
    if (resp.status === 403) {
      await fetchCsrf();
      resp = await makeReq();
    }
    return resp.json();
  }

  // --- 3. UI FUNCTIONS ---
  function applyBJCan(can = {}) {
    if (els.hit)    els.hit.disabled    = !(can.hit ?? true);
    if (els.stand)  els.stand.disabled  = !(can.stand ?? true);
    if (els.double) els.double.disabled = !(can.double ?? false);
    
    const allowSplit = !!(can.split);
    if (els.split) {
      els.split.disabled = !allowSplit;
      if (allowSplit) els.split.classList.remove('hidden');
      else els.split.classList.add('hidden');
    }
  }

  function setButtons({ deal, hit, stand }) {
    if (els.deal && deal !== undefined) els.deal.disabled = !deal;
    if (els.hit  && hit  !== undefined) els.hit.disabled  = !hit;
    if (els.stand && stand !== undefined) els.stand.disabled = !stand;
  }

  function fitBjToScreen(){
    const panel = document.getElementById('bjPanel');
    if (!panel) return;
    const gap = 10;
    const dealerCount = document.querySelectorAll('#bjDealer .card').length || 2;
    const rowCounts = Array.from(document.querySelectorAll('#bjPlayer .hand-row')).map(r => r.querySelectorAll('.card').length);
    const n = Math.max(dealerCount, ...(rowCounts.length ? rowCounts : [2]));
    const available = panel.clientWidth - 32;
    const perCard = (available - gap * (n - 1)) / n;
    const base = Math.max(64, Math.min(perCard, 136)); 
    document.documentElement.style.setProperty('--cardBaseW', base + 'px');
  }

  function renderCard(c, hidden=false) {
    const d = document.createElement('div'); d.className='card';
    const i = document.createElement('img');
    i.src = hidden ? 'cards/card-back.png' : `cards/${c.filename}`;
    d.appendChild(i);
    return d;
  }

  function renderHands({ dealer, player }) {
    if (els.dealer) {
        els.dealer.innerHTML = '';
        if (dealer.full) dealer.full.forEach(c => els.dealer.appendChild(renderCard(c)));
        else {
          els.dealer.appendChild(renderCard(dealer.up));
          els.dealer.appendChild(renderCard(dealer.up, true));
        }
    }
    
    if (els.player) {
        els.player.innerHTML = '';
        (player || []).forEach(h => {
          const row = document.createElement('div'); row.className='hand-row';
          (h.cards || []).forEach(c => row.appendChild(renderCard(c)));
          els.player.appendChild(row);
        });
    }
    fitBjToScreen();
  }

  // --- 4. GAME ACTIONS ---
  async function startRound() {
    try {
      const d = await postWithCsrf(API.bj.start);
      if (!d.ok) throw new Error(d.error || 'Start failed');
      
      if (d.fair?.commit && els.fair) els.fair.textContent = `Commit: ${d.fair.commit.slice(0,10)}...`;

      // Render initial state
      renderHands({ dealer: d.dealer, player: [{ cards: d.player }] });
      updateBjPanels(d);
      
      if (d.settled) {
        afterActionSnapshot(d); // Handles Natural BJ
      } else {
        applyBJCan(d.can);
        if (els.msg) els.msg.textContent = 'Your move.';
        // Disable Start button during play
        if (els.deal) els.deal.disabled = true;
      }
    } catch (e) {
      alert(e.message);
    }
  }

  async function hit() { action(API.bj.hit); }
  async function stand() { 
      // Manually disable buttons to prevent double-click crash
      if (els.hit) els.hit.disabled = true;
      if (els.stand) els.stand.disabled = true;
      action(API.bj.stand); 
  }
  async function doubleDown() { action(API.bj.double); }
  async function split() { action(API.bj.split); }

  async function action(url) {
    try {
      const d = await postWithCsrf(url);
      if (!d.ok) throw new Error(d.error);
      afterActionSnapshot(d);
    } catch (e) {
      console.error(e);
      // Re-enable on error so user isn't stuck
      if (els.hit) els.hit.disabled = false;
      if (els.stand) els.stand.disabled = false;
    }
  }

  function afterActionSnapshot(d) {
    const dealer = d.dealer.full ? d.dealer : d.dealer;
    renderHands({ dealer, player: d.players });
    updateBjPanels(d);
    
    if (d.settled) {
      // Game Over
      applyBJCan({ hit:false, stand:false, double:false, split:false });
      
      const res = Array.isArray(d.results) && d.results[0]?.result;
      if (els.msg) {
          els.msg.textContent = res === 'bj' ? 'Blackjack!' : 
                                res === 'win' ? 'You Win!' : 
                                res === 'push' ? 'Push' : 'Round Over';
      }

      announceAndRefresh(d);

      // --- CRITICAL BRIDGE ---
      // This forces the Bet Button to reappear in the bottom script
      if (window.onGameSettled) window.onGameSettled(); 
      
    } else {
      // Game Continues
      applyBJCan(d.can || { hit:true, stand:true, double:false, split:false });
    }
  }

  // --- 5. PANELS & EXTRAS ---
  function bjScore(cards) {
      let total = 0, aces = 0;
      for (const c of (cards||[])) {
          const r = c.rank;
          if (r === 'Ace') { total += 11; aces++; }
          else if (['King','Queen','Jack'].includes(r)) total += 10;
          else total += Number(r) || 0;
      }
      while (total > 21 && aces > 0) { total -= 10; aces--; }
      return { total, soft: aces > 0 };
  }

  function updateBjPanels(data) {
      const pTotalsEl = document.getElementById('playerTotals');
      const hands = data.players || (data.player ? [{cards:data.player}] : []);
      if(hands.length && pTotalsEl) {
          pTotalsEl.innerHTML = hands.map((h,i) => `<div>Hand ${i+1}: <strong>${bjScore(h.cards).total}</strong></div>`).join('');
      }
      const dTotalsEl = document.getElementById('dealerTotals');
      if(data.dealer && dTotalsEl) {
          const cards = data.dealer.full || (data.dealer.up ? [data.dealer.up] : []);
          dTotalsEl.innerHTML = `<div>Total: <strong>${bjScore(cards).total}</strong></div>`;
      }
  }

  // --- 6. INIT LISTENERS (Check existence first) ---
  if(els.hit) els.hit.addEventListener('click', hit);
  if(els.stand) els.stand.addEventListener('click', stand);
  if(els.double) els.double.addEventListener('click', doubleDown);
  if(els.split) els.split.addEventListener('click', split);
  if(els.daily) els.daily.addEventListener('click', async () => {
     const d = await postWithCsrf(API.daily);
     if(d.ok) alert(`Reward: ${d.credit/100} KIBL`);
     else alert(d.error || 'Failed');
  });

  // Global Exports for Module Script
  window.startRound = startRound;
  window.loadWalletBalances = async (addr) => {
        try {
            const r = await fetch(`/api/wallet/balance?address=${encodeURIComponent(addr)}`);
            const j = await r.json();
            if(j.ok) {
                document.getElementById('kiblBalance').textContent = `KIBL: ${j.kibl}`;
                document.getElementById('nexaBalance').textContent = `NEXA: ${j.nexa}`;
            }
        } catch {}
  };
</script>
<script type="module">
  import { placeBet } from '/assets/walletBet.bundle.js';
  import { getSigner } from "/assets/wallet-modal.js?v=Christmas";
  window.placeBet = placeBet;

  // 1. BRIDGE: Called by Game Logic when round ends (Win/Loss/BJ)
  window.onGameSettled = async () => {
      const btn = document.getElementById('betBtn');
      // Show button immediately
      if (btn) {
          btn.style.display = 'inline-flex';
          btn.disabled = false;
          btn.textContent = 'Place 100 KIBL Bet';
      }
      // Refresh balance
      const linked = await fetch('/api/wallet/status').then(r=>r.json()).catch(()=>({}));
      if (linked?.address && window.loadWalletBalances) {
          window.loadWalletBalances(linked.address);
      }
  };

  // 2. SETUP
  async function fetchCsrf() {
    try {
      const r = await fetch('/api/csrf', { credentials: 'include' });
      const j = await r.json();
      window.csrfToken = j.csrfToken;
    } catch (e) { console.error("CSRF Init Failed", e); }
  }

  async function ensureLinked() {
    const r = await fetch('/api/wallet/status', { credentials: 'include' });
    const j = await r.json().catch(() => null);
    return j?.ok && j.linked ? j : null;
  }

  addEventListener('DOMContentLoaded', async () => {
    await fetchCsrf();
    const linked = await ensureLinked();
    const btn = document.getElementById('betBtn');
    const oldStart = document.getElementById('bjStart');
    
    if (oldStart) oldStart.style.display = 'none';

    if (btn) {
      btn.disabled = !linked;
      btn.textContent = linked ? 'Place 100 KIBL Bet' : 'Connect Wallet to Play';
      if (!linked) {
         btn.onclick = () => window.location.href = '/connect.html';
         return; 
      }
    }

    if (linked?.address && window.loadWalletBalances) {
      window.loadWalletBalances(linked.address);
    }

    btn?.addEventListener('click', async () => {
      if (btn.classList.contains('busy')) return;

      try {
        btn.classList.add('busy');
        btn.textContent = 'Unlocking...';
        const pass = await getSigner();
        
        btn.textContent = 'Signing...';
        const { txId } = await placeBet({
          passphrase: pass,
          kiblAmount: 100000, 
          tokenIdHex: window.KIBL_TOKEN_ID_HEX,
          feeNexa: 600
        });

        if (window.toast) window.toast(`Bet sent!`, { type: 'win' });
        
        // Hide button BEFORE starting game to prevent race conditions
        btn.style.display = 'none';

        await window.startRound(); 

      } catch (e) {
        if (e.message !== 'Cancelled') {
           if(window.toast) window.toast(`Bet failed: ${e.message}`, { type: 'error' });
           else alert(e.message);
        }
        // Restore button on error
        btn.style.display = 'inline-flex';
        btn.textContent = 'Place 100 KIBL Bet';
        btn.disabled = false;
      } finally {
        btn.classList.remove('busy');
      }
    });
  });
</script>

  <footer class="readout" style="text-align:center; opacity:.9; padding:14px 0 6px;">
    ¬© 2025 KIBL / PixelPup ‚Ä¢ Stay shiny üê∂‚ú® ‚Ä¢
    <a href="tos.html">Terms</a> ‚Ä¢ <a href="privacy.html">Privacy</a> ‚Ä¢ <a href="disclaimer.html">Disclaimer</a>
  </footer>
</body>
</html>
