<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PixelPup Blackjack</title>
  <script src="https://hcaptcha.com/1/api.js" async defer></script>
  
  <style>
    /* ===== Retro PixelPup theme ===== */
    :root{
      --ui-scale: 1;
      --hand-gap: 10px;
      --card-ratio: 1.6;
      --cardW: 100px;    
      --bg: #0b0f19;
      --panel: #111827;
      --text: #00ffc6;
      --text-dim: #7fffe6;
      --accent: #ffcc00;
      --accent-2: #ff3df7;
      --accent-3: #6ae3ff;
      --card-bg: #222638;
      --card-border: #3af5d9;
      --danger: #ff5577;
      --ok: #45ff99;
      --win-cyan:  #3af5d9;
      --win-pink:  #ff3df7;
      --win-gold:  #ffcc00;
    }

    [hidden] { display: none !important; }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 800px at 50% -20%, #13203b 0%, #0b0f19 60%, #05070d 100%),
        linear-gradient(180deg, #0b0f19 0%, #05070d 100%);
      color: var(--text);
      padding: 24px;
    }

    /* --- LAYOUT GRID FIX --- */
    .wrap { max-width: 1100px; margin: 0 auto; }
    
    .hud {
      display: grid;
      grid-template-columns: 2fr 1fr; /* 2/3 Game, 1/3 Claim */
      gap: 20px;
      align-items: start; /* Prevents stretching */
    }

    .panel-table { grid-column: 1 / 2; }
    
    /* Make the right panel sticky so it doesn't leave empty space */
    .panel-claim { 
      grid-column: 2 / 3; 
      position: sticky;
      top: 20px;
      z-index: 10;
    }

    @media (max-width: 900px) {
      .hud { grid-template-columns: 1fr; }
      .panel-table, .panel-claim { 
        grid-column: 1 / -1; 
        position: static; /* Disable sticky on mobile */
      }
    }

    /* Panels */
    .panel {
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.01));
      border: 1px solid rgba(58,245,217,0.3);
      border-radius: 16px;
      padding: 20px;
      backdrop-filter: blur(4px);
      box-shadow: 0 0 24px rgba(0,255,198,0.06) inset;
    }

    /* Header & Nav */
    header { display: flex; align-items: center; justify-content: space-between; gap: 16px; margin: 0 auto 24px; max-width: 1100px; }
    .brand { display: flex; align-items: center; gap: 10px; }
    .brand h1 { margin: 0; font-size: 1.4rem; color: #fff; text-shadow: 0 0 10px rgba(0,255,198,0.5); }
    .brand-badge {
      width: 36px; height: 36px; border-radius: 10px; border: 2px solid var(--card-border);
      display: grid; place-items: center; font-weight: 700; color: var(--accent);
      background: rgba(255,255,255,0.05);
    }
    nav { display: flex; gap: 10px; flex-wrap: wrap; }

    /* Buttons */
    .btn {
      appearance: none; border: 0; cursor: pointer; padding: 10px 14px; border-radius: 12px;
      color: #000; background: var(--accent); font-weight: 700; text-decoration: none;
      display: inline-flex; align-items: center; gap: 8px; font-size: 13px;
      transition: transform 0.1s, filter 0.1s;
    }
    .btn:hover { transform: translateY(-1px); filter: brightness(1.1); }
    .btn:active { transform: translateY(1px); }
    .btn:disabled { background: #444; color: #888; cursor: not-allowed; transform: none; }
    
    .btn-telegram { background: var(--accent-3); color: #021018; }
    .btn-primary { background: var(--accent-2); color: #120016; }
    .btn-ghost { 
      background: rgba(255,255,255,0.05); color: var(--text); 
      border: 1px solid rgba(58,245,217,0.3); 
    }

    /* Cards */
    .card-hand {
      display: flex; gap: var(--hand-gap); flex-wrap: wrap;
      min-height: 160px; margin: 12px 0;
    }
    .card, .placeholder {
      --_w: calc(var(--cardW) * var(--ui-scale));
      width: var(--_w); height: calc(var(--_w) * var(--card-ratio));
      border-radius: 8px; background: var(--card-bg); border: 2px solid var(--card-border);
      position: relative; display: grid; place-items: center;
    }
    .card img { width: 100%; height: 100%; object-fit: contain; }
    
    /* Stats & Readouts */
    .readout { color: var(--text-dim); font-size: 13px; margin: 4px 0; }
    .controls { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 16px; }
    
    /* Toast */
    #toasts { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
    .toast { 
      background: rgba(10,10,15,0.95); color: #fff; padding: 12px 16px; border-radius: 8px; 
      border-left: 4px solid #888; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      animation: slideIn 0.3s ease-out;
    }
    .toast.win { border-left-color: var(--ok); }
    .toast.error { border-left-color: var(--danger); }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } }

    /* New Modal Styles */
    .smart-modal {
      position: fixed; inset: 0; z-index: 10000;
      display: grid; place-items: center;
      background: rgba(5,7,13,.92); backdrop-filter: blur(5px);
      opacity: 0; pointer-events: none; transition: opacity 0.2s;
    }
    .smart-modal.active { opacity: 1; pointer-events: auto; }
    .smart-modal-card {
      width: min(90vw, 500px); background: var(--panel); border: 1px solid var(--card-border);
      border-radius: 16px; overflow: hidden; transform: translateY(10px); transition: transform 0.2s;
    }
    .smart-modal.active .smart-modal-card { transform: translateY(0); }
    .smart-modal-header { padding: 16px 20px; border-bottom: 1px solid rgba(58,245,217,0.2); display: flex; justify-content: space-between; }
    .smart-modal-body { padding: 20px; color: var(--text); }
    .smart-modal-footer { padding: 16px; background: rgba(0,0,0,0.2); display: flex; justify-content: flex-end; gap: 10px; }
    .address-box { background: #000; padding: 10px; border-radius: 8px; font-family: monospace; border: 1px dashed var(--accent-3); cursor: pointer; }

    /* Stats Panels */
    #bj-panels { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
    .bj-dialog { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 12px; }
    .bj-dialog header { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 8px; }
    .chip { padding: 2px 8px; border-radius: 12px; font-size: 11px; background: #333; }
    .chip.win { background: #123e22; color: #45ff99; }
    .chip.loss { background: #3e1212; color: #ff5577; }
    .chip.play { background: #122a3e; color: #6ae3ff; }
  </style>
</head>
<body>

<header>
  <nav>
    <a class="btn btn-telegram" href="https://t.me/NexaKennelKlub" target="_blank">Telegram</a>
    <a class="btn btn-ghost" href="https://x.com/Oldremy" target="_blank">@Oldremy</a>
    <a class="btn btn-ghost" href="/">üè† Home</a>
    <a class="btn btn-primary" href="/play.html">Play Poker</a>
    <a id="navConnect" class="btn btn-ghost" href="/connect.html">Connect Wallet</a>
  </nav>
  <div class="brand">
    <div class="brand-badge">KK</div>
    <h1>PixelPup BlackJack</h1>
  </div>
</header>

<div class="wrap">
  <div class="hud">
    
    <div class="panel panel-table" id="bjPanel">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h1>Blackjack</h1>
        <p id="userTag" class="readout" style="margin:0;"></p>
      </div>

      <div class="controls" style="justify-content: flex-start; margin-bottom:16px;">
        <a class="btn btn-ghost" href="bjachievements.html">Achievements</a>
        <a class="btn btn-ghost" href="bjpoints.html">Points</a>
      </div>

      <div class="readout">Dealer</div>
      <div id="bjDealer" class="card-hand" aria-live="polite"></div>

      <div class="readout" style="margin-top:16px;">You</div>
      <div id="bjPlayer" class="card-hand" aria-live="polite"></div>

      <p id="bjFair" class="readout" style="font-size:10px; opacity:0.7; margin-top:8px;"></p>

      <div class="controls" style="margin-top:20px;">
        <button id="betBtn" class="btn">Place 100 KIBL bet</button>
        <button id="bjStart" class="btn btn-primary">Feed the dealer</button>
        <button id="bjHit" class="btn" disabled>Hit</button>
        <button id="bjStand" class="btn" disabled>Stand</button>
        <button id="bjDoubleBtn" class="btn" disabled>Double</button>
        <button id="bjSplitBtn" class="btn" disabled>Split</button>
      </div>

      <div style="margin-top: 20px; padding: 12px; background: rgba(0,0,0,0.3); border-radius: 12px;">
        <p id="payoutTotal" style="margin:0 0 4px; color: var(--accent);">Total Payout: 0 KIBL</p>
        <div style="display:flex; gap: 16px; font-family: monospace; color: var(--text-dim);">
          <span id="kiblBalance">KIBL: Loading...</span>
          <span id="nexaBalance">NEXA: Loading...</span>
        </div>
      </div>
      
      <button id="depositBtn" class="btn btn-ghost" style="display:none; font-size:12px; margin-top: 10px;">
        ‚¨áÔ∏è Show Deposit Address
      </button>

      <div id="bj-panels" aria-live="polite">
        <div id="playerPanel" class="bj-dialog">
          <header>
            <strong>Your Hand</strong>
            <span id="playerStatus" class="chip play">Ready</span>
          </header>
          <div class="body">
            <div id="playerTotals"></div>
            <div id="playerCards"></div>
          </div>
          <footer id="playerFooter" class="muted"></footer>
        </div>

        <div id="dealerPanel" class="bj-dialog">
          <header>
            <strong>Dealer</strong>
            <span id="dealerStatus" class="chip play">Waiting</span>
          </header>
          <div class="body">
            <div id="dealerTotals"></div>
            <div id="dealerCards"></div>
          </div>
          <footer id="dealerFooter" class="muted"></footer>
        </div>
      </div>
      
      <div id="bjStatus" class="muted" style="text-align:center; margin-top:10px; font-style:italic;"></div>
    </div> 

    <div class="panel panel-claim">
      <h2>Season Points</h2>
      <ol id="leaderboardList" class="leaderboard" style="padding-left: 0; list-style: none; margin-bottom: 12px;"></ol>
      <div class="readout" id="lbHint" style="margin-top:6px;"></div>
      <a class="btn btn-ghost" href="/leaderboard.html?game=blackjack" style="margin-top:8px; width:100%; justify-content:center;">See Full Board ‚Üí</a>

      <div style="margin-top:24px; border-top:1px solid rgba(255,255,255,0.1); padding-top:16px;">
        <h2>Claim</h2>
        <button id="dailyReward" class="btn btn-ghost" style="width:100%; margin-bottom:10px;">Claim Daily Reward</button>
        <a href="claim.html" class="btn btn-primary" style="width:100%; text-align:center; padding:12px;">
          FEED ME! üêæ (Withdraw)
        </a>
      </div>
    </div> 

  </div>
</div>

<audio id="feedSound" src="dogfood.mp3" preload="auto"></audio>

<script>
  window.KIBL_TOKEN_ID_HEX = "656bfefce8a0885acba5c809c5afcfbfa62589417d84d54108e6bb42a6f30000";

  // --- 1. GLOBAL BALANCE LOADER (Must be defined first) ---
  window.loadWalletBalances = async function(address) {
    if (!address) return;
    try {
      const r = await fetch(`/api/wallet/balance?address=${encodeURIComponent(address)}`, { credentials: 'include' });
      const j = await r.json();
      if (!j?.ok) return;

      const kiblEl = document.getElementById('kiblBalance');
      if (kiblEl) kiblEl.textContent = `KIBL: ${j.kibl}`;

      const nexaEl = document.getElementById('nexaBalance');
      if (nexaEl) nexaEl.textContent = `NEXA: ${j.nexa}`;
    } catch (e) {
      console.error('loadWalletBalances failed:', e);  
    }
  };

  // Constants
  const API = {
    csrf: '/api/csrf',
    start: '/api/bj/start',
    hit: '/api/bj/hit',
    stand: '/api/bj/stand',
    double: '/api/bj/double',
    split: '/api/bj/split',
    profile: '/api/profile',
    daily: '/api/daily-reward',
    payout: '/api/payout'
  };

  let __csrf = null;
  async function fetchCsrf(){
    try {
      const r = await fetch(API.csrf, { credentials:'include' });
      if (!r.ok) throw new Error('CSRF bootstrap failed');
      const { csrfToken } = await r.json();
      __csrf = csrfToken;
      window.csrfToken = csrfToken;
    } catch {}
  }

  // --- 2. CSRF WRAPPER ---
  async function postWithCsrf(url, body = {}) {
    if (!window.csrfToken) await fetchCsrf();
    
    const req = async () => fetch(url, {
      method: 'POST',
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json',
        'x-csrf-token': window.csrfToken
      },
      body: JSON.stringify(body)
    });

    let resp = await req();
    if (resp.status === 403) {
      await fetchCsrf();
      resp = await req();
    }
    return resp.json();
  }

  // --- 3. UI HELPERS ---
  function toast(html, { type = 'info', timeout = 2500 } = {}) {
    let root = document.getElementById('toasts');
    if (!root) {
      root = document.createElement('div');
      root.id = 'toasts';
      document.body.appendChild(root);
    }
    const el = document.createElement('div');
    el.className = `toast ${type}`;
    el.innerHTML = `<span class="close" onclick="this.parentElement.remove()">√ó</span>${html}`;
    root.appendChild(el);
    setTimeout(() => el.classList.add('show'), 10);
    setTimeout(() => { el.classList.remove('show'); setTimeout(()=>el.remove(), 200); }, timeout);
  }

  // --- 4. GAME LOGIC ---
  async function startRound(){
    try {
      const d = await postWithCsrf(API.start, {});
      if (!d.ok) throw new Error(d.error || 'Start failed');
      
      // Update UI with initial deal
      renderHands({ dealer: d.dealer, player: d.player ? [{ cards: d.player }] : d.players });
      updateBjPanels(d);
      
      document.getElementById('bjStart').disabled = true;
      toggleGameButtons(true);
      
      if (d.settled) afterActionSnapshot(d); // Natural BJ check
    } catch(e) {
      toast(e.message, { type: 'error' });
    }
  }

  async function hit() { action(API.hit); }
  async function stand() { action(API.stand); }
  async function doubleDown() { action(API.double); }
  async function split() { action(API.split); }

  async function action(endpoint) {
    try {
      const d = await postWithCsrf(endpoint, {});
      if (!d.ok) throw new Error(d.error || 'Action failed');
      afterActionSnapshot(d);
    } catch(e) {
      toast(e.message, { type: 'error' });
    }
  }

  function afterActionSnapshot(d) {
    renderHands({ dealer: d.dealer, player: d.players });
    updateBjPanels(d);
    
    if (d.settled) {
      document.getElementById('bjStart').disabled = false;
      toggleGameButtons(false);
      document.getElementById('bjStatus').textContent = 'Round Over';
      
      if (d.credit > 0) {
        toast(`You won ${Math.floor(d.credit/100)} KIBL!`, { type: 'win' });
        loadProfile(); // Update balance
      }
    }
  }

  function toggleGameButtons(active) {
    document.getElementById('bjHit').disabled = !active;
    document.getElementById('bjStand').disabled = !active;
    document.getElementById('bjDoubleBtn').disabled = !active;
    document.getElementById('bjSplitBtn').disabled = !active; // Logic handles split rules separately
  }

  // Render logic
  function renderHands({ dealer, player }) {
    const dEl = document.getElementById('bjDealer');
    const pEl = document.getElementById('bjPlayer');
    dEl.innerHTML = ''; pEl.innerHTML = '';

    const makeCard = (c, hidden) => {
      const div = document.createElement('div');
      div.className = 'card';
      const img = document.createElement('img');
      img.src = hidden ? 'cards/card-back.png' : `cards/${c.filename}?v=xmas`;
      div.appendChild(img);
      return div;
    };

    // Dealer
    if (dealer.full) dealer.full.forEach(c => dEl.appendChild(makeCard(c)));
    else {
      dEl.appendChild(makeCard(dealer.up));
      dEl.appendChild(makeCard({}, true)); // Hole card
    }

    // Player (handle array of hands for splits)
    const hands = Array.isArray(player) ? player : [{ cards: player }];
    hands.forEach(h => {
      (h.cards || []).forEach(c => pEl.appendChild(makeCard(c)));
    });
  }

  function updateBjPanels(data) {
    // Simplified panel update logic
    if (data.settled) {
       document.getElementById('dealerStatus').className = 'chip play';
       document.getElementById('dealerStatus').textContent = 'Revealed';
    }
  }

  // Daily Reward
  async function onDaily() {
    const d = await postWithCsrf(API.daily);
    if (d.ok) {
      toast(`Received ${d.credit/100} KIBL!`, { type: 'win' });
      loadProfile();
    } else {
      toast(d.error || 'Failed', { type: 'error' });
    }
  }

  async function loadProfile() {
    try {
      const r = await fetch(API.profile, { credentials:'include' });
      const d = await r.json();
      if (d.ok) {
        document.getElementById('payoutTotal').textContent = `Total Payout: ${Math.floor(d.bank/100)} KIBL`;
        if (d.displayId) document.getElementById('userTag').textContent = `Tag: ${d.displayId}`;
      }
    } catch {}
  }

  // Bootstrap
  document.addEventListener('DOMContentLoaded', async () => {
    await fetchCsrf();
    loadProfile();
    
    document.getElementById('dailyReward').onclick = onDaily;
    document.getElementById('bjStart').onclick = startRound;
    document.getElementById('bjHit').onclick = hit;
    document.getElementById('bjStand').onclick = stand;
    document.getElementById('bjDoubleBtn').onclick = doubleDown;
    document.getElementById('bjSplitBtn').onclick = split;
  });

</script>

<script type="module">
  import { placeBet } from "/assets/walletBet.bundle.js?v=20250303";
  import { getSigner } from "/assets/wallet-modal.js?v=Christmas";
  import { initOnboarding } from './assets/onboarding.js';

  // 1. Onboarding
  document.addEventListener('DOMContentLoaded', () => initOnboarding('blackjack'));

  // 2. Betting Logic
  const betBtn = document.getElementById('betBtn');
  const depositBtn = document.getElementById('depositBtn');
  const navConnect = document.getElementById('navConnect');
  const oldStart = document.getElementById('bjStart');

  async function fetchCsrf() {
    try {
      const r = await fetch('/api/csrf', { credentials: 'include' });
      const j = await r.json();
      window.csrfToken = j.csrfToken;
    } catch (e) { console.error("CSRF Init Failed", e); }
  }

  async function ensureLinked() {
    const r = await fetch('/api/wallet/status', { credentials: 'include' });
    const j = await r.json().catch(() => null);
    return j?.ok && j.linked ? j : null;
  }

  addEventListener('DOMContentLoaded', async () => {
    await fetchCsrf();
    
    const linked = await ensureLinked();
    const betBtn = document.getElementById('betBtn');
    const depositBtn = document.getElementById('depositBtn');
    const navConnect = document.getElementById('navConnect');
    const oldStart = document.getElementById('bjStart');
    const statusMsg = document.getElementById('bjStatus');

    // Cleanup UI
    if (oldStart) oldStart.style.display = 'none';
    if (linked && navConnect) navConnect.style.display = 'none';
    
    // Deposit Button
    if (linked?.address && depositBtn) {
        depositBtn.style.display = 'inline-flex'; 
        depositBtn.onclick = () => {
            navigator.clipboard.writeText(linked.address)
                .then(() => alert(`Address Copied!\n\n${linked.address}`))
                .catch(() => prompt("Copy your address:", linked.address)); 
        };
    }
    
    // Setup Bet Button
    if (betBtn) {
      betBtn.disabled = !linked;
      betBtn.textContent = linked ? 'Place 100 KIBL Bet' : 'Connect Wallet to Play';
      if (!linked) {
         betBtn.onclick = () => window.location.href = '/connect.html';
         return; 
      }
    }

    if (linked?.address && window.loadWalletBalances) {
      window.loadWalletBalances(linked.address);
    }

    // --- BETTING HANDLER ---
    betBtn?.addEventListener('click', async () => {
      if (betBtn.disabled || betBtn.classList.contains('busy')) return;

      try {
        // Lock UI
        betBtn.classList.add('busy');
        betBtn.textContent = 'Unlocking...';
        
        const passphrase = await getSigner();
        if (!passphrase) throw new Error('Cancelled');

        // Send Bet
        betBtn.textContent = 'Signing...';
        const { txId } = await placeBet({
          passphrase,
          kiblAmount: 10000, // 100 KIBL
          tokenIdHex: window.KIBL_TOKEN_ID_HEX,
          feeNexa: 600
        });

        if (window.toast) toast(`Bet sent!`, { type: 'win' });
        
        // CRITICAL: Hide button immediately so game UI takes over
        betBtn.style.display = 'none'; 
        betBtn.textContent = 'Dealing...'; 

        await window.startRound(); 
        
        // Refresh wallet
        loadProfile();
        if (linked?.address) loadWalletBalances(linked.address);

      } catch (e) {
        const msg = e ? (e.message || String(e)) : 'Unknown error';
        if (msg !== 'Cancelled' && !msg.includes('User rejected')) {
           if(window.toast) window.toast(`Bet failed: ${msg}`, { type: 'error' });
           else alert(msg);
        }
        // Restore button on error
        betBtn.style.display = 'inline-flex';
        betBtn.textContent = 'Place 100 KIBL Bet';
        betBtn.disabled = false;
        betBtn.classList.remove('busy');
      }
    });

    // --- THE POKER-STYLE OBSERVER ---
    // This watches the status text. When it sees "Round settled" or a Win/Loss, 
    // it brings the button back.
    const obs = new MutationObserver(() => {
        const text = statusMsg.textContent || "";
        // Check for ANY Game Over keywords
        if (text.includes('settled') || text.includes('Win') || text.includes('Loss') || text.includes('Blackjack') || text.includes('Push')) {
            
            // Small delay to let the user see the result
            setTimeout(() => {
                if (betBtn.style.display === 'none') {
                    betBtn.style.display = 'inline-flex';
                    betBtn.disabled = false;
                    betBtn.textContent = 'Place 100 KIBL Bet';
                    betBtn.classList.remove('busy');
                    
                    // Final balance check
                    if (linked?.address && window.loadWalletBalances) window.loadWalletBalances(linked.address);
                }
            }, 1000);
        }
    });
    
    if (statusMsg) {
        obs.observe(statusMsg, { childList: true, subtree: true, characterData: true });
    }
  });
</script>
  <footer class="readout" style="text-align:center; opacity:.9; padding:14px 0 6px;">
    ¬© 2025 KIBL / PixelPup ‚Ä¢ Stay shiny üê∂‚ú® ‚Ä¢
    <a href="tos.html">Terms</a> ‚Ä¢ <a href="privacy.html">Privacy</a> ‚Ä¢ <a href="disclaimer.html">Disclaimer</a>
  </footer>
</body>
</html>
