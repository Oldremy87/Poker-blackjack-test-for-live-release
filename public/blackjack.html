<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PixelPup Blackjack</title>
  <script src="https://hcaptcha.com/1/api.js" async defer></script>
    <script>
  // Make CSRF available to modules early
  (async () => {
    try {
      const r = await fetch('/api/csrf', { credentials: 'include' });
      const j = await r.json();
      window.csrfToken = j.csrfToken;
    } catch {}
  })();
</script>
 

  <style>
      /* ===== Retro PixelPup theme (CSP-safe, no external fonts) ===== */
    :root{
        --ui-scale: 1;        /* user slider 0.8‚Äì1.25 */
       --hand-gap: 10px;
        --card-ratio: 1.6;   /* height = width * ratio; tweak if your art needs */
      --cardW: 100px;    
      --bg: #0b0f19;
      --panel: #111827;
      --text: #00ffc6;
      --text-dim: #7fffe6;
      --accent: #ffcc00;
      --accent-2: #ff3df7;
      --accent-3: #6ae3ff;
      --card-bg: #222638;
      --card-border: #3af5d9;
      --danger: #ff5577;
      --ok: #45ff99;
       --win-cyan:  #3af5d9;
  --win-pink:  #ff3df7;
  --win-gold:  #ffcc00;
    }
    /* Always hide elements with [hidden], and loaders by default */
[hidden] { display: none !important; }
.loading { display: none !important; }     /* stays hidden until .show is added */
.loading.show { display: block !important; }
.hidden { display: none !important; }

/* Visually hidden utility */
.sr-only { 
  position: absolute !important;
  width: 1px; height: 1px; padding: 0; margin: -1px;
  overflow: hidden; clip: rect(0,0,1px,1px); white-space: nowrap; border: 0;
}

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 800px at 50% -20%, #13203b 0%, #0b0f19 60%, #05070d 100%),
        linear-gradient(180deg, #0b0f19 0%, #05070d 100%);
      color: var(--text);
      padding: 24px;
    }
  #toasts {
    position: fixed; top: 12px; right: 12px; z-index: 9999;
    display: flex; flex-direction: column; gap: 8px;
    pointer-events: none;
  }
  .toast {
    pointer-events: auto;
    background: rgba(20,20,20,.92);
    color: #fff; border-radius: 12px; padding: 10px 12px;
    box-shadow: 0 8px 24px rgba(0,0,0,.25);
    font: 600 14px system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    transform: translateY(-6px); opacity: 0;
    transition: transform .18s ease-out, opacity .18s ease-out;
    max-width: 320px; line-height: 1.25;
    border-left: 4px solid #888;
  }
  .toast.show { transform: translateY(0); opacity: 1; }
  .toast.hide { transform: translateX(8px); opacity: 0; }
  .toast.win   { border-left-color: #22c55e; }  /* green */
  .toast.bonus { border-left-color: #06b6d4; }  /* cyan  */
  .toast.error { border-left-color: #ef4444; }  /* red   */

  .toast .close {
    float: right; margin-left: 8px; font-weight: 700; cursor: pointer; opacity: .7;
  }
  .toast .close:hover { opacity: 1; }

  @media (prefers-reduced-motion: reduce) {
    .toast, .toast.show, .toast.hide { transition: none; }
  }
    /* Header / Nav */
    header { display: flex; align-items: center; justify-content: space-between; gap: 16px; margin: 0 auto 16px; max-width: 1100px; }
    .brand { display: flex; align-items: center; gap: 10px; letter-spacing: 0.5px; text-shadow: 0 0 10px rgba(0,255,198,0.6); }
    .brand-badge {
      width: 36px; height: 36px; border-radius: 10px; border: 2px solid var(--card-border);
      box-shadow: 0 0 14px rgba(0,255,198,0.2); display: grid; place-items: center;
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      font-weight: 700; color: var(--accent);
    }
    nav { display: flex; gap: 10px; flex-wrap: wrap; }

    .btn {
      appearance: none; border: 0; cursor: pointer; padding: 10px 14px; border-radius: 12px;
      color: #000; background: var(--accent); text-decoration: none;
      box-shadow: 0 3px 0 #b59000, 0 0 12px rgba(255,204,0,0.35);
      font-weight: 700; letter-spacing: .2px; display: inline-flex; align-items: center; gap: 8px;
      transition: transform .06s ease, filter .12s ease, box-shadow .12s ease;
      font-size: 12px;
    }
    .btn:hover { transform: translateY(-1px); filter: brightness(1.05); }
    .btn:active { transform: translateY(1px); }
    .btn:disabled { background: #555; color: #111; box-shadow: none; cursor: not-allowed; }
    .btn:focus-visible { outline: 2px solid var(--accent-3); outline-offset: 2px; }
    .btn-telegram{
      background: var(--accent-3);
      box-shadow: 0 3px 0 #2aa7bf, 0 0 14px rgba(106,227,255,0.35);
      color: #021018;
    }
    .btn-primary{
      background: var(--accent-2);
      color: #120016;
      box-shadow: 0 3px 0 #a2259c, 0 0 14px rgba(255,61,247,0.35);
    }
    .btn-ghost{
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      color: var(--text);
      border: 1px solid rgba(58,245,217,0.35);
      box-shadow: 0 0 12px rgba(0,255,198,0.18) inset, 0 0 12px rgba(0,255,198,0.12);
    }

    /* Layout panels */
    .wrap { max-width: 1100px; margin: 0 auto; }

/* Stack on tablets/phones */
@media (max-width: 1024px) {
  .hud { grid-template-columns: 1fr; }
  .panel-table, .panel-claim { grid-column: 1; }
}
  .panel {
  /* back to a normal card */
  display: block;
  background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.01));
  border: 1px solid rgba(58,245,217,0.3);
  border-radius: 16px;
  padding: 16px;
  backdrop-filter: blur(4px);
  box-shadow: 0 0 24px rgba(0,255,198,0.06) inset, 0 0 24px rgba(0,255,198,0.08);
}
    .controls { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-top: 8px; }

    .readout { color: var(--text-dim); font-size: 12px; margin: 4px 0; }
    .card {cursor: pointer; user-select: none; }
    /* Hand area (real cards + simulated placeholders share this) */
    .card-hand {
       
       gap: var(--hand-gap);
      display: flex;
      flex-wrap: nowrap;
      justify-content: center;
      align-items: flex-start;
      gap: 10px;
      min-height: 170px;
      margin: 12px auto 0;
      max-width: 1100px;
    }
    /* Card visual */
    /* Card + placeholder sizing and layout */
.card, .placeholder {
  --_w: calc(var(--cardBaseW, var(--cardW)) * var(--ui-scale));
  width: var(--_w);
  height: calc(var(--_w) * var(--card-ratio));         
  border-radius: 10px;
  background: var(--card-bg);
  color: #fff;
  border: 2px solid var(--card-border);
  display: grid;
  grid-template-rows: minmax(0, 1fr) auto auto; /* image shrinks first, label, then button */
  align-items: center;
  justify-items: center;
  padding: 8px;
  overflow: hidden;              /* keeps rounded corners clean */
  position: relative;
  text-align: center;
  box-shadow: 0 0 20px rgba(0,255,198,0.1);
}
body.compact {
  --hand-gap: 8px;
}
/* ===== New Smart Modal System ===== */
.smart-modal {
  position: fixed; inset: 0; z-index: 10000;
  display: grid; place-items: center;
  background: rgba(5,7,13,.92);
  backdrop-filter: blur(5px);
  opacity: 0; pointer-events: none; transition: opacity 0.2s;
}
.smart-modal.active { opacity: 1; pointer-events: auto; }

.smart-modal-card {
  width: min(90vw, 500px);
  background: var(--panel, #111827);
  border: 1px solid var(--card-border, #3af5d9);
  box-shadow: 0 0 40px rgba(0,255,198,0.15);
  border-radius: 16px;
  overflow: hidden;
  transform: translateY(10px); transition: transform 0.2s;
  display: flex; flex-direction: column;
}
.smart-modal.active .smart-modal-card { transform: translateY(0); }

.smart-modal-header {
  background: rgba(255,255,255,0.03);
  padding: 16px 20px;
  border-bottom: 1px solid rgba(58,245,217,0.2);
  display: flex; justify-content: space-between; align-items: center;
}
.smart-modal-header h2 { margin: 0; font-size: 1.2rem; color: var(--accent, #ffcc00); }
.smart-modal-close {
  background: none; border: none; color: var(--text-dim, #7fffe6);
  font-size: 1.5rem; cursor: pointer; line-height: 1;
}

.smart-modal-body { padding: 20px; color: var(--text, #00ffc6); font-size: 0.95rem; line-height: 1.6; }
.smart-modal-body p { margin: 0 0 12px; }
.smart-modal-body strong { color: var(--accent-2, #ff3df7); }
.smart-modal-body ul { padding-left: 20px; margin-bottom: 16px; color: var(--text-dim); }
.smart-modal-body li { margin-bottom: 6px; }

.smart-modal-footer {
  padding: 16px 20px;
  border-top: 1px solid rgba(58,245,217,0.1);
  display: flex; justify-content: flex-end; gap: 10px;
  background: rgba(0,0,0,0.2);
}

.address-box {
  background: #000; border: 1px dashed var(--accent-3, #6ae3ff);
  padding: 10px; border-radius: 8px; font-family: monospace;
  font-size: 0.85rem; word-break: break-all; margin: 10px 0; color: #fff;
  cursor: pointer; position: relative;
}
.address-box:active { opacity: 0.7; }
.address-box::after {
  content: 'Click to Copy'; position: absolute; top: -8px; right: 8px;
  background: var(--accent-3); color: #000; font-size: 10px;
  padding: 2px 6px; border-radius: 4px; font-weight: bold;
}
/* Dealing placeholders centered and unbroken */
.placeholder {
  display: flex;
  align-items: center;
  justify-content: center;
  border-style: dashed;
  font-size: 12px;
  letter-spacing: .5px;
  color: var(--text-dim);
  animation: pulse .9s ease-in-out infinite alternate;
  white-space: nowrap;           /* never break ‚ÄúDealing...‚Äù into ‚Äú...ling‚Äù */
  padding: 0 6px;
}
.controls { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
.controls .btn { flex: 1 1 180px; }
  @media (max-width: 420px) {
  .controls .btn { flex: 1 1 48%; }
}
.card img {
  width: 100%;
  height: 100%;
  object-fit: contain;
  display: block;
}
@media (max-width: 720px){
  header { flex-direction: column; align-items: stretch; gap: 8px; }
  nav { justify-content: center; }
  .brand h1 { font-size: 1.35rem; }
  body { padding: 12px; }
}
/* Lightweight confetti (optional flair) */
.fx-confetti{ position:fixed; inset:0; pointer-events:none; z-index:9999; overflow:hidden; }
.fx-confetti i{
  position:absolute; top:-12px; left: var(--x,50%);
  width:8px; height:14px; border-radius:2px;
  background: linear-gradient(var(--rot,0deg),
              var(--win-pink), var(--win-gold), var(--win-cyan));
  opacity:.95;
  transform: rotate(var(--rot,0deg));
  animation: arcade-confetti var(--dur,1200ms) ease-out forwards;
}
@keyframes arcade-confetti{
  0%   { transform: translateY(-10px) rotate(var(--rot,0deg)); }
  100% { transform: translateY(calc(100vh + 12px)) rotate(calc(var(--rot,0deg) + 260deg)); opacity:0; }
}
#payoutTotal{ position: relative; display:inline-block; border-radius:12px; padding:2px 6px; }

/* One-shot bling class we add/remove from JS */
.payout-win{
  /* quick pop + glow + sheen */
  animation:
    arcade-pop .18s ease-out,
    arcade-glow 1.2s ease-out;
  filter: saturate(1.2);
}

/* Neon aura behind the text */
.payout-win::before{
  content:"";
  position:absolute; inset:-8px;
  border-radius:14px;
  background: conic-gradient(from 0deg,
    var(--win-pink), var(--win-gold), var(--win-cyan), var(--win-pink));
  filter: blur(14px) opacity(.55);
  z-index:-1;
  animation: arcade-spin 1.1s ease-out both;
}

/* Shiny sweep across the text */
.payout-win::after{
  content:"";
  position:absolute; inset:-2px;
  border-radius:12px;
  background:
    linear-gradient(120deg,
      rgba(255,255,255,0) 0%,
      rgba(255,255,255,.25) 15%,
      rgba(255,255,255,0) 32%);
  transform: translateX(-140%);
  animation: arcade-sheen .9s ease-out .06s forwards;
  pointer-events:none;
}

@keyframes arcade-pop{
  0% { transform: scale(1); }
  70%{ transform: scale(1.08); }
  100%{ transform: scale(1); }
}
@keyframes arcade-glow{
  0%   { box-shadow: 0 0 0 rgba(0,0,0,0); }
  45%  { box-shadow: 0 0 18px rgba(255,61,247,.25), 0 0 32px rgba(58,245,217,.18) inset; }
  100% { box-shadow: 0 0 0 rgba(0,0,0,0); }
}
@keyframes arcade-spin{
  from { transform: rotate(0deg) scale(1.02); }
  to   { transform: rotate(120deg) scale(1); }
}
@keyframes arcade-sheen{
  to { transform: translateX(140%); }
}

/* 2-line clamp for long names like ‚ÄúQueen of Diamonds‚Äù */
.card p {
  margin: 4px 0 0 0;
  font-size: 11px;
  line-height: 1.05;
  padding: 0 4px;
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 2;         /* clamp to 2 lines */
  line-clamp: 2;                 /* standard property for compatibility */
  -webkit-box-orient: vertical;
}

.card button {
  display: none;
  width: 100%;
  min-height: 30px;              /* reliable tap target */
  font-size: 11px;
  padding: 6px 8px;
  border-radius: 8px;
  margin-top: 6px;
  background: var(--accent-2);
  color: #090014;
  box-shadow: 0 2px 0 #a2259c, 0 0 10px rgba(255,61,247,0.35);
}

/* Held badge */
.card.held::after {
  content: 'HELD';
  position: absolute;
  top: 6px; left: 6px;
  font-size: 10px;
  padding: 2px 6px;
  background: var(--accent);
  color: #000;
  border-radius: 6px;
  box-shadow: 0 0 10px rgba(255,204,0,0.4);
}
#bj-panels{
  position: static;                  /* no overlay */
  width: 100%;
  display: grid;
  grid-template-columns: repeat(2, minmax(220px, 1fr));
  gap: .75rem;
  margin-top: .75rem;
  align-items: start;
  grid-column: 1 / 2;                /* ‚Üê force left column of .hud */
  z-index: 1;
}

/* Optional: keep it visible while scrolling on wide screens */
@media (min-width:1025px){
  #bj-panels{ position: sticky; top: 12px; }
}

/* On narrow screens stack them */
@media (max-width:900px){
  #bj-panels{ grid-template-columns: 1fr; }
}



/* Let each dialog expand to its grid column */
.bj-dialog { width: auto; }

.bj-dialog header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: .35rem;
  font-size: 0.95rem;
  letter-spacing: .2px;
}

.bj-dialog .body {
  display: grid;
  gap: .4rem;
}
@media (max-width:900px){
  #bj-panels { grid-template-columns: 1fr; }
}

.bj-dialog footer {
  margin-top: .35rem;
  font-size: .8rem;
}

.muted { color: #aab0ffb0; }

#playerTotals, #dealerTotals {
  font-size: 1.05rem;
  font-weight: 600;
}

#playerCards, #dealerCards {
  display: flex;
  flex-wrap: wrap;
  gap: .35rem .45rem;
}

.cardchip {
  border: 1px solid #3a3f7d;
  background: #171b35;
  padding: .25rem .5rem;
  border-radius: 10px;
  font-size: .85rem;
}

.chip {
  display: inline-block;
  padding: .18rem .5rem;
  border-radius: 999px;
  font-size: .75rem;
  border: 1px solid transparent;
}
.chip.win   { background: #123e22; color: #c0ffd7; border-color: #1f6a3a; }
.chip.loss  { background: #3e1212; color: #ffd0d0; border-color: #6a1f1f; }
.chip.push  { background: #3b3b3b; color: #f1f1f1; border-color: #646464; }
.chip.play  { background: #122a3e; color: #cfe8ff; border-color: #1f476a; }
.chip.bj    { background: #262051; color: #e3d7ff; border-color: #4b409a; }

.handline {
  display: flex;
  align-items: baseline;
  gap: .5rem;
}
.handline .idx {
  width: 1.15rem;
  text-align: right;
  color: #aab0ffb0;
  font-size: .8rem;
}
.softflag {
  font-size: .8rem;
  opacity: .8;
  margin-left: .25rem;
}
.activeHand { outline: 1px dashed #6ea8ff; outline-offset: 6px; border-radius: 12px; padding: .2rem .3rem; }


@media (max-width: 600px) {
  .card, .placeholder { width: 80px; height: 138px; }
  .card p { font-size: 10px; }
  .card button { min-height: 28px; font-size: 10px; }
  .card-hand { min-height: 140px; }
}
/* Age gate: focus ring for accessibility */
#ageGate :focus-visible { outline: 2px solid var(--accent-3); outline-offset: 2px; }

/* Reduce panel text width for readability on narrow screens */
@media (max-width: 420px){
  #ageGate .brand h1{ font-size: 1.2rem; }
}



    h1 { margin: 0 0 10px; }
        .faucet-form { display: grid; gap: 10px; }
    .field { display: grid; gap: 6px; }
    label { color: var(--text-dim); font-size: 14px; }
    input[type="text"]{
      width: 100%; padding: 12px 14px; border-radius: 12px; border: 1px solid rgba(58,245,217,0.35);
      background: #0f1425; color: var(--text);
      box-shadow: inset 0 0 14px rgba(0,255,198,0.08);
    }

    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }

    .status {
      padding: 10px 12px; border-radius: 12px;
      background: #0f1425; border: 1px solid rgba(58,245,217,0.25);
      color: var(--text-dim);
    }
    .status.ok { border-color: rgba(69,255,153,0.6); color: var(--ok); }
    .status.err { border-color: rgba(255,85,119,0.65); color: var(--danger); }

    footer { opacity: .9; color: var(--text-dim); font-size: 12px; text-align: center; padding: 14px 0 6px; }

.card-hand {
  min-height: 220px;
  margin-top: 16px;
}
@media (min-width: 900px) {
  .card, .placeholder { width: 120px; height: 196px; }
  .card-hand { min-height: 240px; }
}
/* Keep claim pieces tidy */
.claim-block { margin-top: 12px; }
#leaderboardList{ list-style:none; padding:0; margin:0; }
#leaderboardList li{ display:flex; align-items:center; gap:.75rem; padding:.25rem 0; }
#leaderboardList .who{ min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
#leaderboardList .pts{ margin-left:auto; }
#leaderboardList li.you{ font-weight:700; }
/* HUD: desktop = 2 cols, mobile = stacked */
.hud {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 12px;
}
.panel-table { grid-column: 1 / 2; }
.panel-claim { grid-column: 2 / 3; }

@media (max-width: 1024px) {
  .hud { grid-template-columns: 1fr; }
  .panel-table, .panel-claim { grid-column: 1 / -1; }  /* <‚Äî ensures stacking */
}
.callout{
  margin: 8px 0 12px;
  padding: 10px 12px;
  border-radius: 12px;
  background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
  border: 1px solid rgba(58,245,217,0.45);
  box-shadow: 0 0 18px rgba(0,255,198,0.12) inset, 0 8px 22px rgba(0,0,0,0.25);
  font-size: 13px; line-height: 1.25;
}
.callout strong{ color: var(--accent); margin-right: 6px; }
.callout .close{
  float: right; border: 0; background: transparent; color: var(--text);
  font-weight: 800; cursor: pointer; opacity: .8;
}
.callout .close:hover{ opacity: 1; }
.age-gate{
  position: fixed; inset: 0; z-index: 10000;
  display: grid; place-items: center;
  background: rgba(5,7,13,.88);
  backdrop-filter: blur(3px);
}
.age-card{
  width: min(92vw, 420px);
  background: var(--panel);
  color: var(--text);
  border: 1px solid rgba(58,245,217,.35);
  border-radius: 16px;
  padding: 16px;
  box-shadow: 0 12px 32px rgba(0,0,0,.4), 0 0 24px rgba(0,255,198,.08) inset;
}
@media (prefers-reduced-motion: no-preference){
  .age-card{ transform: translateY(6px); opacity:.98; animation: agIn .18s ease-out forwards; }
  @keyframes agIn{ to{ transform: none; opacity:1; } }
}
.modal { position:fixed; inset:0; background:rgba(0,0,0,.6); display:flex; align-items:center; justify-content:center; z-index:9999; }
.modal-content { background:#111; color:#fff; padding:1.25rem; max-width:600px; border-radius:14px; }
.modal-content h2 { margin-top:0 }
@keyframes pulse {
  0% { transform:scale(1); }
  30% { transform:scale(1.08); }
  100% { transform:scale(1); }
}
.payout-pulse { animation: pulse 450ms ease-out; }
/* You already have this line in your file, keep it: */
/* #ageGate :focus-visible { outline: 2px solid var(--accent-3); outline-offset: 2px; } */
.hud{
  display: grid;
  grid-template-columns: minmax(0, 2fr) minmax(320px, 1fr);
  gap: 16px;
  align-items: start;
}
.panel-table { grid-column: 1; }
.panel-claim { grid-column: 2; }

/* Stack cleanly on tablets/phones */
@media (max-width: 1024px){
  .hud { grid-template-columns: 1fr; }
  .panel-table, .panel-claim { grid-column: 1 / -1; }
}
@media (min-width:1025px){
  #bj-panels{ grid-column: 2; position: sticky; top: 12px; }
}
/* Register a custom angle for spinning borders (safe in modern browsers) */
@property --spin { syntax: "<angle>"; inherits: false; initial-value: 0deg; }

/* Base look for the payout chip */
#payoutTotal{
  display: inline-block;
  padding: 6px 10px;
  border-radius: 12px;
  position: relative;
  background: #0f1425;
  border: 1px solid rgba(58,245,217,.35);
  transition: transform .15s ease, box-shadow .15s ease, filter .15s ease;
}

/* Win pulse: rainbow border + neon glow + bounce */
#payoutTotal.payout-pulse{
  border: 2px solid transparent;
  background:
    linear-gradient(#0f1425, #0f1425) padding-box,
    conic-gradient(from var(--spin),
      #00ffc6, #ffcc00, #ff3df7, #6ae3ff, #00ffc6) border-box;
  color: #ffffff;
  text-shadow:
    0 0 6px #00ffc6,
    0 0 10px #ff3df7,
    0 0 16px #ffcc00;
  box-shadow:
    0 0 18px rgba(0,255,198,.35),
    0 0 28px rgba(255,61,247,.25),
    0 0 40px rgba(255,204,0,.18);
  animation:
    payoutBounce .9s cubic-bezier(.2,1.4,.2,1) 1,
    payoutGlow .9s ease-out 1,
    payoutSpin 1.2s linear 1;
  will-change: transform, box-shadow, filter;
}

@keyframes payoutBounce{
  0%   { transform: scale(1); }
  35%  { transform: scale(1.18) rotate(-0.8deg); }
  65%  { transform: scale(1.10) rotate(0.6deg); }
  100% { transform: scale(1); }
}

@keyframes payoutGlow{
  0%   { filter: saturate(1) brightness(1); }
  40%  { filter: saturate(1.6) brightness(1.25); }
  100% { filter: saturate(1) brightness(1); }
}

@keyframes payoutSpin{
  to { --spin: 360deg; }
}

/* Respect reduced motion */
@media (prefers-reduced-motion: reduce){
  #payoutTotal.payout-pulse{
    animation: none;
    box-shadow: 0 0 18px rgba(0,255,198,.35);
  }
}
#bjPlayer {
  display: flex;              /* still flex, but vertical */
  flex-direction: column;     /* stack rows */
  align-items: center;        /* center the rows */
  gap: var(--hand-gap);
}

/* each row of cards */
#bjPlayer .hand-row {
  display: flex;
  gap: var(--hand-gap);
}
#bjStatus:empty,
#playerFooter:empty,
#dealerFooter:empty {
  display: none !important;
}
/* SAFE LAYOUT UPGRADE */
@media (min-width: 1025px) {
  .hud {
    display: grid;
    grid-template-columns: 2fr 1fr; /* Game Left, Claim Right */
    gap: 20px;
    align-items: start;
  }
  
  /* Force the Game Panel to the left */
  .panel-table { 
    grid-column: 1 / 2; 
  }
  
  /* Force the Claim/Leaderboard Panel to the right & sticky */
  .panel-claim { 
    grid-column: 2 / 3;
    position: sticky;
    top: 20px;
    height: fit-content;
  }
}
  </style>
</head>
<body>
<div id="ageGate" class="age-gate" role="dialog" aria-modal="true" aria-labelledby="ageTitle" hidden>
  <div class="age-card" role="document">
    <h2 id="ageTitle" style="margin:0 0 8px">Are you 18 or older?</h2>
    <p class="readout" style="margin:0 0 12px">
      PixelPup Blackjack is for adults. Please confirm your age to continue.
    </p>
    <div class="controls" style="margin-top:6px">
      <button id="ageYes" class="btn btn-primary">Yes, enter</button>
      <a id="ageNo" class="btn btn-ghost" href="/">No, take me back</a>
    </div>
  </div>
</div>

<script>
  function fitHandToWidth() {
    const hand = document.getElementById('hand'); // Note: ID might be bjPlayer in BJ logic, check script usage
    if (!hand) return;
    // ... existing resize logic ...
  }
</script>

<header>
  <nav>
    <a class="btn btn-telegram" href="https://t.me/NexaKennelKlub" target="_blank" rel="noopener noreferrer">
      <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" style="width:18px;height:18px;margin-right:6px;">
        <path fill="#1C93E3" d="M12 0a12 12 0 1 0 0 24A12 12 0 0 0 12 0z"/>
        <path fill="#fff" d="M17.9 7.4c.2-1-.8-1.3-1.6-1l-11 4.2c-.7.3-.7.8-.1 1l2.8.9 6.5-4.1c.3-.2.6-.1.4.1l-5.3 4.9-.2 3.1c.5 0 .7-.2 1-.5l1.7-1.6 2.6 1.9c.6.3 1 .1 1.1-.6l1.9-9.3z"/>
      </svg>
      Join Telegram
    </a>
    <a class="btn btn-ghost kk-home" href="/" aria-label="Go to Home">üè† Home</a>
    <a class="btn btn-primary" href="/play.html" aria-current="page">Play Poker</a>
    <a id="navConnect" class="btn btn-ghost" href="/connect.html" aria-current="page">Connect Wallet</a>
  </nav>
  <div class="brand">
    <div class="brand-badge">KK</div>
    <h1>PixelPup BlackJack</h1>
  </div>
</header>

<div class="wrap">
  <div class="hud">
    
    <div class="panel panel-table" id="bjPanel">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2px;">
      </div>
      <p id="bjFair" class="readout" style="font-size:6px; opacity:0.7;"></p>
      
      <div class="readout">Dealer</div>
      <div id="bjDealer" class="card-hand" aria-live="polite"></div>

      <div class="readout" style="margin-top:2px;">You</div>
      <div id="bjPlayer" class="card-hand" aria-live="polite"></div><div class="controls" style="margin-top:5px;">
        <button id="betBtn" class="btn">Place 100 KIBL bet</button>
        <button id="bjStart" class="btn btn-primary" style="display:none;">Feed the dealer</button> 
        <button id="bjHit" class="btn" disabled>Hit</button>
        <button id="bjStand" class="btn" disabled>Stand</button>
        <button id="bjDoubleBtn" class="btn" disabled>Double</button>
        <button id="bjSplitBtn" class="btn" disabled>Split</button>
      </div>
       <div style="margin-top: 5px; padding: 3px; background: rgba(0,0,0,0.3); border-radius: 3px;">
        <p id="payoutTotal" style="margin:0 0 4px; color: var(--accent);">Total Payout: 0 KIBL</p>
        <div style="display:flex; gap: 8px; font-family: monospace; color: var(--text-dim);">
          <span id="kiblBalance">KIBL: ‚Äî</span>
          <span id="nexaBalance">NEXA: ‚Äî</span>
        </div>
      </div>
      <button id="depositBtn" class="btn btn-ghost" style="display:none; font-size:10px; margin-top: 5px; width:100%;">
        ‚¨áÔ∏è Show Deposit Address
      </button>
    

      <div id="bj-panels" aria-live="polite" style="margin-top:5px;">
        <div id="playerPanel" class="bj-dialog">
          <header>
            <strong>Your Hand</strong>
            <span id="playerStatus" class="chip play">Ready</span>
          </header>
          <div class="body">
            <div id="playerTotals">‚Äî</div>
            <div id="playerCards"></div>
          </div>
          <footer id="playerFooter" class="muted"></footer>
        </div>

        <div id="dealerPanel" class="bj-dialog">
          <header>
            <strong>Dealer</strong>
            <span id="dealerStatus" class="chip play">Waiting</span>
          </header>
          <div class="body">
            <div id="dealerTotals">‚Äî</div>
            <div id="dealerCards"></div>
          </div>
          <footer id="dealerFooter" class="muted"></footer>
        </div>
      </div>
      
      <div id="bjStatus" class="muted" style="text-align:center; margin-top:10px; font-style:italic;"></div>
    </div> <div class="panel panel-claim">
      <h2>Season Points Window</h2>
      <p id="userTag" class="readout" style="margin:0;"></p>
      <ol id="leaderboardList" class="leaderboard" style="padding-left: 0; list-style: none; margin-bottom: 12px;"></ol>
      <div class="readout" id="lbHint" style="margin-top:6px;"></div>
      <a class="btn btn-ghost" href="/leaderboard.html?game=blackjack" style="width:100%; text-align:center;">See full leaderboard ‚Üí</a>

      <div style="margin-top:24px; border-top:1px solid rgba(255,255,255,0.1); padding-top:16px;">
        <h2>Claim</h2>
        <button id="dailyReward" class="btn btn-ghost" style="width:100%; margin-bottom:10px;">Claim Daily Reward</button>
        <a href="claim.html" class="btn btn-primary" style="width:100%; text-align:center; display:block; padding:12px;">
          FEED ME! üêæ (Withdraw)
        </a>
          <div id="backupSection" style="margin-top: 20px; border-top: 1px solid #333; padding-top: 20px; display: none;">
  <h3>‚ö†Ô∏è Security Check</h3>
  <p class="readout">If you clear your browser data, you will lose your funds.</p>
  <button id="btnBackup" class="btn btn-ghost" style="border-color: #ff5577; color: #ff5577;">
    Reveal Secret Recovery Phrase
  </button>
</div>
<a class="btn btn-ghost" href="bjachievements.html">Achievements</a>
        <a class="btn btn-ghost" href="bjpoints.html">Points</a>
      </div>
    </div> </div> </div> <audio id="feedSound" src="dogfood.mp3" preload="auto"></audio>
  
<script>
  window.loadWalletBalances = async function(address) {
  if (!address) return;
  try {
    const r = await fetch(`/api/wallet/balance?address=${encodeURIComponent(address)}`, { credentials: 'include' });
    const j = await r.json();
    if (!j?.ok) return;

    const kiblEl = document.getElementById('kiblBalance');
    if (kiblEl) kiblEl.textContent = `KIBL: ${j.kibl}`;

    const nexaEl = document.getElementById('nexaBalance');
    if (nexaEl) nexaEl.textContent = `NEXA: ${j.nexa}`;
  } catch (e) {
    console.error('loadWalletBalances failed:', e);  
  }
};
document.addEventListener('DOMContentLoaded', async () => {
  try {
    await fetchCsrf();
    await (window.loadProfile?.());
    await (window.loadLeaderboard?.());
  } catch {
    alert('Could not initialize security token. Refresh to try again.');
  }
});

 let __csrf = null;
    async function fetchCsrf(){
      const r = await fetch('/api/csrf', { credentials:'include' });
      if (!r.ok) throw new Error('CSRF bootstrap failed');
      const { csrfToken } = await r.json();
      __csrf = csrfToken;
    }
    // --- RESTORED UI HELPER ---
function fitBjToScreen(){
  const panel = document.getElementById('bjPanel');
  if (!panel) return;

  const gap = parseFloat(getComputedStyle(document.documentElement)
               .getPropertyValue('--hand-gap') || '10') || 10;

  // How many cards in the widest visible row?
  const dealerCount = document.querySelectorAll('#bjDealer .card').length || 2;
  const rowCounts = Array.from(document.querySelectorAll('#bjPlayer .hand-row'))
                    .map(r => r.querySelectorAll('.card, .placeholder').length);
  const n = Math.max(dealerCount, ...(rowCounts.length ? rowCounts : [2]));

  // Available width inside the table panel (minus a little padding)
  const available = panel.clientWidth - 32;
  const perCard = (available - gap * (n - 1)) / n;

  // Clamp so it always looks nice
  const base = Math.max(64, Math.min(perCard, 136)); // px
  document.documentElement.style.setProperty('--cardBaseW', base + 'px');
}


async function loadWalletBalances(address) {
  if (!address) return;
  try {
    const r = await fetch(`/api/wallet/balance?address=${encodeURIComponent(address)}`, { credentials: 'include' });
    const j = await r.json();
    if (!j?.ok) return;

    const kiblEl = document.getElementById('kiblBalance');
    if (kiblEl) kiblEl.textContent = `KIBL: ${j.kibl}`;

    const nexaEl = document.getElementById('nexaBalance');
    if (nexaEl) nexaEl.textContent = `NEXA: ${j.nexa}`;
  } catch (e) {
    console.error('loadWalletBalances failed:', e);  
  }
}
async function postWithCsrf(url, body = {}) {
  // Ensure we have a token
  if (!window.csrfToken) {
    const r = await fetch('/api/csrf', { credentials: 'include' });
    const j = await r.json();
    window.csrfToken = j.csrfToken;
  }

  const res = await fetch(url, {
    method: 'POST',
    credentials: 'include',
    headers: {
      'Content-Type': 'application/json',
      'CSRF-Token': window.csrfToken, // Match the header expected by csurf/server
      'x-csrf-token': window.csrfToken // Redundant backup
    },
    body: JSON.stringify(body)
  });

  // If token is stale (403), retry once
  if (res.status === 403) {
    const r = await fetch('/api/csrf', { credentials: 'include' });
    const j = await r.json();
    window.csrfToken = j.csrfToken;
    
    // Retry original request
    return fetch(url, {
      method: 'POST',
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json',
        'CSRF-Token': window.csrfToken
      },
      body: JSON.stringify(body)
    }).then(r => r.json());
  }

  return res.json();
}

function flashPayout(){
  if (!payoutEl) return;
  // retrigger the one-shot animation reliably
  payoutEl.classList.remove('payout-win');
  // force reflow
  void payoutEl.offsetWidth;
  payoutEl.classList.add('payout-win');
  // clean up after the glow ends
  setTimeout(() => payoutEl?.classList.remove('payout-win'), 1400);
}

function confettiBurst(count = 48, ms = 1800){
  const wrap = document.createElement('div');
  wrap.className = 'fx-confetti';
  document.body.appendChild(wrap);
  for (let i=0;i<count;i++){
    const s = document.createElement('i');
    s.style.setProperty('--x', `${Math.random()*100}%`);
    s.style.setProperty('--rot', `${Math.random()*360}deg`);
    s.style.setProperty('--dur', `${1000 + Math.random()*900}ms`);
    wrap.appendChild(s);
  }
  setTimeout(()=> wrap.remove(), ms + 500);
}

function bjScore(cards) {
  let total = 0, aces = 0;
  for (const c of (cards||[])) {
    const r = c.rank;
    if (r === 'Ace') { total += 11; aces++; }
    else if (r === 'King' || r === 'Queen' || r === 'Jack') total += 10;
    else total += Number(r) || 0;
  }
  while (total > 21 && aces > 0) { total -= 10; aces--; }
  return { total, soft: aces > 0, isBJ: (cards?.length === 2 && total === 21) };
}

function renderCardChips(cards) {
  return (cards||[]).map(c => {
    const text = c.displayText || `${c.rank} of ${c.suit}`;
    return `<span class="cardchip">${text}</span>`;
  }).join('');
}

function setChip(el, kind, text) {
  el.className = `chip ${kind}`;
  el.textContent = text;
}


function updatePlayerPanelFromSnapshot(data) {
  const pTotalsEl  = document.getElementById('playerTotals');
  const pCardsEl   = document.getElementById('playerCards');
  const pStatusEl  = document.getElementById('playerStatus');
  const pFooterEl  = document.getElementById('playerFooter');

  pFooterEl.textContent = '';

  // Start payload uses `player` (array of cards); later snapshots use `players` (array of hands)
  const hands = Array.isArray(data.players) && data.players.length
    ? data.players.map((ph, i) => ({ ...ph, idx: i }))
    : (data.player ? [{ cards: data.player, idx: 0 }] : []);

  if (!hands.length) {
    pTotalsEl.textContent = '‚Äî';
    pCardsEl.innerHTML = '';
    setChip(pStatusEl, 'play', 'Ready');
    return;
  }

  // Build per-hand lines (supporting split)
  const lines = [];
  const cardRows = [];
  const activeIdx = (typeof data.activeIndex === 'number') ? data.activeIndex : 0;

  for (const h of hands) {
    const { total, soft, isBJ } = bjScore(h.cards || []);
    const idx = (hands.length > 1) ? `<span class="idx">${h.idx+1}.</span>` : '';
    const softStr = soft ? `<span class="softflag">(soft)</span>` : '';
    lines.push(`<div class="handline ${h.idx === activeIdx && !data.settled ? 'activeHand':''}">
      ${idx}<div>Total: <strong>${total}</strong> ${softStr}</div>
    </div>`);
    cardRows.push(`<div class="handline">${idx}<div>${renderCardChips(h.cards||[])}</div></div>`);

    // Set a simple status based on result when settled
    if (data.settled && h.result) {
      const map = { win:'win', bj:'bj', push:'push', loss:'loss', bust:'loss' };
      setChip(pStatusEl, map[h.result] || 'play', h.result.toUpperCase());
    } else {
      setChip(pStatusEl, isBJ ? 'bj' : 'play', isBJ ? 'BLACKJACK' : (data.settled ? 'Done' : 'Your move'));
    }
  }

  pTotalsEl.innerHTML = lines.join('');
  pCardsEl.innerHTML  = cardRows.join('');

  // If server returned credits/points on the final settle, echo a tiny footer
  if (data.settled && (Number.isFinite(data.credit) || Number.isFinite(data.points))) {
    const kibl = Math.floor((Number(data.credit)||0)/100);
    const pts  = Number.isFinite(data.points) ? Number(data.points) : null;
    pFooterEl.textContent = `${kibl ? `+${kibl} KIBL` : ''}${kibl && pts ? ' ¬∑ ' : ''}${(pts||pts===0) ? `+${pts} pts` : ''}`;
  }
}

function updateDealerPanelFromSnapshot(data) {
  const dTotalsEl  = document.getElementById('dealerTotals');
  const dCardsEl   = document.getElementById('dealerCards');
  const dStatusEl  = document.getElementById('dealerStatus');
  const dFooterEl  = document.getElementById('dealerFooter');

  if (!data.dealer) {
    dTotalsEl.textContent = '‚Äî';
    dCardsEl.innerHTML = '';
    setChip(dStatusEl, 'play', 'Waiting');
    dFooterEl.textContent = '';
    return;
  }

  if (data.settled && Array.isArray(data.dealer.full)) {
    const { total, soft, isBJ } = bjScore(data.dealer.full);
    const softStr = soft ? ' (soft)' : '';
    dTotalsEl.innerHTML = `Total: <strong>${total}</strong>${softStr}`;
    dCardsEl.innerHTML  = renderCardChips(data.dealer.full);
    setChip(dStatusEl, isBJ ? 'bj' : 'play', isBJ ? 'BLACKJACK' : 'Revealed');
    dFooterEl.textContent = '';
  } else {
    // Not settled yet ‚Äî show upcard only
    const up = data.dealer.up ? [data.dealer.up] : [];
    dTotalsEl.textContent = 'Upcard shown';
    dCardsEl.innerHTML    = renderCardChips(up);
    setChip(dStatusEl, 'play', 'In play');
    dFooterEl.textContent = 'Dealer total hidden until settle';
  }
}

// Call this anywhere you already handle a BJ JSON response (start/hit/stand/double/split)
function updateBjPanels(snapshotJson) {
  try {
    updatePlayerPanelFromSnapshot(snapshotJson || {});
    updateDealerPanelFromSnapshot(snapshotJson || {});
  } catch (_) {}
}

   const API = Object.freeze({
  profile:'/api/profile',
  daily:'/api/daily-reward',
  payout:'/api/payout',
  bj: { start:'/api/bj/start', hit:'/api/bj/hit', stand:'/api/bj/stand', double:'/api/bj/double', split:'/api/bj/split' }
});
  window.KIBL_TOKEN_ID_HEX = "656bfefce8a0885acba5c809c5afcfbfa62589417d84d54108e6bb42a6f30000";


    const payoutEl = document.getElementById('payoutTotal');
    const dailyBtn = document.getElementById('dailyReward');
    const loading  = document.getElementById('loading');

    const bjFair   = document.getElementById('bjFair');
    const bjDealer = document.getElementById('bjDealer');
    const bjPlayer = document.getElementById('bjPlayer');
      const btnStart  = document.getElementById('bjStart');
  const btnHit    = document.getElementById('bjHit');
  const btnStand  = document.getElementById('bjStand');
  const btnDouble = document.getElementById('bjDoubleBtn');
  const btnSplit  = document.getElementById('bjSplitBtn');
  const bjMsg = document.getElementById('bjStatus');
const leaderboardList = document.getElementById('leaderboardList');

  function applyBJCan(can = {}) {
  btnHit.disabled    = !(can.hit ?? true);
  btnStand.disabled  = !(can.stand ?? true);
  btnDouble.disabled = !(can.double ?? false);

  // Split: show only when server says it‚Äôs allowed AND enable the button
  const allowSplit = !!(can.split);
  btnSplit.disabled = !allowSplit;
  btnSplit.classList.toggle('hidden', !allowSplit);
}


    let totalPayout = 0;
     function formatWait(ms) {
  if (!Number.isFinite(ms) || ms <= 0) return 'a bit';
  const m = Math.ceil(ms / 60000);
  return `${m} minute${m !== 1 ? 's' : ''}`;
}
const sleep = (ms) => new Promise(r => setTimeout(r, ms));
const REVEAL_EXTRA_MS = 600 ; 
const setDisabled = (el, v) => { if (el) el.disabled = !!v; };

  function afterActionSnapshot(d){
  const dealer = d.dealer.full ? d.dealer : d.dealer;
  renderHands({ dealer, player:d.players });
fitBjToScreen();
  const status = document.getElementById('bjStatus');
  if (status){
    if (d.settled){
      const res = Array.isArray(d.results) && d.results[0]?.result;
      status.textContent = res === 'bj' ? 'Blackjack!' :
                           res === 'win' ? 'Win' :
                           res === 'push' ? 'Push' :
                           (res === 'bust' || res === 'loss') ? 'Loss' : 'Hand settled';
    } else {
      status.textContent = 'Your move';
    }
  }

  // keep the side panels in sync
  updateBjPanels(d);

  if (d.settled){
    applyBJCan({ hit:false, stand:false, double:false, split:false });
    announceAndRefresh(d);

      btnStart.disabled = false;
    bjMsg.textContent = 'Round settled. Press Feed the dealer for a new round.';
  } else {
    applyBJCan({ hit:true, stand:true, double:false, split:false });
    btnStart.disabled = true;
  }
}
    function setButtons({ deal, hit, stand }) {
    const btnStart = document.getElementById('bjStart');
    const btnHit   = document.getElementById('bjHit');
    const btnStand = document.getElementById('bjStand');
    if (btnStart && deal  !== undefined) btnStart.disabled = !deal;
    if (btnHit   && hit   !== undefined) btnHit.disabled   = !hit;
    if (btnStand && stand !== undefined) btnStand.disabled = !stand;
  }
function toast(html, { type = 'info', timeout = 2500 } = {}) {
    let root = document.getElementById('toasts');
    if (!root) {
      root = document.createElement('div');
      root.id = 'toasts';
      document.body.appendChild(root);
    }
    const el = document.createElement('div');
    el.className = `toast ${type}`;
    el.setAttribute('role', 'status');
    el.setAttribute('aria-live', 'polite');
    el.innerHTML = `<span class="close" aria-label="Dismiss">√ó</span>${html}`;
    root.appendChild(el);

    // enter
    requestAnimationFrame(() => el.classList.add('show'));

    // auto-dismiss
    const remove = () => {
      el.classList.remove('show');
      el.classList.add('hide');
      el.addEventListener('transitionend', () => el.remove(), { once: true });
    };
    const t = setTimeout(remove, timeout);

    // click to dismiss immediately
    el.querySelector('.close').addEventListener('click', () => {
      clearTimeout(t);
      remove();
    });

    // light haptic on mobile (best-effort)
    if (navigator.vibrate) { navigator.vibrate(20); }
  }

  function announceAndRefresh(d){
  const creditUnits  = Math.floor((d.credit || 0) / 100);
  const balanceUnits = Math.floor((d.sessionBalance || 0) / 100);

  if (d.bonuses?.length) {
    const lines = d.bonuses
      .map(b => `‚Ä¢ ${Math.floor((b.amount || 0) / 100)} KIBL ‚Äî ${b.name}`)
      .join('<br>');
    toast(`<strong>Bonuses unlocked</strong><br>${lines}`, { type: 'bonus', timeout: 2500 });
  }
  if (creditUnits > 0) {
    toast(`You won <strong>${creditUnits}</strong> KIBL!`, { type: 'win', timeout: 2500 });
      
    // Sound: restart and play (user gesture already happened)
    const sfx = document.getElementById('feedSound');
    if (sfx) { try { sfx.currentTime = 0; sfx.volume = 0.6; sfx.play().catch(()=>{}); } catch(_){} }
  flashPayout();

  // üéâ optional quick confetti burst (comment out if you prefer)
  confettiBurst();
    // Haptic (best-effort on mobile)
    if (navigator.vibrate) { navigator.vibrate([10, 40, 10]); }

    // Pulse the payout readout
    payoutEl.classList.add('payout-pulse');
    setTimeout(() => payoutEl.classList.remove('payout-pulse'), 1900);
  }

  payoutEl.textContent = `Total Payout: ${balanceUnits} KIBL`;
  totalPayout = balanceUnits;
  // Always refresh profile + leaderboard so numbers are current
  loadProfile();
  loadLeaderboard();
}
  async function loadProfile(){
  try{
    const r = await fetch(API.profile, { credentials:'include' });
    const d = await r.json(); if (!d.ok) return;

    const bankUnits = Math.floor((d.bank||0)/100);
    totalPayout = bankUnits;
    payoutEl.textContent = `Total Payout: ${bankUnits} KIBL`;
      // NEW: show player tag
  const tagEl = document.getElementById('userTag');
  if (tagEl && d.displayId) tagEl.textContent = `Your tag: ${d.displayId}`;
    const ach = d.stats?.blackjack?.achievements || {};
    const list = Object.entries(ach).filter(([,v])=>v).map(([k])=>k.replace(/([A-Z])/g,' $1').trim());
    const el = document.getElementById('bjAchievements');
    if (el) el.textContent = list.length ? `Achievements: ${list.join(', ')}` : 'Achievements: ‚Äî';
  }catch{}
}
    
    function cardEl(card, faceDown=false){
      const div = document.createElement('div'); div.className='card';
      const img = document.createElement('img');
      img.src = faceDown ? 'cards/card-back.png' : `cards/${card.filename}?v=xmas`;
      img.alt = faceDown ? 'Hidden card' : card.displayText;
      div.appendChild(img);
      return div;
    }
async function loadLeaderboard(){
  try{
    const res = await fetch('/api/leaderboard/window?game=blackjack&k=3', { credentials:'include' });
    const d = await res.json(); if (!d.ok) return;

    const list = document.getElementById('leaderboardList');
    if (!list) return;
    list.innerHTML = '';

    d.window.forEach(row => {
      const li = document.createElement('li');
      li.innerHTML = `
        <span class="who">${row.rank}. <span class="user">${row.user}${row.you ? ' (you)' : ''}</span></span>
        <span class="pts">${row.points}</span>`;
      if (row.you) li.classList.add('you');
      list.appendChild(li);
    });

    let hint = document.getElementById('lbHint');
    if (!hint) {
      hint = document.createElement('div');
      hint.id = 'lbHint';
      hint.className = 'readout';
      list.parentNode.appendChild(hint);
    }
    hint.textContent = (d.you && d.you.deltaAhead != null)
      ? `Only ${d.you.deltaAhead} pts to the next rank.`
      : '';
  } catch(e){ console.warn('blackjack window LB failed', e); }
}
 function renderHands({ dealer, player }){
  bjDealer.innerHTML = '';
  if (dealer.full){
    dealer.full.forEach(c => bjDealer.appendChild(cardEl(c, false)));
  } else {
    bjDealer.appendChild(cardEl(dealer.up, false));
    bjDealer.appendChild(cardEl(dealer.holeHidden ? dealer.up : dealer.up, dealer.holeHidden));
  }
fitBjToScreen();
  bjPlayer.innerHTML = '';
  (player || []).forEach(h => {
    const row = document.createElement('div');
    row.className = 'hand-row';
    (h.cards || []).forEach(c => row.appendChild(cardEl(c, false)));
    bjPlayer.appendChild(row);
  });
}


    async function startRound(){
  try{
    const d = await postWithCsrf(API.bj.start, {});   // already JSON
    if (!d.ok) throw new Error(d.error || 'Start failed');

    if (d.fair?.commit && d.fair?.handId){
      bjFair.textContent = `Commit: ${d.fair.commit.slice(0,10)}‚Ä¶ (hand ${d.fair.handId.slice(0,8)})`;
    }

    // If server dealt a natural BJ and settled immediately, just snapshot it.
    if (d.settled) {
      afterActionSnapshot(d);
      return;
    }

    // Normal start payload: dealer upcard + player‚Äôs two cards in d.player
    renderHands({ dealer: d.dealer, player: [{ cards: d.player }] });
    updateBjPanels(d);

    btnStart.disabled = true;
    btnHit.disabled = btnStand.disabled = false;
    bjMsg.textContent = 'Your move.';
    applyBJCan(d.can || {});
  } catch(e){
    alert(`Start failed: ${e.message || e}`);
  }
}
  
    async function hit(){ 
  try{
    const d = await postWithCsrf(API.bj.hit, {});
    if (!d.ok) throw new Error(d.error || 'Hit failed');
    afterActionSnapshot(d);
    if (d.settled) bjMsg.textContent = 'Round settled. Press Feed the dealer for a new round.';
  } catch(e){
    alert(`Hit failed: ${e.message || e}`);
  }
}

async function stand(){
  try{
    setButtons({ hit:false, stand:false });
    const d = await postWithCsrf(API.bj.stand, {});
    if (!d.ok) throw new Error(d.error || 'Stand failed');

    afterActionSnapshot(d);
    if (d.fair?.serverSeed) {
      bjFair.textContent = `Reveal: seed=${d.fair.serverSeed.slice(0,12)}‚Ä¶ ‚Ä¢ verify: /api/fair/${d.fair.handId}`;
    }
    await sleep(600);
  } catch(e){
    toast(`Stand failed: ${e.message || e}`, { type:'error' });
    setButtons({ deal:true, hit:false, stand:false });
  }
}

async function doubleDown(){
  try{
    const d = await postWithCsrf(API.bj.double, {});
    if (!d.ok) throw new Error(d.error || 'Double failed');
    afterActionSnapshot(d);
  } catch(e){
    alert(`Double failed: ${e.message || e}`);
  }
}

async function split(){
  try{
    const d = await postWithCsrf(API.bj.split, {});
    if (!d.ok) throw new Error(d.error || 'Split failed');
    afterActionSnapshot(d);
  } catch(e){
    alert(`Split failed: ${e.message || e}`);
  }
}

    // ‚Äî‚Äî‚Äî Daily & Payout (copied minimal from poker page) ‚Äî‚Äî‚Äî
    async function onDaily(){
     try {
        // FIX 1: Pass empty body {}, not fetch options
        // FIX 2: Result is already JSON, don't call .json()
        const data = await postWithCsrf(API.daily, {}); 

        if (!data.ok){
          if (data.error === 'Daily reward already claimed.') {
              const mins = data.retryInMs ? Math.ceil(data.retryInMs/60000) : 'later';
              alert('Daily already claimed. Try again in ~' + mins + ' minutes.');
          } else {
              alert('Daily Reward Failed: ' + (data.error || 'Unknown error'));
          }
          return;
        }

        // SUCCESS
        const creditUnits = Math.floor((data.credit || 0) / 100);
        alert(`Daily Reward Sent! \n\n+${creditUnits} KIBL have been sent directly to your linked wallet.\nTxID: ${data.txId?.slice(0,10)}...`);

        // Refresh balance
        if (window.loadWalletBalances) {
            const linked = await fetch('/api/wallet/status').then(r=>r.json()).catch(()=>({}));
            if (linked?.address) window.loadWalletBalances(linked.address);
        }

      } catch (e) {
        console.error(e);
        alert('Failed to claim daily reward, please try again.');
      }
    }

async function onClaimPayout() {
    if (totalPayout === 0) {
        // Double-check with server
        try {
          const r = await fetch(API.profile, { credentials: 'include' });
          const d = await r.json();
          if (d?.ok) {
            const bankUnits = Math.floor((d.bank || 0) / 100);
            totalPayout = bankUnits;
            if (payoutEl) payoutEl.textContent = `Total Payout: ${bankUnits} KIBL`;
            if (payoutBtn) payoutBtn.disabled = (totalPayout === 0);
          }
        } catch {}
        if (totalPayout === 0) { alert('No payout to claim!'); return; }
    }

    const token = window.hcaptcha?.getResponse?.();
    if (!token) {
        document.querySelector('#payoutCaptcha iframe')?.focus();
        alert('Please complete the hCaptcha challenge first.');
        return;
    }

    try {
        show(payoutLoading);
        payoutBtn.disabled = true;

        // FIX: 'data' is returned directly from postWithCsrf
        const data = await postWithCsrf(API.payout, {
            playerAddress: addressInput?.value?.trim() || '', // Ensure address is passed if needed, or server uses linked
            'h-captcha-response': token
        });

        // Removed: const data = await resp.json()... (Not needed)

        if (!data.ok || data.error) {
            try { window.hcaptcha?.reset?.(); } catch {}
            alert('Payout failed: ' + (data.error || 'Unknown error'));
            return;
        }

        try { feedSound.currentTime = 0; feedSound.play(); } catch {}
        alert(`Payout successful! Tx ID: ${data.txId}`);

        totalPayout = data.remainingKIBL ?? 0;
        payoutEl.textContent = `Total Payout: ${totalPayout} KIBL`;
        try { window.hcaptcha?.reset?.(); } catch {}

    } catch (e) {
        console.error('Payout failed:', e);
        try { window.hcaptcha?.reset?.(); } catch {}
        alert(e?.message || 'Payout failed. Try again.');
    } finally {
        hide(payoutLoading);
        if (totalPayout > 0) payoutBtn.disabled = false;
    }
}

    // Wire up
    btnStart.addEventListener('click', startRound);
    btnHit.addEventListener('click',   hit);
    btnStand.addEventListener('click', stand);
    dailyBtn.addEventListener('click', onDaily);
    btnDouble.addEventListener('click', doubleDown);
    btnSplit .addEventListener('click', split);


    // bootstrap
    (async ()=>{
      try{ await fetchCsrf(); await loadProfile(); await loadLeaderboard(); }
      catch{ alert('Could not initialize security token. Refresh to try again.'); }
    })();
    // Dismissible "How to play" with memory
(function(){
  const KEY = 'kk_bj_help_hidden';
  const el  = document.getElementById('bjHow');
  if (!el) return;
  if (localStorage.getItem(KEY) === '1') el.hidden = true;
  el.querySelector('.close')?.addEventListener('click', () => {
    el.hidden = true; localStorage.setItem(KEY, '1');
  });
})();
// One-time, shared with poker: 'kk_age_ok' === '1' skips gate on both pages
(function(){
  const KEY = 'kk_age_ok';
  const gate = document.getElementById('ageGate');
  if (!gate) return;

  if (localStorage.getItem(KEY) === '1') { gate.hidden = true; return; }

  gate.hidden = false;
  const yes = document.getElementById('ageYes');
  const no  = document.getElementById('ageNo');

  // Prevent background scroll and set initial focus
  const prevOverflow = document.body.style.overflow;
  document.body.style.overflow = 'hidden';
  yes?.focus();

  const enter = () => {
    localStorage.setItem(KEY, '1');
    gate.hidden = true;
    document.body.style.overflow = prevOverflow || '';
  };

  yes?.addEventListener('click', enter);

  // Simple focus trap
  const focusables = gate.querySelectorAll('button, [href], [tabindex]:not([tabindex="-1"])');
  gate.addEventListener('keydown', (e)=>{
    if (e.key !== 'Tab' || focusables.length === 0) return;
    const first = focusables[0], last = focusables[focusables.length - 1];
    if (e.shiftKey && document.activeElement === first){ last.focus(); e.preventDefault(); }
    else if (!e.shiftKey && document.activeElement === last){ first.focus(); e.preventDefault(); }
  });
})();


  </script>
 <script type="module">
  // --- 1. GLOBAL ERROR TRAP ---
  window.onerror = function(msg, url, line, col, error) {
    if (String(msg).includes('ResizeObserver')) return;
    console.error("Global Error:", msg);
  };

  // --- 2. STATE ---
  const state = {
    csrf: null,
    linked: null,
    localWallet: false
  };

  // --- 3. LIGHTWEIGHT API ---
  async function apiCall(endpoint, body = null) {
    const headers = {};
    if (body) {
      headers['Content-Type'] = 'application/json';
      if (state.csrf) headers['x-csrf-token'] = state.csrf;
    }
    const opts = { credentials: 'include', headers };
    if (body) {
      opts.method = 'POST';
      opts.body = JSON.stringify(body);
    }
    const url = `${endpoint}${endpoint.includes('?') ? '&' : '?'}_t=${Date.now()}`;
    const r = await fetch(url, opts);
    return r.json();
  }

  // --- 4. INIT ---
  async function init() {
    console.log("Booting BJ UI...");
    
    // A. CSRF
    try {
      const r = await fetch('/api/csrf', { credentials: 'include' });
      const d = await r.json();
      state.csrf = d.csrfToken;
      window.csrfToken = d.csrfToken; 
    } catch (e) { console.error("CSRF Fail", e); }

    // B. Link Status
    try {
      const d = await apiCall('/api/wallet/status');
      state.linked = (d && d.ok && d.linked) ? d : null;
    } catch (e) { console.error("Status Fail", e); }

    // C. Local Storage
    state.localWallet = !!localStorage.getItem('kk_wallet_v1');

    // D. UI Update
    updateUI();
    
    // E. Setup Result Observer (Unique to Blackjack)
    setupObserver();
  }

  function updateUI() {
    const navConnect = document.getElementById('navConnect');
    const betBtn     = document.getElementById('betBtn');
    const depositBtn = document.getElementById('depositBtn');
    const oldStart   = document.getElementById('bjStart');

    // Hide legacy start button if present
    if (oldStart) oldStart.style.display = 'none';

    // 1. Navigation Button
    if (navConnect) {
      if (state.linked) {
        navConnect.style.display = 'none'; 
      } else if (state.localWallet) {
        navConnect.style.display = 'inline-flex';
        navConnect.textContent = 'üîì Unlock Wallet';
        navConnect.className = 'btn btn-primary';
        navConnect.onclick = (e) => { e.preventDefault(); doUnlock(); };
      } else {
        navConnect.style.display = 'inline-flex';
        navConnect.textContent = 'Connect Wallet';
        navConnect.href = '/connect.html';
      }
    }

    // 2. Bet Button
    if (betBtn) {
      const newBtn = betBtn.cloneNode(true);
      betBtn.parentNode.replaceChild(newBtn, betBtn);

      if (state.linked) {
        newBtn.textContent = 'Place 100 KIBL Bet';
        newBtn.disabled = false;
        newBtn.onclick = doBet; 
        
        if (depositBtn) {
            depositBtn.style.display = 'inline-flex';
            depositBtn.onclick = () => {
                navigator.clipboard.writeText(state.linked.address);
                alert("Address copied: " + state.linked.address);
            }
        }
        
        if (window.loadWalletBalances) window.loadWalletBalances(state.linked.address);

      } else if (state.localWallet) {
        newBtn.textContent = 'Unlock to Play';
        newBtn.disabled = false;
        newBtn.onclick = doUnlock;
      } else {
        newBtn.textContent = 'Connect Wallet to Play';
        newBtn.disabled = false;
        newBtn.onclick = () => window.location.href = '/connect.html';
      }
    }
  }

  // --- 5. HEAVY ACTIONS (Lazy Load) ---

  async function doUnlock() {
    const btn = document.getElementById('navConnect');
    if (btn) btn.textContent = 'Loading...';

    try {
      const { loadWallet } = await import("/assets/walletBet.bundle.js?v=4");
      const { getSigner } = await import("/assets/wallet-modal.js?v=Christmasv22cachedupdate");

      const pass = await getSigner();
      if (!pass) {
          if(btn) btn.textContent = 'üîì Unlock Wallet';
          return;
      }

      if(btn) btn.textContent = 'Decrypting...';
      const session = await loadWallet(pass);
      
      if(btn) btn.textContent = 'Linking...';
      await apiCall('/api/wallet/link', { address: session.address, network: 'mainnet' });

      alert("Wallet Reconnected!");
      window.location.reload();

    } catch (e) {
      alert("Unlock Error: " + e.message);
      if(btn) btn.textContent = 'üîì Unlock Wallet';
    }
  }

  async function doBet() {
    const btn = document.getElementById('betBtn');
    if (!btn) return;

    try {
      btn.disabled = true;
      btn.classList.add('busy');
      btn.textContent = 'Loading Wallet...';

      const { placeBet } = await import("/assets/walletBet.bundle.js?v=4");
      const { getSigner } = await import("/assets/wallet-modal.js?v=Christmasv22cachedupdate");

      btn.textContent = 'Authorizing...';
      const passphrase = await getSigner();
      if (!passphrase) throw new Error("Cancelled");

      btn.textContent = 'Signing...';
      const { txId } = await placeBet({
          passphrase,
          kiblAmount: 10000, 
          tokenIdHex: window.KIBL_TOKEN_ID_HEX,
          feeNexa: 600
      });

      if (window.toast) toast(`Bet sent!`, { type: 'win' });
      
      // Hand over to game logic
      btn.style.display = 'none';
      
      // Blackjack specific start function
      if (window.startRound) await window.startRound();
      
      if (window.loadProfile) window.loadProfile();
      if (state.linked) window.loadWalletBalances?.(state.linked.address);

    } catch (e) {
      const msg = e.message || String(e);
      if (msg !== 'Cancelled' && !msg.includes('User rejected')) {
         alert("Bet Error: " + msg);
      }
      btn.style.display = 'inline-flex';
      btn.textContent = 'Place 100 KIBL Bet';
      btn.disabled = false;
    } finally {
      btn.classList.remove('busy');
    }
  }

  // --- 6. BLACKJACK OBSERVER ---
  function setupObserver() {
    const statusMsg = document.getElementById('bjStatus');
    if (!statusMsg) return;

    const obs = new MutationObserver(() => {
        const text = statusMsg.textContent || "";
        // Check for Game Over keywords
        if (text.includes('settled') || text.includes('Win') || text.includes('Loss') || text.includes('Blackjack') || text.includes('Push')) {
            
            // Delay to let user see result
            setTimeout(() => {
                const betBtn = document.getElementById('betBtn');
                if (betBtn && betBtn.style.display === 'none') {
                    betBtn.style.display = 'inline-flex';
                    betBtn.disabled = false;
                    betBtn.textContent = 'Place 100 KIBL Bet';
                    betBtn.classList.remove('busy');
                    
                    if (state.linked && window.loadWalletBalances) window.loadWalletBalances(state.linked.address);
                }
            }, 1000);
        }
    });
    
    obs.observe(statusMsg, { childList: true, subtree: true, characterData: true });
  }

  // --- 7. BOOTSTRAP ---
  if (document.readyState === 'loading') {
    addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
</script>
<script type="module">
  import { initOnboarding } from './assets/onboarding.js';
  // Initialize for "Blackjack" mode
  document.addEventListener('DOMContentLoaded', () => initOnboarding('blackjack'));
</script>
  <footer class="readout" style="text-align:center; opacity:.9; padding:14px 0 6px;">
    ¬© 2025 KIBL / PixelPup ‚Ä¢ Stay shiny üê∂‚ú® ‚Ä¢
    <a href="tos.html">Terms</a> ‚Ä¢ <a href="privacy.html">Privacy</a> ‚Ä¢ <a href="disclaimer.html">Disclaimer</a>
  </footer>
</body>
</html>
